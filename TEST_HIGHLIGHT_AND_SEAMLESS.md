# ğŸ§ª æµ‹è¯•æŒ‡å—ï¼šé«˜äº® + æ— ç¼æ’­æ”¾

## ğŸ¯ ä¸¤å¤§æ”¹è¿›

### 1. âœ… æ–‡æœ¬é«˜äº®ï¼ˆç´«è‰²ï¼‰
- å½“å‰æ’­æ”¾çš„å¥å­ä¼šæœ‰ç´«è‰²èƒŒæ™¯é«˜äº®
- é«˜äº®éšæ’­æ”¾ç§»åŠ¨

### 2. âœ… æ— ç¼æ’­æ”¾ï¼ˆæ— åœé¡¿ï¼‰
- å¥å­ä¹‹é—´ä¸å†æœ‰åœé¡¿
- é¢„åŠ è½½æœºåˆ¶ï¼šæå‰åŠ è½½2å¥
- å®Œå…¨å¯¹é½ Aloud ä½“éªŒ

---

## ğŸš€ ç«‹å³æµ‹è¯•

### æ­¥éª¤ 1ï¼šé‡å¯ Obsidian
```
æŒ‰ Ctrl + R
ç­‰å¾…æ’ä»¶é‡æ–°åŠ è½½...
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºæµ‹è¯•æ–‡æœ¬
åœ¨ä»»ä½•ç¬”è®°ä¸­è¾“å…¥ï¼š
```
This is sentence one. This is sentence two. This is sentence three. This is sentence four. This is sentence five.
```

### æ­¥éª¤ 3ï¼šå¼€å§‹æ’­æ”¾
1. é€‰ä¸­æ•´æ®µæ–‡å­—
2. æŒ‰ `Ctrl + Space` æˆ–ç‚¹å‡»å·¥å…·æ çš„æ’­æ”¾æŒ‰é’®

### æ­¥éª¤ 4ï¼šè§‚å¯Ÿæ§åˆ¶å°
æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š

#### åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—ï¼š
```
[TTSManager] Created 5 chunks
[TTSManager] Chunk: This is sentence one. (0-22)
[TTSManager] Chunk: This is sentence two. (23-46)
...

[TTS Toolbar] ğŸ¯ highlightCurrentChunk called, currentChunk: 0
[TTS Toolbar] ğŸ“ Highlight offsets: 0 - 22 text: This is sentence one.
[TTS Toolbar] âœ¨ Applying highlight...

[TTS Highlight] ğŸ”† highlightRange called, from: 0 to: 22
[TTS Highlight] ğŸ“¤ Dispatching setHighlight effect...
[TTS Highlight] âœ… Highlight effect dispatched!

[TTS Toolbar] âœ… Successfully highlighted chunk: 1/5 (0-22)

[TTS] ğŸ¯ Using preloaded audio for chunk 1  â† æ— ç¼æ’­æ”¾ï¼
[TTS] âœ… Preloaded chunk 2
[TTS] âœ… Preloaded chunk 3
```

---

## ğŸ” éªŒè¯æ¸…å•

### é«˜äº®åŠŸèƒ½
- [ ] ç¬¬1å¥æ’­æ”¾æ—¶ï¼Œèƒ½çœ‹åˆ°ç´«è‰²é«˜äº®
- [ ] ç¬¬2å¥å¼€å§‹æ—¶ï¼Œé«˜äº®ç§»åŠ¨åˆ°ç¬¬2å¥
- [ ] ç¬¬3å¥å¼€å§‹æ—¶ï¼Œé«˜äº®ç§»åŠ¨åˆ°ç¬¬3å¥
- [ ] æ’­æ”¾ç»“æŸåï¼Œé«˜äº®æ¶ˆå¤±
- [ ] æŒ‰ `Esc` åœæ­¢æ—¶ï¼Œé«˜äº®ç«‹å³æ¶ˆå¤±

### æ— ç¼æ’­æ”¾
- [ ] ç¬¬1å¥æ’­æ”¾å®Œåï¼Œ**ç«‹å³**æ’­æ”¾ç¬¬2å¥ï¼ˆæ— åœé¡¿ï¼‰
- [ ] ç¬¬2å¥æ’­æ”¾å®Œåï¼Œ**ç«‹å³**æ’­æ”¾ç¬¬3å¥ï¼ˆæ— åœé¡¿ï¼‰
- [ ] æ§åˆ¶å°æ˜¾ç¤º"Using preloaded audio"
- [ ] æ§åˆ¶å°æ˜¾ç¤º"Preloaded chunk X"

### å¯¹æ¯” Aloud
- [ ] æ’­æ”¾æµç•…åº¦ä¸ Aloud ä¸€è‡´
- [ ] é«˜äº®æ•ˆæœä¸ Aloud ç±»ä¼¼ï¼ˆç´«è‰²èƒŒæ™¯ï¼‰
- [ ] æ²¡æœ‰å¥å­ä¹‹é—´çš„åœé¡¿

---

## âŒ å¦‚æœé«˜äº®ä¸æ˜¾ç¤º

### è°ƒè¯•æ­¥éª¤

#### 1. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
```
é—®é¢˜ Aï¼šæ²¡æœ‰çœ‹åˆ°ä»»ä½• [TTS Highlight] æ—¥å¿—
â†’ é«˜äº®å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨
â†’ æ£€æŸ¥ onChunkChange æ˜¯å¦è§¦å‘

é—®é¢˜ Bï¼šçœ‹åˆ° "âŒ Cannot highlight - invalid state"
â†’ chunks æ•°ç»„ä¸ºç©ºæˆ–ç´¢å¼•æ— æ•ˆ
â†’ æ£€æŸ¥ chunkText æ˜¯å¦æ­£ç¡®

é—®é¢˜ Cï¼šçœ‹åˆ° "Offsets out of range"
â†’ åç§»é‡è¶…å‡ºæ–‡æ¡£é•¿åº¦
â†’ æ£€æŸ¥åç§»é‡è®¡ç®—é€»è¾‘
```

#### 2. æ‰‹åŠ¨æµ‹è¯•åç§»é‡
åœ¨æ§åˆ¶å°è¾“å…¥ï¼š
```javascript
// è·å–å½“å‰ç¼–è¾‘å™¨
const view = app.workspace.activeLeaf.view.editor.cm;

// æµ‹è¯•é«˜äº®
view.dispatch({
    effects: view.state.field(
        StateEffect.define().of({ from: 0, to: 10 })
    )
});
```

#### 3. æ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½
```javascript
// æ£€æŸ¥ CodeMirror æ‰©å±•
console.log(app.workspace.activeLeaf.view.editor.cm.state.facet(EditorView.decorations));
```

---

## âŒ å¦‚æœæ’­æ”¾ä»æœ‰åœé¡¿

### å¯èƒ½åŸå› 

#### 1. ç¼“å­˜æœªå‘½ä¸­
```
[TTS] âŒ Cache MISS  â† æ¯æ¬¡éƒ½è¦ä» API è·å–
â†’ è§£å†³ï¼šç¬¬ä¸€æ¬¡æ’­æ”¾ä¼šæœ‰åœé¡¿ï¼Œç¬¬äºŒæ¬¡åº”è¯¥æ— åœé¡¿
```

#### 2. é¢„åŠ è½½å¤±è´¥
```
[TTS] Failed to preload chunk X  â† é¢„åŠ è½½å¤±è´¥
â†’ è§£å†³ï¼šæ£€æŸ¥ API é€Ÿç‡é™åˆ¶æˆ–ç½‘ç»œ
```

#### 3. ç­‰å¾… state change
```
await this.playCurrentChunk();  â† æœ‰ await
â†’ è¿™æ˜¯é”™è¯¯çš„ï¼åº”è¯¥æ˜¯ï¼š
this.playCurrentChunk();  â† æ—  awaitï¼Œç«‹å³è¿”å›
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¹‹å‰ï¼ˆæœ‰åœé¡¿ï¼‰
```
å¥å­1: 2ç§’æ’­æ”¾
[åœé¡¿ 0.5-1ç§’] â† API è¯·æ±‚ + åŠ è½½
å¥å­2: 2ç§’æ’­æ”¾
[åœé¡¿ 0.5-1ç§’]
å¥å­3: 2ç§’æ’­æ”¾
```
**æ€»æ—¶é—´**: ~9ç§’ï¼ˆ5å¥è¯ï¼‰

### ç°åœ¨ï¼ˆæ— åœé¡¿ï¼‰
```
å¥å­1: 2ç§’æ’­æ”¾
[é¢„åŠ è½½å¥å­2ã€3] â† åå°è¿›è¡Œ
å¥å­2: 2ç§’æ’­æ”¾ â† ä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘
å¥å­3: 2ç§’æ’­æ”¾ â† ä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘
å¥å­4: 2ç§’æ’­æ”¾
å¥å­5: 2ç§’æ’­æ”¾
```
**æ€»æ—¶é—´**: ~10ç§’ï¼ˆ5å¥è¯ï¼‰- ä½†ä½“éªŒæµç•…ï¼

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. é¢„åŠ è½½æœºåˆ¶
```typescript
private async preloadNextChunks(): Promise<void> {
    const PRELOAD_COUNT = 2; // æå‰åŠ è½½2å¥
    
    for (let i = 1; i <= PRELOAD_COUNT; i++) {
        const nextIndex = this.currentChunkIndex + i;
        if (nextIndex < this.chunks.length) {
            // åå°åŠ è½½ï¼Œä¸é˜»å¡
            this.fetchAudio(chunk.text).then(buffer => {
                this.preloadedAudio.set(nextIndex, buffer);
            });
        }
    }
}
```

### 2. ä½¿ç”¨é¢„åŠ è½½éŸ³é¢‘
```typescript
// ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½çš„éŸ³é¢‘
let audioBuffer = this.preloadedAudio.get(this.currentChunkIndex);
if (audioBuffer) {
    console.log('ğŸ¯ Using preloaded audio'); // æ— å»¶è¿Ÿï¼
} else {
    audioBuffer = await this.fetchAudio(chunk.text); // æœ‰å»¶è¿Ÿ
}
```

### 3. ç«‹å³æ’­æ”¾ä¸‹ä¸€å¥
```typescript
// âŒ é”™è¯¯ï¼ˆæœ‰åœé¡¿ï¼‰
await this.playCurrentChunk();

// âœ… æ­£ç¡®ï¼ˆæ— åœé¡¿ï¼‰
this.playCurrentChunk(); // Fire and forget
```

---

## ğŸ¨ é«˜äº®æ ·å¼

### CSS ç±»
```css
.tts-highlight-current {
    background-color: rgba(168, 85, 247, 0.3);  /* ç´«è‰² */
    border-radius: 2px;
}
```

### è§†è§‰æ•ˆæœ
```
æ™®é€šæ–‡æœ¬
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ This is sentence one.    â•‘  â† ç´«è‰²é«˜äº®
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
æ™®é€šæ–‡æœ¬
```

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### åç§»é‡ç³»ç»Ÿï¼ˆå¯¹é½ Aloudï¼‰
```typescript
// âœ… ç°åœ¨ï¼šç›´æ¥ä½¿ç”¨æ•°å­—åç§»é‡
interface TTSChunk {
    text: string;
    start: number;  // 0
    end: number;    // 22
}

// âŒ ä¹‹å‰ï¼šä½¿ç”¨ EditorPositionï¼ˆé”™è¯¯ï¼‰
interface TTSChunk {
    text: string;
    start: {line: 0, ch: 0};
    end: {line: 0, ch: 22};
}
```

### CodeMirror è£…é¥°å™¨
```typescript
// StateField ç®¡ç†è£…é¥°å™¨çŠ¶æ€
const highlightField = StateField.define<DecorationSet>({
    create() { return Decoration.none; },
    update(decorations, tr) {
        // ç›‘å¬ setHighlight æ•ˆæœ
        for (const effect of tr.effects) {
            if (effect.is(setHighlight)) {
                // åˆ›å»ºé«˜äº®è£…é¥°å™¨
                return Decoration.set([
                    Decoration.mark({class: 'tts-highlight-current'})
                        .range(from, to)
                ]);
            }
        }
    }
});
```

---

## ğŸ‰ æˆåŠŸæ ‡å‡†

### é«˜äº® âœ…
- ç´«è‰²èƒŒæ™¯å¯è§
- éšæ’­æ”¾ç§»åŠ¨
- æ’­æ”¾ç»“æŸæ¶ˆå¤±

### æ— ç¼æ’­æ”¾ âœ…
- å¥å­é—´æ— åœé¡¿
- æ§åˆ¶å°æ˜¾ç¤ºé¢„åŠ è½½
- æµç•…å¦‚ Aloud

### æ€§èƒ½ âœ…
- ç¬¬äºŒæ¬¡æ’­æ”¾æ›´å¿«ï¼ˆç¼“å­˜ï¼‰
- é¢„åŠ è½½åœ¨åå°è¿›è¡Œ
- ä¸å½±å“æ’­æ”¾æµç•…åº¦

---

## ğŸš€ ä¸‹ä¸€æ­¥

å¦‚æœä»¥ä¸Šéƒ½æ­£å¸¸ï¼š
1. âœ… **äº«å—æ— ç¼ TTS ä½“éªŒï¼**
2. âœ… **æµ‹è¯•æ›´é•¿çš„æ–‡ç« **
3. âœ… **å°è¯•ä¸åŒçš„æ’­æ”¾é€Ÿåº¦**
4. âœ… **ä½¿ç”¨é”®ç›˜å¿«æ·é”®**

å¦‚æœæœ‰é—®é¢˜ï¼š
1. ğŸ“‹ **å¤åˆ¶æ§åˆ¶å°æ—¥å¿—**
2. ğŸ“¸ **æˆªå›¾é«˜äº®æ•ˆæœï¼ˆæˆ–æ— æ•ˆæœï¼‰**
3. ğŸ“ **æè¿°å…·ä½“ç°è±¡**

---

## ğŸ’¡ æç¤º

### æœ€ä½³å®è·µ
- ç¬¬ä¸€æ¬¡æ’­æ”¾å¯èƒ½ç•¥æ…¢ï¼ˆéœ€è¦è·å–éŸ³é¢‘ï¼‰
- ç¬¬äºŒæ¬¡æ’­æ”¾ä¼šå¾ˆå¿«ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
- é•¿æ–‡ç« æ›´èƒ½ä½“ç°æ— ç¼æ’­æ”¾çš„ä¼˜åŠ¿

### å¿«æ·é”®
- `Ctrl + Space`: æ’­æ”¾/æš‚åœ
- `Ctrl + â†’`: ä¸‹ä¸€å¥ï¼ˆçœ‹é«˜äº®è·³è½¬ï¼‰
- `Ctrl + â†`: ä¸Šä¸€å¥
- `Esc`: åœæ­¢ï¼ˆé«˜äº®æ¶ˆå¤±ï¼‰

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ ç°åœ¨æ‹¥æœ‰äº†æ¯” Aloud æ›´å¥½çš„ TTS ä½“éªŒï¼** ğŸŠ
