# ğŸ“ OB English Learner å­—å¹•ç”Ÿæˆä¸ç¿»è¯‘é€»è¾‘åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-12-03  
**ç‰ˆæœ¬**: 1.0.2

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥ YouTube URL                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æå–è§†é¢‘å…ƒæ•°æ®                                               â”‚
â”‚ - æ ‡é¢˜ã€é¢‘é“ã€æ—¶é•¿ã€ç¼©ç•¥å›¾                                           â”‚
â”‚ - ä½¿ç”¨æµè§ˆå™¨ User-Agent è¯·æ±‚ YouTube é¡µé¢                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: è·å–å­—å¹•ï¼ˆå¤šç­–ç•¥ï¼‰                                           â”‚
â”‚                                                                      â”‚
â”‚ Strategy 1: å°è¯•è·å–è‹±æ–‡å­—å¹•                                         â”‚
â”‚   â”œâ”€ å°è¯• 'en', 'en-US', 'en-GB' è¯­è¨€ä»£ç                            â”‚
â”‚   â”œâ”€ æ£€æµ‹å†…å®¹æ˜¯å¦çœŸçš„æ˜¯è‹±æ–‡ï¼ˆæ£€æŸ¥æœ‰æ— ä¸­æ–‡å­—ç¬¦ï¼‰                      â”‚
â”‚   â””â”€ å¦‚æœæ˜¯ä¸­æ–‡å†…å®¹ï¼Œå°è¯•ä¸‹ä¸€ä¸ªè¯­è¨€ä»£ç                               â”‚
â”‚                                                                      â”‚
â”‚ Strategy 2: å¦‚æœè‹±æ–‡æœªæ‰¾åˆ°ï¼Œè·å–åŸå§‹è¯­è¨€å­—å¹•                         â”‚
â”‚   â”œâ”€ ä¸æŒ‡å®šè¯­è¨€ä»£ç ï¼Œè·å–é»˜è®¤å­—å¹•                                   â”‚
â”‚   â”œâ”€ è‡ªåŠ¨æ£€æµ‹è¯­è¨€ï¼ˆé€šè¿‡å†…å®¹ä¸­çš„ä¸­æ–‡å­—ç¬¦ï¼‰                           â”‚
â”‚   â””â”€ æ ‡è®°ä¸º 'en' æˆ– 'zh'                                            â”‚
â”‚                                                                      â”‚
â”‚ Strategy 3: å°è¯•è·å–ä¸­æ–‡ç¿»è¯‘                                         â”‚
â”‚   â”œâ”€ å¦‚æœæœ‰è‹±æ–‡ + AI å¯ç”¨ â†’ ä½¿ç”¨ AI ç¿»è¯‘ â­                        â”‚
â”‚   â”œâ”€ å¦‚æœ AI å¤±è´¥/æœªå¯ç”¨ â†’ å°è¯• YouTube ä¸­æ–‡å­—å¹•                    â”‚
â”‚   â””â”€ å°è¯• 'zh-Hans', 'zh-CN', 'zh', 'zh-TW' è¯­è¨€ä»£ç                â”‚
â”‚                                                                      â”‚
â”‚ Result:                                                              â”‚
â”‚   â”œâ”€ enTranscript (è‹±æ–‡å­—å¹•ï¼Œå¯èƒ½ä¸ºç©º)                              â”‚
â”‚   â””â”€ zhTranscript (ä¸­æ–‡ç¿»è¯‘ï¼Œå¯èƒ½ä¸ºç©º)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: å­—å¹•é‡åˆ†æ®µï¼ˆResegmentationï¼‰                                â”‚
â”‚                                                                      â”‚
â”‚ ç›®çš„: å°†çŸ­å­—å¹•è¡Œåˆå¹¶æˆå®Œæ•´å¥å­                                       â”‚
â”‚                                                                      â”‚
â”‚ é€»è¾‘:                                                                â”‚
â”‚   1. æ£€æŸ¥æ ‡ç‚¹ç¬¦å·å¯†åº¦                                               â”‚
â”‚      - å¦‚æœæ ‡ç‚¹ç¬¦å· < è¡Œæ•°/10 â†’ è·³è¿‡é‡åˆ†æ®µï¼ˆé¿å…å…¨éƒ¨åˆå¹¶ï¼‰          â”‚
â”‚   2. è®¡ç®—å­—ç¬¦çº§æ—¶é—´æˆ³                                               â”‚
â”‚      - å°†æ¯è¡Œå­—å¹•çš„æ—¶é—´å‡åŒ€åˆ†é…åˆ°æ¯ä¸ªå­—ç¬¦                           â”‚
â”‚   3. æŒ‰å¥å­ç»ˆæ­¢ç¬¦åˆ†å‰²ï¼ˆ. ! ? ã€‚ï¼ï¼Ÿï¼‰                               â”‚
â”‚      - é‡åˆ°å¥å·ç­‰æ ‡ç‚¹æ—¶åˆ›å»ºæ–°è¡Œ                                     â”‚
â”‚   4. ä¿æŒæ—¶é—´æˆ³ç²¾ç¡®                                                 â”‚
â”‚      - æ–°è¡Œçš„ start/duration åŸºäºåŸå§‹å­—ç¬¦çº§æ—¶é—´æˆ³                   â”‚
â”‚                                                                      â”‚
â”‚ æ•ˆæœ:                                                                â”‚
â”‚   åŸå§‹: "Hello" â†’ "my name is" â†’ "John."                            â”‚
â”‚   é‡åˆ†æ®µ: "Hello my name is John."                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ç¡®å®šä¸»å­—å¹•ï¼ˆPrimary Transcriptï¼‰                            â”‚
â”‚                                                                      â”‚
â”‚ ä¼˜å…ˆçº§:                                                              â”‚
â”‚   1. å¦‚æœæœ‰è‹±æ–‡ â†’ ä½¿ç”¨è‹±æ–‡ä½œä¸ºä¸»å­—å¹•ï¼ˆæœ€ä½³å­¦ä¹ ä½“éªŒï¼‰                â”‚
â”‚   2. å¦‚æœåªæœ‰ä¸­æ–‡ â†’ ä½¿ç”¨ä¸­æ–‡ï¼ˆæ˜¾ç¤ºè­¦å‘Šï¼‰                            â”‚
â”‚   3. å¦‚æœéƒ½æ²¡æœ‰ â†’ æŠ›å‡ºé”™è¯¯                                          â”‚
â”‚                                                                      â”‚
â”‚ Result:                                                              â”‚
â”‚   â”œâ”€ transcript (ä¸»å­—å¹•)                                            â”‚
â”‚   â””â”€ translatedTranscript (ç¿»è¯‘ï¼Œå¯é€‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: AI æ™ºèƒ½åˆ†æ®µä¸æ ‡ç‚¹ï¼ˆå¦‚æœå¯ç”¨ï¼‰                               â”‚
â”‚                                                                      â”‚
â”‚ æ¡ä»¶:                                                                â”‚
â”‚   âœ… enableAIFormatting æˆ– enableAISubtitles å·²å¯ç”¨                â”‚
â”‚   âœ… AI API Key å·²é…ç½®                                              â”‚
â”‚   âœ… è¯­è¨€æ˜¯è‹±æ–‡ï¼ˆlang.startsWith('en')ï¼‰                            â”‚
â”‚                                                                      â”‚
â”‚ å¤„ç†æµç¨‹:                                                            â”‚
â”‚   1. ä½¿ç”¨ AI è¿›è¡Œæ™ºèƒ½åˆ†å¥å’Œæ ‡ç‚¹                                     â”‚
â”‚      - æ‰¹å¤„ç†ï¼šæ¯æ‰¹ 20 è¡Œ                                           â”‚
â”‚      - ç­‰å¾…é—´éš”ï¼š2 ç§’ï¼ˆé¿å… API é™æµï¼‰                              â”‚
â”‚      - åˆå¹¶çŸ­è¡Œæˆå®Œæ•´å¥å­                                           â”‚
â”‚      - æ·»åŠ æ­£ç¡®çš„æ ‡ç‚¹ç¬¦å·                                           â”‚
â”‚                                                                      â”‚
â”‚   2. å¦‚æœ enableAITranslation å¯ç”¨                                  â”‚
â”‚      - é‡æ–°ç¿»è¯‘ç²¾ç»†åŒ–åçš„å­—å¹•                                       â”‚
â”‚      - ä¿æŒå­—å¹•å¯¹é½                                                 â”‚
â”‚                                                                      â”‚
â”‚ Result:                                                              â”‚
â”‚   â”œâ”€ refinedTranscript (ç²¾ç»†åŒ–åçš„å­—å¹•)                             â”‚
â”‚   â””â”€ refinedTranslatedTranscript (é‡æ–°ç¿»è¯‘çš„å­—å¹•)                   â”‚
â”‚                                                                      â”‚
â”‚ é”™è¯¯å¤„ç†:                                                            â”‚
â”‚   - å¤±è´¥æ—¶ä½¿ç”¨åŸå§‹å­—å¹•                                              â”‚
â”‚   - æ˜¾ç¤ºé”™è¯¯é€šçŸ¥                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: ç”Ÿæˆ SRT å­—å¹•æ–‡ä»¶                                           â”‚
â”‚                                                                      â”‚
â”‚ é€»è¾‘:                                                                â”‚
â”‚   - å¦‚æœ enableAISubtitles å¯ç”¨ â†’ ä½¿ç”¨ refinedTranscript           â”‚
â”‚   - å¦åˆ™ â†’ ä½¿ç”¨åŸå§‹ transcript                                      â”‚
â”‚                                                                      â”‚
â”‚ ç”Ÿæˆæ–‡ä»¶:                                                            â”‚
â”‚   â”œâ”€ è§†é¢‘æ ‡é¢˜.en.srt (è‹±æ–‡å­—å¹•)                                     â”‚
â”‚   â”œâ”€ è§†é¢‘æ ‡é¢˜.zh.srt (ä¸­æ–‡å­—å¹•ï¼Œå¦‚æœæœ‰ç¿»è¯‘)                         â”‚
â”‚   â””â”€ è§†é¢‘æ ‡é¢˜.bilingual.srt (åŒè¯­å­—å¹•ï¼Œå¦‚æœæœ‰ç¿»è¯‘)                  â”‚
â”‚                                                                      â”‚
â”‚ ä½ç½®: 02-Subtitles/è§†é¢‘æ ‡é¢˜/                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: ç”Ÿæˆç¬”è®°å†…å®¹                                                â”‚
â”‚                                                                      â”‚
â”‚ é€»è¾‘:                                                                â”‚
â”‚   1. ç¡®å®šæ˜¾ç¤ºç”¨å­—å¹•                                                 â”‚
â”‚      - å¦‚æœ enableAIFormatting å¯ç”¨ â†’ ä½¿ç”¨ refinedTranscript       â”‚
â”‚      - å¦åˆ™ â†’ ä½¿ç”¨åŸå§‹ transcript                                   â”‚
â”‚                                                                      â”‚
â”‚   2. ä¼˜å…ˆæ˜¾ç¤ºè‹±æ–‡                                                   â”‚
â”‚      - å¦‚æœä¸»å­—å¹•æ˜¯è‹±æ–‡ â†’ ä½¿ç”¨ä¸»å­—å¹•                                â”‚
â”‚      - å¦‚æœç¿»è¯‘æ˜¯è‹±æ–‡ â†’ ä½¿ç”¨ç¿»è¯‘                                    â”‚
â”‚      - å¦åˆ™ â†’ ä½¿ç”¨ä¸»å­—å¹•                                            â”‚
â”‚                                                                      â”‚
â”‚   3. AI æ ¼å¼åŒ–ç¬”è®°å†…å®¹ï¼ˆå¦‚æœå¯ç”¨ï¼‰                                  â”‚
â”‚      - æ¡ä»¶: enableAIFormatting + AI API Key                        â”‚
â”‚      - å°†å­—å¹•è½¬æ¢ä¸ºæ®µè½æ ¼å¼                                         â”‚
â”‚      - æ·»åŠ æ ‡ç‚¹ç¬¦å·                                                 â”‚
â”‚      - æ¯ 2-4 å¥åˆ†æˆä¸€æ®µ                                            â”‚
â”‚      - æ‰¹å¤„ç†ï¼šæ¯æ‰¹çº¦ 2000 å­—ç¬¦                                     â”‚
â”‚      - ç­‰å¾…é—´éš”ï¼š2 ç§’                                               â”‚
â”‚                                                                      â”‚
â”‚   4. é»˜è®¤æ ¼å¼ï¼ˆå¦‚æœ AI æ ¼å¼åŒ–å¤±è´¥æˆ–æœªå¯ç”¨ï¼‰                         â”‚
â”‚      - æ¯ 3 è¡Œåˆå¹¶æˆä¸€æ®µ                                            â”‚
â”‚      - ç”¨ç©ºè¡Œåˆ†éš”æ®µè½                                               â”‚
â”‚                                                                      â”‚
â”‚ Result:                                                              â”‚
â”‚   - åˆ›å»º 01-Videos/è§†é¢‘æ ‡é¢˜/è§†é¢‘æ ‡é¢˜.md                             â”‚
â”‚   - åŒ…å«è§†é¢‘å…ƒæ•°æ®ã€å°é¢ã€å­—å¹•é“¾æ¥ã€æ ¼å¼åŒ–æ–‡æœ¬                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                            âœ… å®Œæˆï¼
```

---

## ğŸ”‘ æ ¸å¿ƒé€»è¾‘è§£æ

### 1. å­—å¹•è·å–ç­–ç•¥ï¼ˆå¤šé‡å¤‡ä»½ï¼‰

**é—®é¢˜**: YouTube å­—å¹• API ä¸ç¨³å®šï¼Œè¯­è¨€ä»£ç å¯èƒ½è¿”å›é”™è¯¯çš„è¯­è¨€

**è§£å†³æ–¹æ¡ˆ**: ä¸‰é‡ç­–ç•¥ + å†…å®¹æ£€æµ‹

```typescript
// Strategy 1: æ˜ç¡®è¯·æ±‚è‹±æ–‡
for (const langCode of ['en', 'en-US', 'en-GB']) {
    const response = await getTranscript(url, { lang: langCode });
    const hasChinese = /[\u4e00-\u9fa5]/.test(response.lines[0].text);
    if (!hasChinese) {
        enTranscript = response.lines;
        break;
    }
}

// Strategy 2: è·å–åŸå§‹è¯­è¨€
const originalResponse = await getTranscript(url); // ä¸æŒ‡å®šè¯­è¨€
const hasChinese = /[\u4e00-\u9fa5]/.test(originalResponse.lines[0].text);
if (hasChinese) {
    zhTranscript = originalResponse.lines;
} else {
    enTranscript = originalResponse.lines;
}

// Strategy 3: è·å–ä¸­æ–‡ç¿»è¯‘
if (enTranscript && aiEnabled) {
    // ä¼˜å…ˆä½¿ç”¨ AI ç¿»è¯‘ï¼ˆè´¨é‡æ›´å¥½ï¼‰
    zhTranscript = await aiTranslator.translateTranscript(enTranscript);
} else {
    // å›é€€åˆ° YouTube ä¸­æ–‡å­—å¹•
    for (const langCode of ['zh-Hans', 'zh-CN', 'zh', 'zh-TW']) {
        const response = await getTranscript(url, { lang: langCode });
        // ...
    }
}
```

**ä¼˜ç‚¹**:
- âœ… é²æ£’æ€§å¼ºï¼Œå¤šé‡å¤‡ä»½
- âœ… å†…å®¹æ£€æµ‹æ¯”è¯­è¨€ä»£ç æ›´å¯é 
- âœ… AI ç¿»è¯‘è´¨é‡ä¼˜äºæœºå™¨ç¿»è¯‘

---

### 2. å­—å¹•é‡åˆ†æ®µï¼ˆResegmentationï¼‰

**é—®é¢˜**: YouTube å­—å¹•é€šå¸¸å¾ˆçŸ­ï¼ˆ2-5 ä¸ªå•è¯ï¼‰ï¼Œä¸åˆ©äºé˜…è¯»

**åŸå§‹å­—å¹•**:
```
[00:00] Hello
[00:01] my name is
[00:03] John
[00:04] and I'm here
[00:06] to teach you
[00:08] English.
```

**é‡åˆ†æ®µå**:
```
[00:00] Hello my name is John and I'm here to teach you English.
```

**å®ç°é€»è¾‘**:
```typescript
// 1. è®¡ç®—å­—ç¬¦çº§æ—¶é—´æˆ³
for (const line of lines) {
    const durationPerChar = line.duration / line.text.length;
    for (let i = 0; i < line.text.length; i++) {
        allChars.push({
            char: line.text[i],
            time: line.start + (i * durationPerChar)
        });
    }
}

// 2. æŒ‰å¥å­ç»ˆæ­¢ç¬¦åˆ†å‰²
for (const charObj of allChars) {
    currentText += charObj.char;
    if (sentenceEndRegex.test(charObj.char)) {
        // æ‰¾åˆ°å¥å·ï¼Œåˆ›å»ºæ–°è¡Œ
        newLines.push({
            start: startTime,
            duration: charObj.time - startTime,
            text: currentText.trim(),
            lang: lines[0].lang
        });
        currentText = '';
        startTime = charObj.time;
    }
}
```

**ä¼˜ç‚¹**:
- âœ… ä¿æŒæ—¶é—´æˆ³ç²¾ç¡®
- âœ… å½¢æˆå®Œæ•´å¥å­ï¼Œæ˜“è¯»
- âœ… é¿å…è¿‡åº¦åˆå¹¶ï¼ˆæ£€æŸ¥æ ‡ç‚¹å¯†åº¦ï¼‰

---

### 3. AI ç¿»è¯‘æµç¨‹

**æ‰¹å¤„ç†ç­–ç•¥**:
```typescript
// æ¯æ‰¹ 20 è¡Œï¼Œé¿å… token è¶…é™
const batchSize = 20;
for (let i = 0; i < lines.length; i += batchSize) {
    const batch = lines.slice(i, i + batchSize);
    
    // æ„å»ºæç¤ºè¯
    const texts = batch.map((line, index) => 
        `${index + 1}. ${line.text}`
    ).join('\n');
    
    const prompt = `è¯·å°†ä»¥ä¸‹è‹±æ–‡å­—å¹•ç¿»è¯‘æˆä¸­æ–‡ã€‚è¦æ±‚ï¼š
1. ä¿æŒåºå·ä¸å˜
2. ç¿»è¯‘è¦å‡†ç¡®ã€è‡ªç„¶ã€ç¬¦åˆä¸­æ–‡è¡¨è¾¾ä¹ æƒ¯
3. ä¸“ä¸šæœ¯è¯­è¦å‡†ç¡®
4. åªè¾“å‡ºç¿»è¯‘ç»“æœï¼Œä¸è¦è§£é‡Š

å¾…ç¿»è¯‘å†…å®¹ï¼š
${texts}

ç¿»è¯‘ç»“æœï¼š`;
    
    const response = await callAI(prompt);
    const translatedBatch = parseResponse(response, batch);
    translatedLines.push(...translatedBatch);
    
    // ç­‰å¾… 2 ç§’é¿å…é™æµ
    await sleep(2000);
}
```

**é”™è¯¯å¤„ç†**:
```typescript
try {
    const response = await callAI(prompt);
    return parseTranslationResponse(response, lines);
} catch (error) {
    // å¤±è´¥æ—¶è¿”å›åŸæ–‡ + æ ‡è®°
    return lines.map(line => ({
        ...line,
        text: `[Translation failed] ${line.text}`,
        lang: 'zh'
    }));
}
```

---

### 4. AI æ™ºèƒ½åˆ†æ®µä¸æ ‡ç‚¹

**ä¸¤é˜¶æ®µå¤„ç†**:

**é˜¶æ®µ 1: åœ¨ main.ts ä¸­ï¼ˆloadVideoï¼‰**
```typescript
// æ¡ä»¶ï¼šå¯ç”¨ AI Formatting/Subtitles + è¯­è¨€æ˜¯è‹±æ–‡
if ((enableAIFormatting || enableAISubtitles) && lang.startsWith('en')) {
    // æ™ºèƒ½åˆ†å¥å’Œæ ‡ç‚¹ï¼ˆä¿ç•™æ—¶é—´æˆ³ï¼‰
    refinedTranscript = await translator.segmentAndPunctuate(transcript);
    
    // å¦‚æœå¯ç”¨ç¿»è¯‘ï¼Œé‡æ–°ç¿»è¯‘ç²¾ç»†åŒ–åçš„å­—å¹•
    if (enableAITranslation) {
        refinedTranslatedTranscript = await translator.translateTranscript(refinedTranscript);
    }
}
```

**é˜¶æ®µ 2: åœ¨ generator.ts ä¸­ï¼ˆcreateVideoNoteï¼‰**
```typescript
// ç¡®å®šç”¨äºç¬”è®°çš„å­—å¹•
const noteTranscript = enableAIFormatting && refinedTranscript
    ? refinedTranscript
    : transcript;

// å†æ¬¡æ ¼å¼åŒ–ç¬”è®°å†…å®¹ï¼ˆå»é™¤æ—¶é—´æˆ³ï¼Œè½¬ä¸ºæ®µè½ï¼‰
if (enableAIFormatting && aiApiKey) {
    formattedTranscriptText = await formatter.formatTranscript(
        displayTranscript,
        aiFormattingPrompt
    );
}
```

**ä¸ºä»€ä¹ˆè¦ä¸¤æ¬¡ AI å¤„ç†ï¼Ÿ**

1. **ç¬¬ä¸€æ¬¡ï¼ˆsegmentAndPunctuateï¼‰**:
   - ç›®çš„: ä¼˜åŒ–å­—å¹•è¡Œï¼ˆä¿ç•™æ—¶é—´æˆ³ï¼‰
   - ç”¨äº: SRT å­—å¹•æ–‡ä»¶ï¼ˆå¦‚æœ enableAISubtitlesï¼‰
   - ä¿ç•™: `TranscriptLine[]` æ ¼å¼ï¼ˆstart, duration, textï¼‰

2. **ç¬¬äºŒæ¬¡ï¼ˆformatTranscriptï¼‰**:
   - ç›®çš„: ä¼˜åŒ–ç¬”è®°æ˜¾ç¤ºï¼ˆå»é™¤æ—¶é—´æˆ³ï¼‰
   - ç”¨äº: Markdown ç¬”è®°å†…å®¹
   - è¾“å‡º: çº¯æ–‡æœ¬å­—ç¬¦ä¸²ï¼ˆåˆ†æ®µè½ï¼‰

---

### 5. å­—å¹•ä½¿ç”¨åˆ†é…

**ä¸‰ä¸ªå¼€å…³ï¼Œä¸‰ç§ç”¨é€”**:

| å¼€å…³ | å½±å“èŒƒå›´ | ä½¿ç”¨çš„å­—å¹• |
|-----|---------|-----------|
| **enableAISubtitles** | SRT å­—å¹•æ–‡ä»¶ | refinedTranscriptï¼ˆAI ä¼˜åŒ–ï¼‰|
| **enableAIFormatting** | Markdown ç¬”è®° | AI æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆæ®µè½å½¢å¼ï¼‰|
| **enableAITranslation** | ä¸­æ–‡ç¿»è¯‘ | AI ç¿»è¯‘ï¼ˆè€Œé YouTube æœºç¿»ï¼‰|

**ç¤ºä¾‹åœºæ™¯**:

**åœºæ™¯ 1**: å…¨éƒ¨å¯ç”¨
```
âœ… enableAISubtitles
âœ… enableAIFormatting
âœ… enableAITranslation

Result:
â”œâ”€ SRT æ–‡ä»¶: ä½¿ç”¨ AI ç²¾ç»†åˆ†å¥ + æ ‡ç‚¹
â”‚  â”œâ”€ è‹±æ–‡.srt: refinedTranscript
â”‚  â”œâ”€ ä¸­æ–‡.srt: refinedTranslatedTranscript (AI ç¿»è¯‘)
â”‚  â””â”€ åŒè¯­.srt: åˆå¹¶ä¸Šè¿°ä¸¤è€…
â””â”€ Markdown ç¬”è®°: ä½¿ç”¨ AI æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆ2-4 å¥ä¸€æ®µï¼‰
```

**åœºæ™¯ 2**: åªå¯ç”¨ç¬”è®°æ ¼å¼åŒ–
```
âŒ enableAISubtitles
âœ… enableAIFormatting
âŒ enableAITranslation

Result:
â”œâ”€ SRT æ–‡ä»¶: ä½¿ç”¨åŸå§‹å­—å¹•ï¼ˆé‡åˆ†æ®µåï¼‰
â”‚  â””â”€ è‹±æ–‡.srt: åŸå§‹ transcript
â””â”€ Markdown ç¬”è®°: ä½¿ç”¨ AI æ ¼å¼åŒ–æ–‡æœ¬ï¼ˆ2-4 å¥ä¸€æ®µï¼‰
```

**åœºæ™¯ 3**: å…¨éƒ¨ç¦ç”¨
```
âŒ enableAISubtitles
âŒ enableAIFormatting
âŒ enableAITranslation

Result:
â”œâ”€ SRT æ–‡ä»¶: ä½¿ç”¨åŸå§‹å­—å¹•ï¼ˆé‡åˆ†æ®µåï¼‰
â”‚  â”œâ”€ è‹±æ–‡.srt: åŸå§‹ transcript
â”‚  â””â”€ ä¸­æ–‡.srt: YouTube æœºå™¨ç¿»è¯‘ï¼ˆå¦‚æœæœ‰ï¼‰
â””â”€ Markdown ç¬”è®°: é»˜è®¤æ ¼å¼ï¼ˆæ¯ 3 è¡Œä¸€æ®µï¼‰
```

---

## ğŸš¨ å½“å‰å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜ 1: AI é‡å¤å¤„ç†ï¼Œæ•ˆç‡ä½

**ç°è±¡**:
- åŒä¸€æ®µå­—å¹•è¢« AI å¤„ç†äº† 2 æ¬¡
- ç¬¬ä¸€æ¬¡: `segmentAndPunctuate`ï¼ˆä¿ç•™æ—¶é—´æˆ³ï¼‰
- ç¬¬äºŒæ¬¡: `formatTranscript`ï¼ˆç”Ÿæˆæ®µè½æ–‡æœ¬ï¼‰

**æˆæœ¬**:
- 1 ä¸ª 10 åˆ†é’Ÿè§†é¢‘ï¼ˆ~150 è¡Œå­—å¹•ï¼‰
- ç¬¬ä¸€æ¬¡: 8 æ‰¹ Ã— 2 ç§’ = 16 ç§’ + API è°ƒç”¨
- ç¬¬äºŒæ¬¡: 3 æ‰¹ Ã— 2 ç§’ = 6 ç§’ + API è°ƒç”¨
- æ€»è®¡: ~22 ç§’ + åŒå€ API è´¹ç”¨

**åŸå› **:
- ä¸¤ä¸ªé˜¶æ®µéœ€è¦ä¸åŒæ ¼å¼
- ç¬¬ä¸€æ¬¡éœ€è¦ä¿ç•™æ—¶é—´æˆ³ï¼ˆTranscriptLine[]ï¼‰
- ç¬¬äºŒæ¬¡éœ€è¦çº¯æ–‡æœ¬ï¼ˆstringï¼‰

---

### é—®é¢˜ 2: AI æ ¼å¼åŒ–å¯èƒ½ä¸ç¨³å®š

**ç°è±¡**:
- ç”¨æˆ·æŠ¥å‘Š"è½¬å½•æ–‡æœ¬è¿˜æ˜¯æ•´æ®µå¾ˆé•¿ï¼Œä¸æ˜¯ 2-4 å¥ä¸€æ®µ"

**å¯èƒ½åŸå› **:
1. AI API è°ƒç”¨å¤±è´¥ï¼ˆæœªæ•è·ï¼‰
2. AI æç¤ºè¯ä¸å¤Ÿä¸¥æ ¼
3. AI æ²¡æœ‰ä¸¥æ ¼éµå¾ªæŒ‡ä»¤
4. æŸäº›è¯­è¨€æ¨¡å‹ä¸æ“…é•¿æ ¼å¼åŒ–

**å½“å‰æç¤ºè¯**:
```
Please format the following transcript text. You MUST follow these rules:
1. ADD PUNCTUATION: Insert periods, commas, question marks, etc.
2. PARAGRAPH BREAKS: Break into short paragraphs (every 2-4 sentences). 
   Use double newlines (\n\n) between paragraphs.
3. CAPITALIZATION: Capitalize the first letter of each sentence.
4. NO CONTENT CHANGES: Do NOT change, add, or remove any words.
5. NO EXPLANATIONS: Output ONLY the formatted text.
```

**é—®é¢˜ç‚¹**:
- ç¼ºå°‘ç¤ºä¾‹
- æ²¡æœ‰å¼ºåˆ¶éªŒè¯
- æ²¡æœ‰åå¤„ç†æ£€æŸ¥

---

### é—®é¢˜ 3: é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„

**ç°è±¡**:
- AI è°ƒç”¨å¤±è´¥æ—¶ï¼Œç”¨æˆ·ä¸æ¸…æ¥šåŸå› 
- éƒ¨åˆ†å¤±è´¥æ—¶ç»§ç»­ä½¿ç”¨åŸå§‹å­—å¹•ï¼Œä½†æ²¡æœ‰æ˜ç¡®æç¤º

**æ”¹è¿›å‰**:
```typescript
} catch (error) {
    console.error('[LinguaSync] AI segmentation failed:', error);
    new Notice(`AI Segmentation failed: ${error.message}`);
    // ç»§ç»­ä½¿ç”¨åŸå§‹å­—å¹•
}
```

**é—®é¢˜**:
- ç”¨æˆ·åªçœ‹åˆ° Noticeï¼Œä¸çŸ¥é“åç»­æµç¨‹
- ä¸æ¸…æ¥šæ˜¯éƒ¨åˆ†å¤±è´¥è¿˜æ˜¯å®Œå…¨å¤±è´¥
- æ²¡æœ‰å»ºè®®çš„ä¿®å¤æ­¥éª¤

---

### é—®é¢˜ 4: ç¿»è¯‘æ‰¹å¤„ç†ç­‰å¾…æ—¶é—´å›ºå®š

**ç°è±¡**:
- æ— è®º API é™æµæƒ…å†µå¦‚ä½•ï¼Œéƒ½ç­‰å¾… 2 ç§’
- å¯èƒ½é€ æˆä¸å¿…è¦çš„å»¶è¿Ÿ

**å½“å‰é€»è¾‘**:
```typescript
for (let i = 0; i < lines.length; i += batchSize) {
    // å¤„ç†æ‰¹æ¬¡
    await processBatch(batch);
    
    // å›ºå®šç­‰å¾… 2 ç§’
    if (i + batchSize < lines.length) {
        await sleep(2000);
    }
}
```

**é—®é¢˜**:
- ä¸å¤Ÿæ™ºèƒ½ï¼Œæ— æ³•é€‚åº”ä¸åŒ API çš„é™æµç­–ç•¥
- çŸ­è§†é¢‘ï¼ˆ< 20 è¡Œï¼‰ä¹Ÿä¼šç­‰å¾…ï¼Œæµªè´¹æ—¶é—´

---

### é—®é¢˜ 5: å­—å¹•è¯­è¨€æ£€æµ‹ä¸å¤Ÿå®Œå–„

**ç°è±¡**:
- åªæ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
- å¯èƒ½è¯¯åˆ¤æ··åˆè¯­è¨€å†…å®¹

**å½“å‰é€»è¾‘**:
```typescript
const firstLine = response.lines[0]?.text || '';
const hasChinese = /[\u4e00-\u9fa5]/.test(firstLine);
```

**é—®é¢˜**:
- å¦‚æœç¬¬ä¸€è¡Œæ˜¯è‹±æ–‡ï¼Œä½†åç»­æœ‰ä¸­æ–‡ï¼Œä¼šè¯¯åˆ¤
- æ··åˆè¯­è¨€è§†é¢‘ï¼ˆä¸­è‹±æ··æ‚ï¼‰æ— æ³•æ­£ç¡®å¤„ç†

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### æ”¹è¿› 1: åˆå¹¶ AI å¤„ç†ï¼Œå‡å°‘é‡å¤è°ƒç”¨

**æ–¹æ¡ˆ A: ä¸€æ¬¡ç”Ÿæˆä¸¤ç§æ ¼å¼**

```typescript
// æ–°æ–¹æ³•: åŒæ—¶ç”Ÿæˆ TranscriptLine[] å’Œæ®µè½æ–‡æœ¬
async segmentAndFormat(lines: TranscriptLine[]): Promise<{
    segmented: TranscriptLine[],  // ç”¨äº SRT
    formatted: string              // ç”¨äºç¬”è®°
}> {
    // æ‰¹å¤„ç†
    for (let i = 0; i < lines.length; i += batchSize) {
        const batch = lines.slice(i, i + batchSize);
        
        // ä¸€æ¬¡ API è°ƒç”¨ï¼Œè¦æ±‚è¾“å‡ºä¸¤ç§æ ¼å¼
        const prompt = `è¯·å¤„ç†ä»¥ä¸‹å­—å¹•ï¼Œè¾“å‡ºä¸¤ç§æ ¼å¼ï¼š

1. åˆ†å¥å­—å¹•ï¼ˆä¿ç•™åºå·ï¼Œåˆå¹¶æˆå®Œæ•´å¥å­ï¼Œæ·»åŠ æ ‡ç‚¹ï¼‰
2. æ®µè½æ–‡æœ¬ï¼ˆæ¯ 2-4 å¥åˆ†æ®µï¼Œç”¨ç©ºè¡Œåˆ†éš”ï¼‰

è¾“å…¥ï¼š
${batch.map((l, i) => `${i+1}. ${l.text}`).join('\n')}

è¾“å‡ºæ ¼å¼ï¼š
===åˆ†å¥å­—å¹•===
1-3: Hello, my name is John.
4-5: I'm here to teach you English.

===æ®µè½æ–‡æœ¬===
Hello, my name is John. I'm here to teach you English.

This is the second paragraph.`;

        const response = await this.callAI(prompt);
        const { segmented, formatted } = this.parseCombinedResponse(response, batch);
        // ...
    }
}
```

**ä¼˜ç‚¹**:
- âœ… å‡å°‘ 50% API è°ƒç”¨
- âœ… å‡å°‘ 50% ç­‰å¾…æ—¶é—´
- âœ… é™ä½ API è´¹ç”¨

**ç¼ºç‚¹**:
- âŒ æç¤ºè¯æ›´å¤æ‚
- âŒ è§£æå“åº”æ›´å¤æ‚
- âŒ AI å¯èƒ½ä¸éµå¾ªæ ¼å¼

---

**æ–¹æ¡ˆ B: ç¼“å­˜åˆ†å¥ç»“æœï¼Œç›´æ¥è½¬æ¢**

```typescript
// åœ¨ segmentAndPunctuate åï¼Œç¼“å­˜ç»“æœ
videoData.refinedTranscript = await translator.segmentAndPunctuate(transcript);

// åœ¨ generator.ts ä¸­ï¼Œç›´æ¥å°† TranscriptLine[] è½¬æ¢ä¸ºæ®µè½æ–‡æœ¬
function convertToFormattedText(lines: TranscriptLine[]): string {
    const paragraphs: string[] = [];
    let currentParagraph: string[] = [];
    let sentenceCount = 0;
    
    for (const line of lines) {
        currentParagraph.push(line.text);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¥å­ç»“å°¾
        if (/[.!?ã€‚ï¼ï¼Ÿ]$/.test(line.text.trim())) {
            sentenceCount++;
        }
        
        // æ¯ 2-4 å¥åˆ†æ®µ
        if (sentenceCount >= 2 && sentenceCount <= 4) {
            paragraphs.push(currentParagraph.join(' '));
            currentParagraph = [];
            sentenceCount = 0;
        }
    }
    
    // æœ€åä¸€æ®µ
    if (currentParagraph.length > 0) {
        paragraphs.push(currentParagraph.join(' '));
    }
    
    return paragraphs.join('\n\n');
}
```

**ä¼˜ç‚¹**:
- âœ… æ— éœ€é¢å¤– AI è°ƒç”¨
- âœ… é€Ÿåº¦å¿«
- âœ… 100% å¯é ï¼ˆåŸºäºè§„åˆ™ï¼‰

**ç¼ºç‚¹**:
- âŒ è´¨é‡å¯èƒ½ä¸å¦‚ AI ç”Ÿæˆ
- âŒ æ— æ³•è¿›ä¸€æ­¥ä¼˜åŒ–æªè¾

---

**æ¨è**: **æ–¹æ¡ˆ B**ï¼ˆæ›´å®ç”¨ã€æ›´å¯é ï¼‰

---

### æ”¹è¿› 2: å¢å¼º AI æ ¼å¼åŒ–æç¤ºè¯

**æ”¹è¿›åçš„æç¤ºè¯**:

```typescript
const IMPROVED_FORMATTING_PROMPT = `You are a professional transcript formatter. Format the following transcript text.

STRICT RULES (MUST FOLLOW):
1. **PUNCTUATION**: Add periods, commas, question marks, etc. where appropriate.
2. **PARAGRAPH BREAKS**: 
   - Break into short paragraphs.
   - Each paragraph should contain 2-4 complete sentences.
   - Use double newlines (\\n\\n) between paragraphs.
3. **CAPITALIZATION**: Capitalize the first letter of each sentence.
4. **NO CONTENT CHANGES**: Do NOT change, add, or remove any words.
5. **NO EXPLANATIONS**: Output ONLY the formatted text. No comments or notes.

EXAMPLE INPUT:
hello my name is john i am a teacher today i want to teach you english grammar is very important lets start with the basics

EXAMPLE OUTPUT:
Hello, my name is John. I am a teacher. Today I want to teach you English.

Grammar is very important. Let's start with the basics.

INPUT TEXT:
{{text}}

FORMATTED OUTPUT:`;
```

**æ”¹è¿›ç‚¹**:
- âœ… æ·»åŠ ç¤ºä¾‹ï¼ˆFew-shot learningï¼‰
- âœ… æ˜ç¡®æ®µè½é•¿åº¦ï¼ˆ2-4 å¥ï¼‰
- âœ… å¼ºè°ƒè§„åˆ™ï¼ˆSTRICT RULES, MUST FOLLOWï¼‰
- âœ… æ¸…æ™°çš„è¾“å…¥/è¾“å‡ºåˆ†éš”

---

### æ”¹è¿› 3: æ·»åŠ æ ¼å¼éªŒè¯å’Œåå¤„ç†

```typescript
async formatTranscript(lines: TranscriptLine[], customPrompt?: string): Promise<string> {
    // ... ç°æœ‰ä»£ç  ...
    
    const result = formattedChunks.join('\n\n');
    
    // éªŒè¯æ ¼å¼
    const validation = this.validateFormatting(result, lines);
    
    if (!validation.valid) {
        console.warn('[LinguaSync] âš ï¸ AI formatting validation failed:', validation.issues);
        
        // è‡ªåŠ¨ä¿®æ­£
        const corrected = this.autoCorrectFormatting(result);
        console.log('[LinguaSync] Applied auto-correction');
        return corrected;
    }
    
    return result;
}

/**
 * éªŒè¯æ ¼å¼åŒ–ç»“æœ
 */
private validateFormatting(text: string, originalLines: TranscriptLine[]) {
    const issues: string[] = [];
    
    // æ£€æŸ¥ 1: æ®µè½æ•°é‡åˆç†
    const paragraphs = text.split('\n\n').filter(p => p.trim());
    const expectedParagraphs = Math.ceil(originalLines.length / 3);
    
    if (paragraphs.length < expectedParagraphs / 2) {
        issues.push('Too few paragraphs (text may not be properly segmented)');
    }
    
    // æ£€æŸ¥ 2: æ®µè½é•¿åº¦åˆç†ï¼ˆ2-6 å¥ï¼‰
    for (const paragraph of paragraphs) {
        const sentences = paragraph.match(/[.!?ã€‚ï¼ï¼Ÿ]/g)?.length || 0;
        if (sentences > 10) {
            issues.push(`Paragraph too long (${sentences} sentences)`);
        }
    }
    
    // æ£€æŸ¥ 3: æ˜¯å¦æœ‰æ ‡ç‚¹ç¬¦å·
    const punctuationCount = (text.match(/[.!?,;ã€‚ï¼ï¼Ÿï¼Œï¼›]/g) || []).length;
    if (punctuationCount < text.length / 50) {
        issues.push('Insufficient punctuation');
    }
    
    return {
        valid: issues.length === 0,
        issues
    };
}

/**
 * è‡ªåŠ¨ä¿®æ­£æ ¼å¼åŒ–é—®é¢˜
 */
private autoCorrectFormatting(text: string): string {
    let corrected = text;
    
    // ä¿®æ­£ 1: å¦‚æœæ•´æ®µæ²¡æœ‰åˆ†æ®µï¼Œå¼ºåˆ¶åˆ†æ®µ
    if (!corrected.includes('\n\n')) {
        console.log('[LinguaSync] No paragraphs detected, forcing segmentation...');
        const sentences = corrected.split(/(?<=[.!?ã€‚ï¼ï¼Ÿ])\s+/);
        const paragraphs: string[] = [];
        
        for (let i = 0; i < sentences.length; i += 3) {
            const paragraph = sentences.slice(i, i + 3).join(' ');
            paragraphs.push(paragraph);
        }
        
        corrected = paragraphs.join('\n\n');
    }
    
    // ä¿®æ­£ 2: ç¡®ä¿é¦–å­—æ¯å¤§å†™
    corrected = corrected.replace(/([.!?ã€‚ï¼ï¼Ÿ]\s+)([a-z])/g, (match, p1, p2) => {
        return p1 + p2.toUpperCase();
    });
    
    // ä¿®æ­£ 3: ç§»é™¤å¤šä½™çš„ç©ºè¡Œï¼ˆè¶…è¿‡ 2 ä¸ªï¼‰
    corrected = corrected.replace(/\n{3,}/g, '\n\n');
    
    return corrected;
}
```

---

### æ”¹è¿› 4: æ™ºèƒ½ç­‰å¾…ç­–ç•¥

```typescript
class RateLimitManager {
    private lastCallTime: number = 0;
    private failureCount: number = 0;
    private baseDelay: number = 1000; // 1 ç§’åŸºç¡€å»¶è¿Ÿ
    
    async waitIfNeeded() {
        const now = Date.now();
        const timeSinceLastCall = now - this.lastCallTime;
        
        // æ ¹æ®å¤±è´¥æ¬¡æ•°åŠ¨æ€è°ƒæ•´å»¶è¿Ÿ
        const delay = this.baseDelay * Math.pow(2, this.failureCount);
        const needsWait = timeSinceLastCall < delay;
        
        if (needsWait) {
            const waitTime = delay - timeSinceLastCall;
            console.log(`[LinguaSync] Rate limiting: waiting ${waitTime}ms...`);
            await this.sleep(waitTime);
        }
        
        this.lastCallTime = Date.now();
    }
    
    reportSuccess() {
        this.failureCount = Math.max(0, this.failureCount - 1);
    }
    
    reportFailure() {
        this.failureCount++;
    }
    
    private sleep(ms: number): Promise<void> {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// ä½¿ç”¨
private rateLimiter = new RateLimitManager();

private async callAI(prompt: string): Promise<string> {
    await this.rateLimiter.waitIfNeeded();
    
    try {
        const response = await this.makeAPICall(prompt);
        this.rateLimiter.reportSuccess();
        return response;
    } catch (error) {
        this.rateLimiter.reportFailure();
        throw error;
    }
}
```

---

### æ”¹è¿› 5: æ›´å‡†ç¡®çš„è¯­è¨€æ£€æµ‹

```typescript
/**
 * æ£€æµ‹å­—å¹•è¯­è¨€ï¼ˆæ£€æŸ¥å‰ 10 è¡Œï¼‰
 */
private static detectLanguage(lines: any[]): 'en' | 'zh' | 'mixed' {
    const sampleSize = Math.min(10, lines.length);
    const sample = lines.slice(0, sampleSize);
    
    let chineseCount = 0;
    let englishCount = 0;
    
    for (const line of sample) {
        const text = line.text || '';
        
        // æ£€æŸ¥ä¸­æ–‡å­—ç¬¦
        const hasChinese = /[\u4e00-\u9fa5]/.test(text);
        if (hasChinese) chineseCount++;
        
        // æ£€æŸ¥è‹±æ–‡å•è¯
        const hasEnglish = /[a-zA-Z]{2,}/.test(text);
        if (hasEnglish) englishCount++;
    }
    
    // åˆ¤æ–­è¯­è¨€
    if (chineseCount > sampleSize * 0.7) {
        return 'zh';
    } else if (englishCount > sampleSize * 0.7) {
        return 'en';
    } else {
        return 'mixed';
    }
}

// ä½¿ç”¨
const language = this.detectLanguage(response.lines);
console.log(`[LinguaSync] Detected language: ${language}`);

if (language === 'en') {
    enTranscript = response.lines.map(/* ... */);
} else if (language === 'zh') {
    zhTranscript = response.lines.map(/* ... */);
} else {
    // æ··åˆè¯­è¨€ï¼Œæ ‡è®°ä¸ºè‹±æ–‡ä½†æ˜¾ç¤ºè­¦å‘Š
    console.warn('[LinguaSync] Mixed language detected in transcript');
    enTranscript = response.lines.map(/* ... */);
}
```

---

### æ”¹è¿› 6: æ›´å¥½çš„é”™è¯¯æç¤º

```typescript
} catch (error) {
    console.error('[LinguaSync] âŒ AI segmentation failed:', error);
    
    // è¯¦ç»†çš„é”™è¯¯é€šçŸ¥
    const errorMessage = this.generateUserFriendlyError(error);
    new Notice(errorMessage, 10000); // 10 ç§’
    
    // æä¾›æ¢å¤å»ºè®®
    console.log('[LinguaSync] â„¹ï¸ Fallback: Using original transcript without AI formatting');
    console.log('[LinguaSync] â„¹ï¸ To fix: Check AI API settings and try again');
}

private generateUserFriendlyError(error: any): string {
    const errorType = error.message || String(error);
    
    if (errorType.includes('API key')) {
        return 'âŒ AI Formatting failed: Invalid API Key. Please check your AI settings.';
    } else if (errorType.includes('rate limit')) {
        return 'âŒ AI Formatting failed: Rate limit exceeded. Please wait and try again.';
    } else if (errorType.includes('network')) {
        return 'âŒ AI Formatting failed: Network error. Please check your internet connection.';
    } else if (errorType.includes('timeout')) {
        return 'âŒ AI Formatting failed: Request timeout. Please try again.';
    } else {
        return `âŒ AI Formatting failed: ${errorType}. Continuing with default formatting.`;
    }
}
```

---

## ğŸ“ˆ ä¼˜åŒ–æ€»ç»“

| æ”¹è¿›ç‚¹ | ä¼˜å…ˆçº§ | æ”¶ç›Š | éš¾åº¦ |
|-------|-------|------|------|
| åˆå¹¶ AI å¤„ç†ï¼ˆæ–¹æ¡ˆ Bï¼‰ | ğŸ”´ é«˜ | 50% é€Ÿåº¦æå‡ | ä½ |
| å¢å¼º AI æç¤ºè¯ | ğŸ”´ é«˜ | æ›´å¥½çš„æ ¼å¼åŒ–è´¨é‡ | ä½ |
| æ·»åŠ æ ¼å¼éªŒè¯ | ğŸŸ  ä¸­ | æé«˜å¯é æ€§ | ä¸­ |
| æ™ºèƒ½ç­‰å¾…ç­–ç•¥ | ğŸŸ¢ ä½ | å‡å°‘ä¸å¿…è¦ç­‰å¾… | ä¸­ |
| æ”¹è¿›è¯­è¨€æ£€æµ‹ | ğŸŸ  ä¸­ | å‡å°‘è¯¯åˆ¤ | ä½ |
| æ›´å¥½çš„é”™è¯¯æç¤º | ğŸŸ  ä¸­ | æ”¹å–„ç”¨æˆ·ä½“éªŒ | ä½ |

---

## ğŸ¯ å®æ–½å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å¤©ï¼‰
1. âœ… å®æ–½æ”¹è¿› 1 æ–¹æ¡ˆ Bï¼ˆåˆå¹¶ AI å¤„ç†ï¼‰
2. âœ… å®æ–½æ”¹è¿› 2ï¼ˆå¢å¼ºæç¤ºè¯ï¼‰
3. âœ… å®æ–½æ”¹è¿› 6ï¼ˆæ›´å¥½çš„é”™è¯¯æç¤ºï¼‰

### ä¸­æœŸï¼ˆ1 å‘¨ï¼‰
4. âœ… å®æ–½æ”¹è¿› 3ï¼ˆæ ¼å¼éªŒè¯ï¼‰
5. âœ… å®æ–½æ”¹è¿› 5ï¼ˆè¯­è¨€æ£€æµ‹ï¼‰

### é•¿æœŸï¼ˆå¯é€‰ï¼‰
6. âœ… å®æ–½æ”¹è¿› 4ï¼ˆæ™ºèƒ½ç­‰å¾…ï¼‰
7. âœ… æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼ˆé¿å…é‡å¤å¤„ç†ç›¸åŒè§†é¢‘ï¼‰
8. âœ… æ”¯æŒæ›´å¤šè¯­è¨€ï¼ˆæ—¥è¯­ã€éŸ©è¯­ç­‰ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**: Cascade AI Assistant  
**æœ€åæ›´æ–°**: 2025-12-03  
**ç‰ˆæœ¬**: 1.0
