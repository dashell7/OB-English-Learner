/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var hn=Object.create;var ce=Object.defineProperty;var mn=Object.getOwnPropertyDescriptor;var gn=Object.getOwnPropertyNames;var yn=Object.getPrototypeOf,fn=Object.prototype.hasOwnProperty;var bn=(c,t,e)=>t in c?ce(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var de=(c,t)=>()=>(c&&(t=c(c=0)),t);var U=(c,t)=>()=>(t||c((t={exports:{}}).exports,t),t.exports),Ce=(c,t)=>{for(var e in t)ce(c,e,{get:t[e],enumerable:!0})},Mt=(c,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of gn(t))!fn.call(c,s)&&s!==e&&ce(c,s,{get:()=>t[s],enumerable:!(n=mn(t,s))||n.enumerable});return c};var Ee=(c,t,e)=>(e=c!=null?hn(yn(c)):{},Mt(t||!c||!c.__esModule?ce(e,"default",{value:c,enumerable:!0}):e,c)),pe=c=>Mt(ce({},"__esModule",{value:!0}),c);var I=(c,t,e)=>(bn(c,typeof t!="symbol"?t+"":t,e),e),It=(c,t,e)=>{if(!t.has(c))throw TypeError("Cannot "+e)};var E=(c,t,e)=>(It(c,t,"read from private field"),e?e.call(c):t.get(c)),W=(c,t,e)=>{if(t.has(c))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(c):t.set(c,e)},ue=(c,t,e,n)=>(It(c,t,"write to private field"),n?n.call(c,e):t.set(c,e),e);var se,K,Bt=de(()=>{se=require("obsidian"),K=class{static extractBvId(t){if(/^BV[a-zA-Z0-9]{10}$/.test(t))return t;let e=t.match(/BV([a-zA-Z0-9]{10})/);return e?`BV${e[1]}`:null}static isBilibiliUrl(t){return t.includes("bilibili.com")||/^BV[a-zA-Z0-9]{10}$/.test(t)}static async fetchVideoData(t){var T;let e=this.extractBvId(t);if(!e)throw new Error("Invalid Bilibili URL (BV ID not found)");console.log(`[LinguaSync] Fetching Bilibili data for ${e}...`);let n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Referer:`https://www.bilibili.com/video/${e}`},s=`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,a=(await(0,se.requestUrl)({url:s})).json;if(a.code!==0)throw new Error(`Bilibili API Error: ${a.message}`);let o=a.data,r=o.title;console.log("[LinguaSync] \u{1F50D} DEBUG - Raw title from Bilibili:",r);let l=r.replace(/^["'""「]|["'""」]$/g,"").trim();console.log("[LinguaSync] \u{1F50D} DEBUG - Clean title after removing quotes:",l);let d={videoId:o.bvid,title:l,author:o.owner.name,channel:o.owner.name,duration:o.duration,thumbnailUrl:o.pic.startsWith("http")?o.pic:`https:${o.pic}`,uploadDate:new Date(o.pubdate*1e3).toISOString().split("T")[0]},u=[],g,y=((T=o.subtitle)==null?void 0:T.list)||[];if(y.length===0&&(console.log("[LinguaSync] No subtitles in view API, trying player/v2 API..."),y=await this.fetchPlayerSubtitleList(o.bvid,o.cid)),y.length===0)console.log("[LinguaSync] No subtitles found on Bilibili video.");else{console.log(`[LinguaSync] Found ${y.length} subtitles:`,y.map(x=>x.lan_doc).join(", "));let f=y.find(x=>x.lan.startsWith("en")),h=y.find(x=>x.lan.startsWith("zh")),b=f||h||y[0];b&&(console.log(`[LinguaSync] Downloading primary subtitle: ${b.lan_doc} (${b.lan})...`),u=await this.downloadSubtitle(b.subtitle_url,b.lan)),b===f&&h?(console.log(`[LinguaSync] Downloading secondary (translated) subtitle: ${h.lan_doc}...`),g=await this.downloadSubtitle(h.subtitle_url,h.lan)):b===h&&f&&(console.log(`[LinguaSync] Downloading secondary (translated) subtitle: ${f.lan_doc}...`),g=await this.downloadSubtitle(f.subtitle_url,f.lan))}return u.length===0&&(new se.Notice("\u26A0\uFE0F No subtitles found for this Bilibili video."),u.push({start:0,duration:o.duration,text:"(No subtitles available for this video)",lang:"unknown"})),d.url=t,{metadata:d,transcript:u,translatedTranscript:g}}static async fetchPlayerSubtitleList(t,e){var n,s;try{let i=`https://api.bilibili.com/x/player/v2?bvid=${t}&cid=${e}`,o=(await(0,se.requestUrl)({url:i})).json;if(o.code===0&&((s=(n=o.data)==null?void 0:n.subtitle)!=null&&s.subtitles))return o.data.subtitle.subtitles}catch(i){console.error("[LinguaSync] Failed to fetch player/v2 subtitles:",i)}return[]}static async downloadSubtitle(t,e,n){t.startsWith("//")&&(t="https:"+t);try{console.log(`[LinguaSync] \u{1F53D} Downloading subtitle from: ${t}`);let i=(await(0,se.requestUrl)({url:t,headers:n})).json;if(!i||!i.body||i.body.length===0)return console.error("[LinguaSync] \u274C Subtitle response is empty or invalid"),console.error("[LinguaSync] Response data:",JSON.stringify(i).substring(0,200)),[];let a=i.body.map(o=>({start:o.from,duration:o.to-o.from,text:o.content,lang:e}));return console.log(`[LinguaSync] \u2705 Downloaded ${a.length} subtitle lines (${e})`),a}catch(s){return console.error("[LinguaSync] \u274C Failed to download subtitle:",s.message||s),console.error("[LinguaSync] URL:",t),s.status&&console.error("[LinguaSync] HTTP Status:",s.status),[]}}}});var Ot,Rt,F,he,$t,ie,q,at=de(()=>{Ot=require("child_process"),Rt=require("util"),F=Ee(require("fs")),he=Ee(require("path")),$t=Ee(require("os")),ie=(0,Rt.promisify)(Ot.exec),q=class{static async isYtDlpInstalled(){try{return await ie("yt-dlp --version"),!0}catch(t){return!1}}static async getVersion(){try{let{stdout:t}=await ie("yt-dlp --version");return t.trim()}catch(t){return"Not installed"}}static async fetchTranscript(t,e="en"){if(console.log(`[LinguaSync] yt-dlp: \u5F00\u59CB\u83B7\u53D6\u5B57\u5E55 - ${t}`),!await this.isYtDlpInstalled())throw new Error("yt-dlp \u672A\u5B89\u88C5\u3002\u8BF7\u5148\u5B89\u88C5: pip install yt-dlp \u6216 winget install yt-dlp");let s=he.join($t.tmpdir(),"obsidian-ytsync");F.existsSync(s)||F.mkdirSync(s,{recursive:!0});let i=`https://www.youtube.com/watch?v=${t}`,a=he.join(s,`${t}`);try{console.log("[LinguaSync] yt-dlp: \u83B7\u53D6\u89C6\u9891\u4FE1\u606F...");let o=`yt-dlp --print title --skip-download "${i}"`,r="";try{let{stdout:y}=await ie(o);r=y.trim()}catch(y){r=`Video ${t}`}console.log(`[LinguaSync] yt-dlp: \u4E0B\u8F7D\u5B57\u5E55 (\u8BED\u8A00: ${e})...`);let l="",d=[e,"en","en-US","en-GB"];for(let y of d){let T=`yt-dlp --write-auto-sub --write-sub --sub-lang ${y} --sub-format json3 --skip-download -o "${a}" "${i}"`;try{console.log(`[LinguaSync] yt-dlp: \u5C1D\u8BD5\u8BED\u8A00 ${y}...`),await ie(T,{timeout:6e4});let f=[`${a}.${y}.json3`,`${a}.${y}.vtt`,`${a}.${y}.srt`];for(let h of f)if(F.existsSync(h)){l=h,console.log(`[LinguaSync] yt-dlp: \u627E\u5230\u5B57\u5E55\u6587\u4EF6 - ${h}`);break}if(l)break}catch(f){console.warn(`[LinguaSync] yt-dlp: \u8BED\u8A00 ${y} \u5931\u8D25 - ${f.message}`)}}if(!l){console.log("[LinguaSync] yt-dlp: \u5C1D\u8BD5\u4EFB\u610F\u53EF\u7528\u5B57\u5E55...");let y=`yt-dlp --list-subs "${i}"`;try{let{stdout:h}=await ie(y);console.log("[LinguaSync] \u53EF\u7528\u5B57\u5E55:",h.substring(0,500))}catch(h){}let T=`yt-dlp --write-auto-sub --write-sub --sub-format json3 --skip-download -o "${a}" "${i}"`;await ie(T,{timeout:6e4});let f=F.readdirSync(s);for(let h of f)if(h.startsWith(t)&&(h.endsWith(".json3")||h.endsWith(".vtt")||h.endsWith(".srt"))){l=he.join(s,h),console.log(`[LinguaSync] yt-dlp: \u627E\u5230\u5B57\u5E55\u6587\u4EF6 - ${l}`);break}}if(!l||!F.existsSync(l))throw new Error("yt-dlp \u672A\u80FD\u83B7\u53D6\u5B57\u5E55\u6587\u4EF6");let u=F.readFileSync(l,"utf-8"),g;if(l.endsWith(".json3"))g=this.parseJson3(u);else if(l.endsWith(".vtt"))g=this.parseVtt(u);else if(l.endsWith(".srt"))g=this.parseSrt(u);else throw new Error(`\u4E0D\u652F\u6301\u7684\u5B57\u5E55\u683C\u5F0F: ${l}`);return console.log(`[LinguaSync] yt-dlp: \u2705 \u6210\u529F\u83B7\u53D6 ${g.length} \u6761\u5B57\u5E55`),this.cleanupTempFiles(s,t),{lines:g,title:r,language:e}}catch(o){throw console.error("[LinguaSync] yt-dlp: \u83B7\u53D6\u5B57\u5E55\u5931\u8D25 -",o.message),this.cleanupTempFiles(s,t),o}}static parseJson3(t){try{let e=JSON.parse(t);return e.events?e.events.filter(n=>n.segs&&n.segs.length>0).map(n=>({text:n.segs.map(s=>s.utf8||"").join("").replace(/\n/g," ").trim(),offset:n.tStartMs||0,duration:n.dDurationMs||0})).filter(n=>n.text.length>0):[]}catch(e){return console.error("[LinguaSync] JSON3 \u89E3\u6790\u5931\u8D25:",e),[]}}static parseVtt(t){let e=[],n=t.split(/\n\n+/);for(let s of n){if(s.startsWith("WEBVTT")||s.trim()==="")continue;let i=s.match(/(\d{2}):(\d{2}):(\d{2})\.(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2})\.(\d{3})/);if(i){let a=this.timeToMs(i[1],i[2],i[3],i[4]),o=this.timeToMs(i[5],i[6],i[7],i[8]),l=s.split(`
`).slice(1).filter(d=>!d.match(/-->/)).join(" ").replace(/<[^>]+>/g,"").trim();l&&e.push({offset:a,duration:o-a,text:l})}}return e}static parseSrt(t){let e=[],n=t.split(/\n\n+/);for(let s of n){let i=s.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})\s*-->\s*(\d{2}):(\d{2}):(\d{2}),(\d{3})/);if(i){let a=this.timeToMs(i[1],i[2],i[3],i[4]),o=this.timeToMs(i[5],i[6],i[7],i[8]),l=s.split(`
`).slice(2).join(" ").replace(/<[^>]+>/g,"").trim();l&&e.push({offset:a,duration:o-a,text:l})}}return e}static timeToMs(t,e,n,s){return parseInt(t)*36e5+parseInt(e)*6e4+parseInt(n)*1e3+parseInt(s)}static cleanupTempFiles(t,e){try{let n=F.readdirSync(t);for(let s of n)s.startsWith(e)&&F.unlinkSync(he.join(t,s))}catch(n){}}}});var Ft={};Ce(Ft,{YouTubeScraper:()=>Y});var Ut,Y,ot=de(()=>{Ut=require("obsidian");Bt();at();Y=class{static cleanSubtitleText(t){return t?t.replace(/\[Music\]/gi,"").replace(/\[Applause\]/gi,"").replace(/\[Laughter\]/gi,"").replace(/\[Background Music\]/gi,"").replace(/\[Sound\]/gi,"").replace(/\[Noise\]/gi,"").replace(/\[.*?\]/g,"").replace(/\\n/g," ").replace(/\s+/g," ").trim():""}static getYTranscriptAPI(){return{getTranscript:async(t,e)=>{if(K.isBilibiliUrl(t))throw new Error("yt-dlp should not be used for Bilibili. Please use BilibiliScraper.fetchVideoData() instead.");let n=this.extractVideoId(t);if(!n)throw new Error("Invalid video URL");if(!await q.isYtDlpInstalled())throw new Error("yt-dlp is not installed. Please install: pip install yt-dlp or winget install yt-dlp");console.log(`[LinguaSync] \u{1F504} Using yt-dlp to fetch subtitles: ${n}`);let i=await q.fetchTranscript(n,(e==null?void 0:e.lang)||"en");return console.log(`[LinguaSync] \u2705 yt-dlp succeeded: ${i.lines.length} lines`),{lines:i.lines.map(a=>({offset:a.offset,duration:a.duration,text:a.text}))}}}}static extractVideoId(t){if(K.isBilibiliUrl(t))return K.extractBvId(t);if(/^[a-zA-Z0-9_-]{11}$/.test(t))return t;try{t.startsWith("http")||(t="https://"+t);let e=new URL(t);if(e.hostname.includes("youtu.be"))return e.pathname.slice(1);if(e.hostname.includes("youtube.com")){if(e.searchParams.has("v"))return e.searchParams.get("v");if(e.pathname.startsWith("/shorts/")||e.pathname.startsWith("/embed/")||e.pathname.startsWith("/live/"))return e.pathname.split("/")[2]}return null}catch(e){console.warn("[LinguaSync] URL parsing failed, falling back to regex:",e);let n=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/];for(let s of n){let i=t.match(s);if(i)return i[1]}return null}}static async fetchVideoData(t,e){return K.isBilibiliUrl(t)?await K.fetchVideoData(t):await this.fetchYouTubeData(t,e)}static async fetchYouTubeData(t,e){var i,a;let n=this.extractVideoId(t);if(!n)throw new Error("Invalid YouTube URL");let s=`https://www.youtube.com/watch?v=${n}`;console.log("[LinguaSync] Fetching transcript using built-in fetcher..."),console.log("[LinguaSync] Video URL:",s);try{let o=await(0,Ut.requestUrl)({url:s,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",DNT:"1",Connection:"keep-alive","Upgrade-Insecure-Requests":"1"}}),r=this.extractMetadata(o.text,n);console.log("[LinguaSync] Fetching English transcript...");let l=null,d=["en","en-US","en-GB"];for(let y of d)try{console.log(`[LinguaSync] Trying to fetch English transcript: ${y}`);let f=await this.getYTranscriptAPI().getTranscript(s,{lang:y,country:"US"}),h=((i=f.lines[0])==null?void 0:i.text)||"";if(/[\u4e00-\u9fa5]/.test(h))console.log(`[LinguaSync] \u26A0\uFE0F ${y} returned Chinese content, trying next...`);else{console.log("[LinguaSync] First line preview:",h.substring(0,50)),console.log("[LinguaSync] \u2705 Successfully fetched English transcript"),l=f.lines.map(x=>({start:x.offset/1e3,duration:x.duration/1e3,text:this.cleanSubtitleText(x.text),lang:"en"})),l=l.filter(x=>x.text.length>0);break}}catch(T){console.log(`[LinguaSync] ${y} not available, trying next...`)}if(!l)try{console.log("[LinguaSync] Fetching original language transcript...");let T=await this.getYTranscriptAPI().getTranscript(s),f=((a=T.lines[0])==null?void 0:a.text)||"",h=/[\u4e00-\u9fa5]/.test(f);console.log("[LinguaSync] First line preview:",f.substring(0,50)),h?(console.log("[LinguaSync] \u26A0\uFE0F Original transcript is Chinese only"),console.log("[LinguaSync] \u26A0\uFE0F This video does not have English subtitles")):(console.log("[LinguaSync] \u2705 Original transcript is English"),l=T.lines.map(b=>({start:b.offset/1e3,duration:b.duration/1e3,text:this.cleanSubtitleText(b.text),lang:"en"})),l=l.filter(b=>b.text.length>0))}catch(y){console.error("[LinguaSync] Failed to fetch original transcript:",y)}console.log("[LinguaSync] \u2705 English transcript fetched, skipping Chinese subtitle fetch"),console.log("[LinguaSync] \u2139\uFE0F Chinese translation will be done by AI in background (if configured)");let u,g;if(l)console.log("[LinguaSync] \u2705 Using English transcript (preserves YouTube timestamps)"),console.log(`[LinguaSync] Total lines: ${l.length}`),u=l,g=void 0;else throw new Error("No English subtitles found for this video. The video may not have English captions enabled.");return r.url=t,{metadata:r,transcript:u,translatedTranscript:g}}catch(o){throw console.error("[LinguaSync] YTranscript failed:",o),new Error(`Failed to fetch transcript: ${o.message}`)}}static resegmentTranscript(t){if(!t||t.length===0)return[];if((t.map(d=>d.text).join(" ").match(/[.!?。！？]/g)||[]).length<t.length/10)return console.log("[LinguaSync] Few punctuation marks detected, skipping resegmentation"),t;let s=[],i="",a=0,o=0,r=t[0].lang,l=/[.!?。！？]$/;for(let d=0;d<t.length;d++){let u=t[d];if(!u.text)continue;i||(a=u.start),i+=(i?" ":"")+u.text,o=u.start+(u.duration||0);let g=u.text.trim(),y=l.test(g),T=/\b(Mr|Mrs|Ms|Dr|Prof|St|Ave|Co|Inc|Ltd)\.$/i.test(g);(y&&!T||d===t.length-1)&&(s.push({text:i.trim(),start:a,duration:Math.max(.1,o-a),lang:r}),i="",a=0)}return console.log(`[LinguaSync] Resegmented: ${t.length} \u2192 ${s.length} lines (preserved original timestamps)`),s}static extractMetadata(t,e){var r,l,d;console.log("[LinguaSync] \u{1F50D} Extracting metadata for video:",e);let n="",s="Unknown Author",i=0,a=null,o=t.match(/var ytInitialPlayerResponse\s*=\s*(\{[\s\S]+?\});(?:\s|var|<)/);if(o||(o=t.replace(/\n/g," ").match(/var ytInitialPlayerResponse\s*=\s*(\{[^;]+\});/)),o||(o=t.match(/ytInitialPlayerResponse\s*=\s*(\{[\s\S]+?\});(?:\s|var|<)/)),o&&o[1])try{console.log("[LinguaSync] \u{1F50D} Found playerResponse, JSON length:",o[1].length),a=JSON.parse(o[1]),console.log("[LinguaSync] \u2705 Parsed ytInitialPlayerResponse");let u=a==null?void 0:a.videoDetails;if(console.log("[LinguaSync] videoDetails:",u?"EXISTS":"MISSING"),u)u.title&&(n=u.title,console.log("[LinguaSync] \u2705 Title from videoDetails:",n)),u.author&&(s=u.author),u.lengthSeconds&&(i=parseInt(u.lengthSeconds));else{console.warn("[LinguaSync] \u26A0\uFE0F videoDetails not found in playerResponse"),console.log("[LinguaSync] playerResponse keys:",Object.keys(a));let g=a==null?void 0:a.playabilityStatus;if(g!=null&&g.errorScreen){let f=g.errorScreen.playerErrorMessageRenderer;(r=f==null?void 0:f.reason)!=null&&r.simpleText&&console.log("[LinguaSync] Found playability error:",f.reason.simpleText)}let y=(l=a==null?void 0:a.microformat)==null?void 0:l.playerMicroformatRenderer;y&&((d=y.title)!=null&&d.simpleText&&(n=y.title.simpleText,console.log("[LinguaSync] \u2705 Title from microformat:",n)),y.ownerChannelName&&(s=y.ownerChannelName),y.lengthSeconds&&(i=parseInt(y.lengthSeconds)))}}catch(u){console.warn("[LinguaSync] \u26A0\uFE0F Failed to parse ytInitialPlayerResponse:",u),console.log("[LinguaSync] JSON snippet (first 500 chars):",o[1].substring(0,500))}else console.warn("[LinguaSync] \u26A0\uFE0F ytInitialPlayerResponse not found in HTML");if(!n){let u=t.match(/<title>([^<]+)<\/title>/);if(u){let g=u[1].replace(/\s*-\s*YouTube\s*$/,"").trim();g&&g.length>0?(n=g,console.log("[LinguaSync] \u2705 Title from <title> tag:",n)):console.log("[LinguaSync] \u26A0\uFE0F <title> tag exists but contains no meaningful title")}}if(!n){let u=t.match(/<meta\s+property=["']og:title["']\s+content=["']([^"']+)["']/i);u&&(n=u[1],console.log("[LinguaSync] \u2705 Title from og:title:",n))}if(!n){let u=t.match(/<meta\s+name=["']twitter:title["']\s+content=["']([^"']+)["']/i);u&&(n=u[1],console.log("[LinguaSync] \u2705 Title from twitter:title:",n))}if(!n){let u=t.match(/<meta\s+name=["']title["']\s+content=["']([^"']+)["']/i);u&&(n=u[1],console.log('[LinguaSync] \u2705 Title from meta name="title":',n))}return n||(n=`Video ${e}`,console.warn("[LinguaSync] \u26A0\uFE0F No title found, using fallback:",n)),n=n.replace(/^["'""「]|["'""」]$/g,"").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").trim(),s=s.replace(/^["'""「]|["'""」]$/g,"").replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").trim(),console.log("[LinguaSync] \u{1F4DD} Final metadata - Title:",n,"| Author:",s),{videoId:e,title:n,author:s,channel:s,duration:i,thumbnailUrl:`https://img.youtube.com/vi/${e}/maxresdefault.jpg`,uploadDate:new Date().toISOString().split("T")[0]}}}});var Ae={};Ce(Ae,{AITranslator:()=>ge});var me,ge,ye=de(()=>{me=require("obsidian"),ge=class{constructor(t){this.config=t;this.hasNotifiedError=!1}async testConnection(){let t="Hello";await this.callAI(t)}async translateTranscript(t,e){console.log("[LinguaSync] Starting AI translation (optimized parallel mode)..."),console.log(`[LinguaSync] Provider: ${this.config.provider}, Lines: ${t.length}`);let n=this.config.performanceMode||"fast";console.log(`[LinguaSync] Performance mode: ${n}`);let s=50,i=800,a=3,r={balanced:{batch:.8,delay:1.5,parallel:.67},fast:{batch:1,delay:1,parallel:1},turbo:{batch:1.3,delay:.6,parallel:1.33}}[n];switch(this.config.provider){case"deepseek":s=Math.round(60*r.batch),i=Math.round(600*r.delay),a=Math.max(2,Math.round(4*r.parallel));break;case"siliconflow":s=Math.round(50*r.batch),i=Math.round(800*r.delay),a=Math.max(2,Math.round(3*r.parallel));break;case"gemini":s=Math.round(30*r.batch),i=Math.round(1e3*r.delay),a=Math.max(1,Math.round(2*r.parallel));break;case"openai":s=Math.round(40*r.batch),i=Math.round(800*r.delay),a=Math.max(2,Math.round(3*r.parallel));break;default:s=Math.round(50*r.batch),i=Math.round(800*r.delay),a=Math.max(2,Math.round(3*r.parallel))}console.log(`[LinguaSync] \u26A1 Optimized config: ${s} lines/batch, ${i}ms delay, ${a} parallel`);let l=new Array(t.length),d=Math.ceil(t.length/s),u=Date.now(),g=0,y=[];for(let h=0;h<t.length;h+=s){let b=Math.floor(h/s),x=t.slice(h,Math.min(h+s,t.length)),P=h,C=(async()=>{let S=b%a*(i/a);S>0&&await this.sleep(S);let w=b+1;console.log(`[LinguaSync] \u{1F504} Batch ${w}/${d} started (${x.length} lines)...`);let D=Date.now();try{let k=await this.translateBatch(x);for(let Q=0;Q<k.length;Q++)l[P+Q]=k[Q];let v=((Date.now()-D)/1e3).toFixed(1);g++;let $=g/d*100,z=(Date.now()-u)/1e3,ve=z/g*d,V=Math.max(0,ve-z);console.log(`[LinguaSync] \u2713 Batch ${w} done in ${v}s | ${g}/${d} (${$.toFixed(0)}%) | ETA: ${V.toFixed(0)}s`),e&&e(g,d,$),g<d&&await this.sleep(i)}catch(k){console.error(`[LinguaSync] \u274C Batch ${w} failed:`,k);for(let v=0;v<x.length;v++)l[P+v]={...x[v],text:`[Translation failed] ${x[v].text}`,lang:"zh"};g++}})();y.push(C),y.length>=a&&await Promise.all(y.splice(0,a))}y.length>0&&await Promise.all(y);let T=((Date.now()-u)/1e3).toFixed(1),f=(t.length*2/parseFloat(T)).toFixed(1);return console.log(`[LinguaSync] \u2705 Translation completed! Total: ${T}s (${t.length} lines, ~${f} lines/s)`),l.filter(h=>h)}async translateBatch(t){let n=`\u8BF7\u5C06\u4EE5\u4E0B\u82F1\u6587\u5B57\u5E55\u7FFB\u8BD1\u6210\u4E2D\u6587\u3002\u8981\u6C42\uFF1A
1. \u4FDD\u6301\u5E8F\u53F7\u4E0D\u53D8
2. \u7FFB\u8BD1\u8981\u51C6\u786E\u3001\u81EA\u7136\u3001\u7B26\u5408\u4E2D\u6587\u8868\u8FBE\u4E60\u60EF
3. \u4E13\u4E1A\u672F\u8BED\u8981\u51C6\u786E
4. \u53EA\u8F93\u51FA\u7FFB\u8BD1\u7ED3\u679C\uFF0C\u4E0D\u8981\u89E3\u91CA

\u5F85\u7FFB\u8BD1\u5185\u5BB9\uFF1A
${t.map((s,i)=>`${i+1}. ${s.text}`).join(`
`)}

\u7FFB\u8BD1\u7ED3\u679C\uFF1A`;try{let s=await this.callAI(n);return this.parseTranslationResponse(s,t)}catch(s){return console.error("[LinguaSync] Translation error:",s),this.hasNotifiedError||(new me.Notice(`Translation failed: ${s.message}. Check console for details.`),this.hasNotifiedError=!0),t.map(i=>({...i,text:`[Translation failed] ${i.text}`,lang:"zh"}))}}async callAI(t,e=5){let{provider:n,apiKey:s,model:i,baseUrl:a}=this.config;for(let o=0;o<e;o++)try{if(n==="openai"||n==="deepseek"||n==="siliconflow"||n==="videocaptioner"||n==="custom")return await this.callOpenAICompatible(t,s,i,a);if(n==="gemini")return await this.callGemini(t,s,i);throw new Error(`Unsupported provider: ${n}`)}catch(r){if((r.message||r.toString()).includes("429")&&o<e-1){let d=Math.pow(2,o)*3e3;d>3e4&&(d=3e4),console.warn(`[LinguaSync] Rate limit hit (429), retrying in ${d}ms... (attempt ${o+1}/${e})`),await this.sleep(d);continue}throw r}throw new Error("API call failed after retries")}async callAIStream(t,e){let{provider:n,apiKey:s,model:i,baseUrl:a}=this.config;if(n==="openai"||n==="deepseek"||n==="siliconflow"||n==="videocaptioner"||n==="custom")return await this.callOpenAICompatibleStream(t,s,i,a,e);if(n==="gemini"){let o=await this.callGemini(t,s,i);return e(o),o}throw new Error(`Unsupported provider: ${n}`)}async callOpenAICompatibleStream(t,e,n,s,i){var d,u,g;if(!e||!e.trim())throw new Error("API key is required but not provided or is empty");let a="https://api.openai.com/v1/chat/completions";this.config.provider==="deepseek"?a="https://api.deepseek.com/v1/chat/completions":this.config.provider==="siliconflow"?a="https://api.siliconflow.cn/v1/chat/completions":this.config.provider==="videocaptioner"&&(a="https://api.videocaptioner.cn/v1/chat/completions");let o=s||a,r="gpt-4o-mini";this.config.provider==="deepseek"?r="deepseek-chat":this.config.provider==="siliconflow"?r="deepseek-ai/DeepSeek-V3":this.config.provider==="videocaptioner"&&(r="gpt-4.1-mini");let l={model:n||r,messages:[{role:"system",content:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u82F1\u4E2D\u7FFB\u8BD1\u52A9\u624B\u3002"},{role:"user",content:t}],temperature:.3,max_tokens:4e3,stream:!0};try{let y=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.trim()}`},body:JSON.stringify(l)});if(!y.ok){let b=await y.text();throw new Error(`API error (${y.status}): ${b}`)}if(!y.body)throw new Error("Response body is null");let T=y.body.getReader(),f=new TextDecoder,h="";for(;;){let{done:b,value:x}=await T.read();if(b)break;let C=f.decode(x,{stream:!0}).split(`
`).filter(S=>S.trim()!=="");for(let S of C)if(S.startsWith("data: ")){let w=S.slice(6);if(w==="[DONE]")continue;try{let k=(g=(u=(d=JSON.parse(w).choices)==null?void 0:d[0])==null?void 0:u.delta)==null?void 0:g.content;k&&(h+=k,i&&i(k))}catch(D){console.warn("Failed to parse streaming chunk:",D)}}}return h}catch(y){throw console.error("[LinguaSync] Streaming API call failed:",y),y}}async callOpenAICompatible(t,e,n,s){if(!e||!e.trim())throw new Error("API key is required but not provided or is empty");let i="https://api.openai.com/v1/chat/completions";this.config.provider==="deepseek"?i="https://api.deepseek.com/v1/chat/completions":this.config.provider==="siliconflow"?i="https://api.siliconflow.cn/v1/chat/completions":this.config.provider==="videocaptioner"&&(i="https://api.videocaptioner.cn/v1/chat/completions");let a=s||i,o="gpt-4o-mini";this.config.provider==="deepseek"?o="deepseek-chat":this.config.provider==="siliconflow"?o="deepseek-ai/DeepSeek-V3":this.config.provider==="videocaptioner"&&(o="gpt-4.1-mini");let r={model:n||o,messages:[{role:"system",content:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u82F1\u4E2D\u7FFB\u8BD1\u52A9\u624B\u3002"},{role:"user",content:t}],temperature:.3,max_tokens:4e3};console.log("[LinguaSync] API Request:",{url:a,provider:this.config.provider,model:r.model,promptLength:t.length});try{let d=(await(0,me.requestUrl)({url:a,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.trim()}`},body:JSON.stringify(r)})).json;if(!d.choices||!d.choices[0]||!d.choices[0].message)throw console.error("[LinguaSync] Invalid API response structure:",d),new Error("Invalid API response structure");return d.choices[0].message.content.trim()}catch(l){throw console.error("[LinguaSync] API Request failed:"),console.error("  URL:",a),console.error("  Provider:",this.config.provider),console.error("  Model:",r.model),console.error("  Error:",l),l.status&&console.error("  Status:",l.status),l.message&&console.error("  Message:",l.message),l}}async callGemini(t,e,n){if(!e||!e.trim())throw new Error("API key is required but not provided or is empty");let i=`https://generativelanguage.googleapis.com/v1beta/models/${n||"gemini-1.5-flash"}:generateContent?key=${e.trim()}`;return(await(0,me.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t}]}],generationConfig:{temperature:.3,maxOutputTokens:4e3}})})).json.candidates[0].content.parts[0].text.trim()}parseTranslationResponse(t,e){let n=t.split(`
`).filter(i=>i.trim()),s=[];for(let i of e){let a=n.find(r=>{let l=r.match(/^(\d+)\.\s*(.+)$/);return l&&parseInt(l[1])===s.length+1}),o;if(a)o=a.match(/^(\d+)\.\s*(.+)$/)[2];else{let r=n[s.length];o=r?r.replace(/^\d+\.\s*/,""):i.text}o=o.replace(/^>+\s*/g,"").replace(/^[>》]+/g,"").trim(),s.push({start:i.start,duration:i.duration,text:o,lang:"zh"})}return s}async segmentAndPunctuate(t){console.log("[LinguaSync] Starting AI segmentation and punctuation...");let e=20,n=[];for(let s=0;s<t.length;s+=e){let i=t.slice(s,s+e);console.log(`[LinguaSync] Processing batch ${Math.floor(s/e)+1}/${Math.ceil(t.length/e)}...`);let a=await this.processSegmentationBatch(i);n.push(...a),s+e<t.length&&(console.log("[LinguaSync] Waiting 3.5s before next batch to avoid rate limit..."),await this.sleep(3500))}return console.log("[LinguaSync] \u2705 AI segmentation completed!"),n}async processSegmentationBatch(t){let n=`You are a subtitle editor. Your task is to merge split subtitle lines into complete, grammatically correct sentences with proper punctuation.

Rules:
1. Merge lines to form full sentences.
2. Add proper punctuation and capitalization.
3. Do NOT change or skip any words.
4. Output strictly in this format: "StartID-EndID: Sentence"
   - StartID: The ID of the first line in this sentence.
   - EndID: The ID of the last line in this sentence.
   - If a sentence is just one line, use "ID-ID".
   
Input lines:
${t.map((s,i)=>`${i+1}. ${s.text}`).join(`
`)}

Output format example:
1-2: Hello, my name is John.
3-3: How are you?
4-6: I am doing great today, thanks for asking.

Output:`;try{let s=await this.callAI(n);return this.parseSegmentationResponse(s,t)}catch(s){return console.error("[LinguaSync] Segmentation error:",s),t}}parseSegmentationResponse(t,e){let n=[],s=t.split(`
`).filter(o=>o.trim());console.log("[LinguaSync] AI segmentation response (first 500 chars):",t.substring(0,500)),console.log(`[LinguaSync] Parsing ${s.length} response lines for ${e.length} original lines`);let i=new Set;for(let o of s){let r=o.match(/^\s*(\d+)\s*-\s*(\d+)\s*:\s*(.+)$/);if(r){let l=parseInt(r[1])-1,d=parseInt(r[2])-1,u=r[3].trim();if(l>=0&&d<e.length&&l<=d){let g=e[l],y=e[d],T=y.start+y.duration-g.start;n.push({start:g.start,duration:T,text:u,lang:g.lang});for(let f=l;f<=d;f++)i.add(f)}else console.warn(`[LinguaSync] Invalid indices in AI output: ${l}-${d} (max: ${e.length-1})`)}else o.trim()&&!o.match(/^(Output|Input|Rules|Example|Format):/i)&&console.warn(`[LinguaSync] Failed to parse AI output line: "${o.substring(0,80)}..."`)}let a=e.length-i.size;if(a>0){console.warn(`[LinguaSync] \u26A0\uFE0F ${a}/${e.length} original lines were not processed by AI!`);for(let o=0;o<e.length;o++)i.has(o)||(console.warn(`[LinguaSync] Adding unprocessed line ${o+1}: "${e[o].text.substring(0,50)}..."`),n.push(e[o]))}return n.length===0&&e.length>0?(console.error("[LinguaSync] \u274C AI segmentation parsing completely failed, using original lines"),e):(console.log(`[LinguaSync] \u2705 Parsed ${n.length} segments from ${e.length} original lines`),n)}cleanText(t){return t?t.replace(/\[Music\]/gi,"").replace(/\[Applause\]/gi,"").replace(/\[Laughter\]/gi,"").replace(/\[Background Music\]/gi,"").replace(/\[Sound\]/gi,"").replace(/\[Noise\]/gi,"").replace(/\[.*?\]/g,"").replace(/\\n/g," ").replace(/\s+/g," ").trim():""}async formatTranscript(t,e){console.log("[LinguaSync] Starting AI text formatting (optimized parallel mode)...");let n=t.map(f=>this.cleanText(f.text)).filter(f=>f.length>0).join(" "),s=3e3,i=[],a="",o=n.split(" ");for(let f of o)(a+" "+f).length>s&&a.length>0?(i.push(a.trim()),a=f):a+=(a?" ":"")+f;a&&i.push(a.trim()),console.log(`[LinguaSync] \u26A1 Formatting ${i.length} chunks (parallel mode, 3000 chars/chunk)...`);let r=this.config.performanceMode||"fast",l=this.config.provider==="deepseek"?3:2,d=this.config.provider==="deepseek"?1200:1500;r==="turbo"?(l=Math.round(l*1.5),d=Math.round(d*.6)):r==="balanced"&&(l=Math.max(1,Math.round(l*.67)),d=Math.round(d*1.5)),console.log(`[LinguaSync] Performance: ${r} | Parallel: ${l} | Delay: ${d}ms`);let u=new Array(i.length),g=Date.now();for(let f=0;f<i.length;f+=l){let b=i.slice(f,Math.min(f+l,i.length)).map(async(x,P)=>{let C=f+P;console.log(`[LinguaSync] \u{1F504} Formatting chunk ${C+1}/${i.length}...`);let S=await this.formatTextChunk(x,e);return u[C]=S,console.log(`[LinguaSync] \u2713 Chunk ${C+1} done`),S});await Promise.all(b),f+l<i.length&&(console.log(`[LinguaSync] Waiting ${d/1e3}s before next batch...`),await this.sleep(d))}let y=((Date.now()-g)/1e3).toFixed(1),T=u.join(`

`);return console.log(`[LinguaSync] \u2705 Formatting completed in ${y}s (${i.length} chunks)!`),T}async formatTextChunk(t,e){let s=(e||`Format the following transcript into properly punctuated paragraphs.

RULES:
1. Add punctuation (periods, commas, question marks) where appropriate
2. Break into short paragraphs (2-4 sentences each)
3. Capitalize the first letter of each sentence
4. Keep ALL original words exactly as they are - do not change, add, or remove any words
5. Output ONLY the formatted text - no explanations, no quotes
6. NEVER use the symbols ">>" or ">" anywhere in your output
7. Do NOT add any markdown formatting

Input:
{{text}}

Output:`).replace(/\{\{text\}\}/g,t);try{let i=await this.callAI(s);return i=i.replace(/\s*>>\s*/g," "),i=i.replace(/\s*》》\s*/g," "),i=i.replace(/\s*》\s*/g," "),i=i.split(`
`).map(a=>a.replace(/^>+\s*/,"")).join(`
`),i=i.replace(/  +/g," ").trim(),i}catch(i){return console.error("[LinguaSync] Formatting error:",i),t}}sleep(t){return new Promise(e=>setTimeout(e,t))}}});var be={};Ce(be,{__assign:()=>dt,__asyncDelegator:()=>On,__asyncGenerator:()=>Bn,__asyncValues:()=>Rn,__await:()=>fe,__awaiter:()=>kn,__classPrivateFieldGet:()=>Vn,__classPrivateFieldIn:()=>zn,__classPrivateFieldSet:()=>_n,__createBinding:()=>ut,__decorate:()=>Cn,__exportStar:()=>Pn,__extends:()=>wn,__generator:()=>Ln,__importDefault:()=>Nn,__importStar:()=>Fn,__makeTemplateObject:()=>$n,__metadata:()=>An,__param:()=>En,__read:()=>Yt,__rest:()=>vn,__spread:()=>Dn,__spreadArray:()=>In,__spreadArrays:()=>Mn,__values:()=>pt});function wn(c,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");ct(c,t);function e(){this.constructor=c}c.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function vn(c,t){var e={};for(var n in c)Object.prototype.hasOwnProperty.call(c,n)&&t.indexOf(n)<0&&(e[n]=c[n]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(c);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(c,n[s])&&(e[n[s]]=c[n[s]]);return e}function Cn(c,t,e,n){var s=arguments.length,i=s<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(c,t,e,n);else for(var o=c.length-1;o>=0;o--)(a=c[o])&&(i=(s<3?a(i):s>3?a(t,e,i):a(t,e))||i);return s>3&&i&&Object.defineProperty(t,e,i),i}function En(c,t){return function(e,n){t(e,n,c)}}function An(c,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(c,t)}function kn(c,t,e,n){function s(i){return i instanceof e?i:new e(function(a){a(i)})}return new(e||(e=Promise))(function(i,a){function o(d){try{l(n.next(d))}catch(u){a(u)}}function r(d){try{l(n.throw(d))}catch(u){a(u)}}function l(d){d.done?i(d.value):s(d.value).then(o,r)}l((n=n.apply(c,t||[])).next())})}function Ln(c,t){var e={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,s,i,a;return a={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(d){return r([l,d])}}function r(l){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,s&&(i=l[0]&2?s.return:l[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,l[1])).done)return i;switch(s=0,i&&(l=[l[0]&2,i.value]),l[0]){case 0:case 1:i=l;break;case 4:return e.label++,{value:l[1],done:!1};case 5:e.label++,s=l[1],l=[0];continue;case 7:l=e.ops.pop(),e.trys.pop();continue;default:if(i=e.trys,!(i=i.length>0&&i[i.length-1])&&(l[0]===6||l[0]===2)){e=0;continue}if(l[0]===3&&(!i||l[1]>i[0]&&l[1]<i[3])){e.label=l[1];break}if(l[0]===6&&e.label<i[1]){e.label=i[1],i=l;break}if(i&&e.label<i[2]){e.label=i[2],e.ops.push(l);break}i[2]&&e.ops.pop(),e.trys.pop();continue}l=t.call(c,e)}catch(d){l=[6,d],s=0}finally{n=i=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Pn(c,t){for(var e in c)e!=="default"&&!Object.prototype.hasOwnProperty.call(t,e)&&ut(t,c,e)}function pt(c){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&c[t],n=0;if(e)return e.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&n>=c.length&&(c=void 0),{value:c&&c[n++],done:!c}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Yt(c,t){var e=typeof Symbol=="function"&&c[Symbol.iterator];if(!e)return c;var n=e.call(c),s,i=[],a;try{for(;(t===void 0||t-- >0)&&!(s=n.next()).done;)i.push(s.value)}catch(o){a={error:o}}finally{try{s&&!s.done&&(e=n.return)&&e.call(n)}finally{if(a)throw a.error}}return i}function Dn(){for(var c=[],t=0;t<arguments.length;t++)c=c.concat(Yt(arguments[t]));return c}function Mn(){for(var c=0,t=0,e=arguments.length;t<e;t++)c+=arguments[t].length;for(var n=Array(c),s=0,t=0;t<e;t++)for(var i=arguments[t],a=0,o=i.length;a<o;a++,s++)n[s]=i[a];return n}function In(c,t,e){if(e||arguments.length===2)for(var n=0,s=t.length,i;n<s;n++)(i||!(n in t))&&(i||(i=Array.prototype.slice.call(t,0,n)),i[n]=t[n]);return c.concat(i||Array.prototype.slice.call(t))}function fe(c){return this instanceof fe?(this.v=c,this):new fe(c)}function Bn(c,t,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=e.apply(c,t||[]),s,i=[];return s={},a("next"),a("throw"),a("return"),s[Symbol.asyncIterator]=function(){return this},s;function a(g){n[g]&&(s[g]=function(y){return new Promise(function(T,f){i.push([g,y,T,f])>1||o(g,y)})})}function o(g,y){try{r(n[g](y))}catch(T){u(i[0][3],T)}}function r(g){g.value instanceof fe?Promise.resolve(g.value.v).then(l,d):u(i[0][2],g)}function l(g){o("next",g)}function d(g){o("throw",g)}function u(g,y){g(y),i.shift(),i.length&&o(i[0][0],i[0][1])}}function On(c){var t,e;return t={},n("next"),n("throw",function(s){throw s}),n("return"),t[Symbol.iterator]=function(){return this},t;function n(s,i){t[s]=c[s]?function(a){return(e=!e)?{value:fe(c[s](a)),done:s==="return"}:i?i(a):a}:i}}function Rn(c){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=c[Symbol.asyncIterator],e;return t?t.call(c):(c=typeof pt=="function"?pt(c):c[Symbol.iterator](),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(i){e[i]=c[i]&&function(a){return new Promise(function(o,r){a=c[i](a),s(o,r,a.done,a.value)})}}function s(i,a,o,r){Promise.resolve(r).then(function(l){i({value:l,done:o})},a)}}function $n(c,t){return Object.defineProperty?Object.defineProperty(c,"raw",{value:t}):c.raw=t,c}function Fn(c){if(c&&c.__esModule)return c;var t={};if(c!=null)for(var e in c)e!=="default"&&Object.prototype.hasOwnProperty.call(c,e)&&ut(t,c,e);return Un(t,c),t}function Nn(c){return c&&c.__esModule?c:{default:c}}function Vn(c,t,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?c!==t||!n:!t.has(c))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(c):n?n.value:t.get(c)}function _n(c,t,e,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?c!==t||!s:!t.has(c))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(c,e):s?s.value=e:t.set(c,e),e}function zn(c,t){if(t===null||typeof t!="object"&&typeof t!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof c=="function"?t===c:c.has(t)}var ct,dt,ut,Un,Te=de(()=>{ct=function(c,t){return ct=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])},ct(c,t)};dt=function(){return dt=Object.assign||function(t){for(var e,n=1,s=arguments.length;n<s;n++){e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},dt.apply(this,arguments)};ut=Object.create?function(c,t,e,n){n===void 0&&(n=e);var s=Object.getOwnPropertyDescriptor(t,e);(!s||("get"in s?!t.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return t[e]}}),Object.defineProperty(c,n,s)}:function(c,t,e,n){n===void 0&&(n=e),c[n]=t[e]};Un=Object.create?function(c,t){Object.defineProperty(c,"default",{enumerable:!0,value:t})}:function(c,t){c.default=t}});var oe=U(Oe=>{"use strict";Object.defineProperty(Oe,"__esModule",{value:!0});Oe.WebmBase=void 0;var ht=class{constructor(t="Unknown",e=0){this.name=t,this.start=e}getType(){return"Unknown"}updateBySource(){}setSource(t){this.source=t,this.updateBySource()}updateByData(){}setData(t){this.data=t,this.updateByData()}getValue(){return this.data}setValue(t){this.setData(t)}};Oe.WebmBase=ht});var $e=U(Re=>{"use strict";Object.defineProperty(Re,"__esModule",{value:!0});Re.SectionType=void 0;var Gt;(function(c){c.Container="Container",c.Uint="Uint",c.Int="Int",c.Float="Float",c.String="String",c.Date="Date",c.Binary="Binary"})(Gt||(Re.SectionType=Gt={}))});var mt=U(Ue=>{"use strict";Object.defineProperty(Ue,"__esModule",{value:!0});Ue.sections=void 0;var p=$e();Ue.sections={172351395:{name:"EBML",type:p.SectionType.Container},646:{name:"EBMLVersion",type:p.SectionType.Uint},759:{name:"EBMLReadVersion",type:p.SectionType.Uint},754:{name:"EBMLMaxIDLength",type:p.SectionType.Uint},755:{name:"EBMLMaxSizeLength",type:p.SectionType.Uint},642:{name:"DocType",type:p.SectionType.String},647:{name:"DocTypeVersion",type:p.SectionType.Uint},645:{name:"DocTypeReadVersion",type:p.SectionType.Uint},108:{name:"Void",type:p.SectionType.Binary},63:{name:"CRC-32",type:p.SectionType.Binary},190023271:{name:"SignatureSlot",type:p.SectionType.Container},16010:{name:"SignatureAlgo",type:p.SectionType.Uint},16026:{name:"SignatureHash",type:p.SectionType.Uint},16037:{name:"SignaturePublicKey",type:p.SectionType.Binary},16053:{name:"Signature",type:p.SectionType.Binary},15963:{name:"SignatureElements",type:p.SectionType.Container},15995:{name:"SignatureElementList",type:p.SectionType.Container},9522:{name:"SignedElement",type:p.SectionType.Binary},139690087:{name:"Segment",type:p.SectionType.Container},21863284:{name:"SeekHead",type:p.SectionType.Container},3515:{name:"Seek",type:p.SectionType.Container},5035:{name:"SeekID",type:p.SectionType.Binary},5036:{name:"SeekPosition",type:p.SectionType.Uint},88713574:{name:"Info",type:p.SectionType.Container},13220:{name:"SegmentUID",type:p.SectionType.Binary},13188:{name:"SegmentFilename",type:p.SectionType.String},1882403:{name:"PrevUID",type:p.SectionType.Binary},1868715:{name:"PrevFilename",type:p.SectionType.String},2013475:{name:"NextUID",type:p.SectionType.Binary},1999803:{name:"NextFilename",type:p.SectionType.String},1092:{name:"SegmentFamily",type:p.SectionType.Binary},10532:{name:"ChapterTranslate",type:p.SectionType.Container},10748:{name:"ChapterTranslateEditionUID",type:p.SectionType.Uint},10687:{name:"ChapterTranslateCodec",type:p.SectionType.Uint},10661:{name:"ChapterTranslateID",type:p.SectionType.Binary},710577:{name:"TimecodeScale",type:p.SectionType.Uint},1161:{name:"Duration",type:p.SectionType.Float},1121:{name:"DateUTC",type:p.SectionType.Date},15273:{name:"Title",type:p.SectionType.String},3456:{name:"MuxingApp",type:p.SectionType.String},5953:{name:"WritingApp",type:p.SectionType.String},103:{name:"Timecode",type:p.SectionType.Uint},6228:{name:"SilentTracks",type:p.SectionType.Container},6359:{name:"SilentTrackNumber",type:p.SectionType.Uint},39:{name:"Position",type:p.SectionType.Uint},43:{name:"PrevSize",type:p.SectionType.Uint},35:{name:"SimpleBlock",type:p.SectionType.Binary},32:{name:"BlockGroup",type:p.SectionType.Container},33:{name:"Block",type:p.SectionType.Binary},34:{name:"BlockVirtual",type:p.SectionType.Binary},13729:{name:"BlockAdditions",type:p.SectionType.Container},38:{name:"BlockMore",type:p.SectionType.Container},110:{name:"BlockAddID",type:p.SectionType.Uint},37:{name:"BlockAdditional",type:p.SectionType.Binary},27:{name:"BlockDuration",type:p.SectionType.Uint},122:{name:"ReferencePriority",type:p.SectionType.Uint},123:{name:"ReferenceBlock",type:p.SectionType.Int},125:{name:"ReferenceVirtual",type:p.SectionType.Int},36:{name:"CodecState",type:p.SectionType.Binary},13730:{name:"DiscardPadding",type:p.SectionType.Int},14:{name:"Slices",type:p.SectionType.Container},104:{name:"TimeSlice",type:p.SectionType.Container},76:{name:"LaceNumber",type:p.SectionType.Uint},77:{name:"FrameNumber",type:p.SectionType.Uint},75:{name:"BlockAdditionID",type:p.SectionType.Uint},78:{name:"Delay",type:p.SectionType.Uint},79:{name:"SliceDuration",type:p.SectionType.Uint},72:{name:"ReferenceFrame",type:p.SectionType.Container},73:{name:"ReferenceOffset",type:p.SectionType.Uint},74:{name:"ReferenceTimeCode",type:p.SectionType.Uint},47:{name:"EncryptedBlock",type:p.SectionType.Binary},106212971:{name:"Tracks",type:p.SectionType.Container},46:{name:"TrackEntry",type:p.SectionType.Container},87:{name:"TrackNumber",type:p.SectionType.Uint},13253:{name:"TrackUID",type:p.SectionType.Uint},3:{name:"TrackType",type:p.SectionType.Uint},57:{name:"FlagEnabled",type:p.SectionType.Uint},8:{name:"FlagDefault",type:p.SectionType.Uint},5546:{name:"FlagForced",type:p.SectionType.Uint},28:{name:"FlagLacing",type:p.SectionType.Uint},11751:{name:"MinCache",type:p.SectionType.Uint},11768:{name:"MaxCache",type:p.SectionType.Uint},254851:{name:"DefaultDuration",type:p.SectionType.Uint},216698:{name:"DefaultDecodedFieldDuration",type:p.SectionType.Uint},209231:{name:"TrackTimecodeScale",type:p.SectionType.Float},4991:{name:"TrackOffset",type:p.SectionType.Int},5614:{name:"MaxBlockAdditionID",type:p.SectionType.Uint},4974:{name:"Name",type:p.SectionType.String},177564:{name:"Language",type:p.SectionType.String},6:{name:"CodecID",type:p.SectionType.String},9122:{name:"CodecPrivate",type:p.SectionType.Binary},362120:{name:"CodecName",type:p.SectionType.String},13382:{name:"AttachmentLink",type:p.SectionType.Uint},1742487:{name:"CodecSettings",type:p.SectionType.String},1785920:{name:"CodecInfoURL",type:p.SectionType.String},438848:{name:"CodecDownloadURL",type:p.SectionType.String},42:{name:"CodecDecodeAll",type:p.SectionType.Uint},12203:{name:"TrackOverlay",type:p.SectionType.Uint},5802:{name:"CodecDelay",type:p.SectionType.Uint},5819:{name:"SeekPreRoll",type:p.SectionType.Uint},9764:{name:"TrackTranslate",type:p.SectionType.Container},9980:{name:"TrackTranslateEditionUID",type:p.SectionType.Uint},9919:{name:"TrackTranslateCodec",type:p.SectionType.Uint},9893:{name:"TrackTranslateTrackID",type:p.SectionType.Binary},96:{name:"Video",type:p.SectionType.Container},26:{name:"FlagInterlaced",type:p.SectionType.Uint},5048:{name:"StereoMode",type:p.SectionType.Uint},5056:{name:"AlphaMode",type:p.SectionType.Uint},5049:{name:"OldStereoMode",type:p.SectionType.Uint},48:{name:"PixelWidth",type:p.SectionType.Uint},58:{name:"PixelHeight",type:p.SectionType.Uint},5290:{name:"PixelCropBottom",type:p.SectionType.Uint},5307:{name:"PixelCropTop",type:p.SectionType.Uint},5324:{name:"PixelCropLeft",type:p.SectionType.Uint},5341:{name:"PixelCropRight",type:p.SectionType.Uint},5296:{name:"DisplayWidth",type:p.SectionType.Uint},5306:{name:"DisplayHeight",type:p.SectionType.Uint},5298:{name:"DisplayUnit",type:p.SectionType.Uint},5299:{name:"AspectRatioType",type:p.SectionType.Uint},963876:{name:"ColourSpace",type:p.SectionType.Binary},1029411:{name:"GammaValue",type:p.SectionType.Float},230371:{name:"FrameRate",type:p.SectionType.Float},97:{name:"Audio",type:p.SectionType.Container},53:{name:"SamplingFrequency",type:p.SectionType.Float},14517:{name:"OutputSamplingFrequency",type:p.SectionType.Float},31:{name:"Channels",type:p.SectionType.Uint},15739:{name:"ChannelPositions",type:p.SectionType.Binary},8804:{name:"BitDepth",type:p.SectionType.Uint},98:{name:"TrackOperation",type:p.SectionType.Container},99:{name:"TrackCombinePlanes",type:p.SectionType.Container},100:{name:"TrackPlane",type:p.SectionType.Container},101:{name:"TrackPlaneUID",type:p.SectionType.Uint},102:{name:"TrackPlaneType",type:p.SectionType.Uint},105:{name:"TrackJoinBlocks",type:p.SectionType.Container},109:{name:"TrackJoinUID",type:p.SectionType.Uint},64:{name:"TrickTrackUID",type:p.SectionType.Uint},65:{name:"TrickTrackSegmentUID",type:p.SectionType.Binary},70:{name:"TrickTrackFlag",type:p.SectionType.Uint},71:{name:"TrickMasterTrackUID",type:p.SectionType.Uint},68:{name:"TrickMasterTrackSegmentUID",type:p.SectionType.Binary},11648:{name:"ContentEncodings",type:p.SectionType.Container},8768:{name:"ContentEncoding",type:p.SectionType.Container},4145:{name:"ContentEncodingOrder",type:p.SectionType.Uint},4146:{name:"ContentEncodingScope",type:p.SectionType.Uint},4147:{name:"ContentEncodingType",type:p.SectionType.Uint},4148:{name:"ContentCompression",type:p.SectionType.Container},596:{name:"ContentCompAlgo",type:p.SectionType.Uint},597:{name:"ContentCompSettings",type:p.SectionType.Binary},4149:{name:"ContentEncryption",type:p.SectionType.Container},2017:{name:"ContentEncAlgo",type:p.SectionType.Uint},2018:{name:"ContentEncKeyID",type:p.SectionType.Binary},2019:{name:"ContentSignature",type:p.SectionType.Binary},2020:{name:"ContentSigKeyID",type:p.SectionType.Binary},2021:{name:"ContentSigAlgo",type:p.SectionType.Uint},2022:{name:"ContentSigHashAlgo",type:p.SectionType.Uint},206814059:{name:"Cues",type:p.SectionType.Container},59:{name:"CuePoint",type:p.SectionType.Container},51:{name:"CueTime",type:p.SectionType.Uint},55:{name:"CueTrackPositions",type:p.SectionType.Container},119:{name:"CueTrack",type:p.SectionType.Uint},113:{name:"CueClusterPosition",type:p.SectionType.Uint},112:{name:"CueRelativePosition",type:p.SectionType.Uint},50:{name:"CueDuration",type:p.SectionType.Uint},4984:{name:"CueBlockNumber",type:p.SectionType.Uint},106:{name:"CueCodecState",type:p.SectionType.Uint},91:{name:"CueReference",type:p.SectionType.Container},22:{name:"CueRefTime",type:p.SectionType.Uint},23:{name:"CueRefCluster",type:p.SectionType.Uint},4959:{name:"CueRefNumber",type:p.SectionType.Uint},107:{name:"CueRefCodecState",type:p.SectionType.Uint},155296873:{name:"Attachments",type:p.SectionType.Container},8615:{name:"AttachedFile",type:p.SectionType.Container},1662:{name:"FileDescription",type:p.SectionType.String},1646:{name:"FileName",type:p.SectionType.String},1632:{name:"FileMimeType",type:p.SectionType.String},1628:{name:"FileData",type:p.SectionType.Binary},1710:{name:"FileUID",type:p.SectionType.Uint},1653:{name:"FileReferral",type:p.SectionType.Binary},1633:{name:"FileUsedStartTime",type:p.SectionType.Uint},1634:{name:"FileUsedEndTime",type:p.SectionType.Uint},4433776:{name:"Chapters",type:p.SectionType.Container},1465:{name:"EditionEntry",type:p.SectionType.Container},1468:{name:"EditionUID",type:p.SectionType.Uint},1469:{name:"EditionFlagHidden",type:p.SectionType.Uint},1499:{name:"EditionFlagDefault",type:p.SectionType.Uint},1501:{name:"EditionFlagOrdered",type:p.SectionType.Uint},54:{name:"ChapterAtom",type:p.SectionType.Container},13252:{name:"ChapterUID",type:p.SectionType.Uint},5716:{name:"ChapterStringUID",type:p.SectionType.String},17:{name:"ChapterTimeStart",type:p.SectionType.Uint},18:{name:"ChapterTimeEnd",type:p.SectionType.Uint},24:{name:"ChapterFlagHidden",type:p.SectionType.Uint},1432:{name:"ChapterFlagEnabled",type:p.SectionType.Uint},11879:{name:"ChapterSegmentUID",type:p.SectionType.Binary},11964:{name:"ChapterSegmentEditionUID",type:p.SectionType.Uint},9155:{name:"ChapterPhysicalEquiv",type:p.SectionType.Uint},15:{name:"ChapterTrack",type:p.SectionType.Container},9:{name:"ChapterTrackNumber",type:p.SectionType.Uint},0:{name:"ChapterDisplay",type:p.SectionType.Container},5:{name:"ChapString",type:p.SectionType.String},892:{name:"ChapLanguage",type:p.SectionType.String},894:{name:"ChapCountry",type:p.SectionType.String},10564:{name:"ChapProcess",type:p.SectionType.Container},10581:{name:"ChapProcessCodecID",type:p.SectionType.Uint},1293:{name:"ChapProcessPrivate",type:p.SectionType.Binary},10513:{name:"ChapProcessCommand",type:p.SectionType.Container},10530:{name:"ChapProcessTime",type:p.SectionType.Uint},10547:{name:"ChapProcessData",type:p.SectionType.Binary},39109479:{name:"Tags",type:p.SectionType.Container},13171:{name:"Tag",type:p.SectionType.Container},9152:{name:"Targets",type:p.SectionType.Container},10442:{name:"TargetTypeValue",type:p.SectionType.Uint},9162:{name:"TargetType",type:p.SectionType.String},9157:{name:"TagTrackUID",type:p.SectionType.Uint},9161:{name:"TagEditionUID",type:p.SectionType.Uint},9156:{name:"TagChapterUID",type:p.SectionType.Uint},9158:{name:"TagAttachmentUID",type:p.SectionType.Uint},10184:{name:"SimpleTag",type:p.SectionType.Container},1443:{name:"TagName",type:p.SectionType.String},1146:{name:"TagLanguage",type:p.SectionType.String},1156:{name:"TagDefault",type:p.SectionType.Uint},1159:{name:"TagString",type:p.SectionType.String},1157:{name:"TagBinary",type:p.SectionType.Binary},5552:{name:"Colour",type:p.SectionType.Container},5553:{name:"MatrixCoefficients",type:p.SectionType.Uint},5554:{name:"BitsPerChannel",type:p.SectionType.Uint},5555:{name:"ChromaSubsamplingHorz",type:p.SectionType.Uint},5556:{name:"ChromaSubsamplingVert",type:p.SectionType.Uint},5557:{name:"CbSubsamplingHorz",type:p.SectionType.Uint},5558:{name:"CbSubsamplingVert",type:p.SectionType.Uint},5559:{name:"ChromaSitingHorz",type:p.SectionType.Uint},5560:{name:"ChromaSitingVert",type:p.SectionType.Uint},5561:{name:"Range",type:p.SectionType.Uint},5562:{name:"TransferCharacteristics",type:p.SectionType.Uint},5563:{name:"Primaries",type:p.SectionType.Uint},5564:{name:"MaxCLL",type:p.SectionType.Uint},5565:{name:"MaxFALL",type:p.SectionType.Uint}}});var yt=U(Fe=>{"use strict";Object.defineProperty(Fe,"__esModule",{value:!0});Fe.WebmUint=void 0;var Hn=oe();function Jt(c){return c.length%2===1?"0"+c:c}var gt=class extends Hn.WebmBase{constructor(t,e=0){super(t,e)}getType(){return"Uint"}updateBySource(){this.data="";for(let t=0;t<this.source.length;t++){let e=this.source[t].toString(16);this.data+=Jt(e)}}updateByData(){let t=this.data.length/2;this.source=new Uint8Array(t);for(let e=0;e<t;e++){let n=this.data.substring(e*2,e*2+2);this.source[e]=parseInt(n,16)}}getValue(){return parseInt(this.data,16)}setValue(t){this.setData(Jt(t.toString(16)))}};Fe.WebmUint=gt});var bt=U(Ne=>{"use strict";Object.defineProperty(Ne,"__esModule",{value:!0});Ne.WebmFloat=void 0;var jn=oe(),ft=class extends jn.WebmBase{constructor(t,e=0){super(t,e)}getType(){return"Float"}getFloatArrayType(){return this.source&&this.source.length===4?Float32Array:Float64Array}updateBySource(){let t=this.source.reverse(),e=this.getFloatArrayType(),n=new e(t.buffer);this.data=n[0]}updateByData(){let t=this.getFloatArrayType(),e=new t([this.data]),n=new Uint8Array(e.buffer);this.source=n.reverse()}};Ne.WebmFloat=ft});var St=U(Ve=>{"use strict";Object.defineProperty(Ve,"__esModule",{value:!0});Ve.WebmString=void 0;var Wn=oe(),Tt=class extends Wn.WebmBase{constructor(t,e=0){super(t,e)}getType(){return"String"}updateBySource(){this.data=this.source}updateByData(){this.source=this.data}getValue(){let t="";return this.source.forEach(e=>{t+=String.fromCharCode(e)}),t}};Ve.WebmString=Tt});var xt=U(ze=>{"use strict";Object.defineProperty(ze,"__esModule",{value:!0});ze.WebmContainer=void 0;var Qt=oe(),Kn=mt(),_e=$e(),qn=yt(),Yn=bt(),Gn=St(),re=class extends Qt.WebmBase{constructor(t,e=!1,n=0){super(t,n),this.isInfinite=e,this.offset=0}getType(){return"Container"}readByte(){return this.source[this.offset++]}readUint(){let t=this.readByte(),e=8-t.toString(2).length,n=t-(1<<7-e);for(let s=0;s<e;s++)n<<=8,n|=this.readByte();return n}updateBySource(){var t;this.data=[];let e;for(this.offset=0;this.offset<this.source.length;this.offset=e){let n=this.offset,s=this.readUint(),{name:i,type:a}=(t=Kn.sections[s])!==null&&t!==void 0?t:{},o=this.readUint();e=this.source.length,o>=0&&(e=Math.min(this.offset+o,e));let r=this.source.slice(this.offset,e),l;switch(a){case _e.SectionType.Container:l=new re(i,o<0,n);break;case _e.SectionType.Uint:l=new qn.WebmUint(i,n);break;case _e.SectionType.Float:l=new Yn.WebmFloat(i,n);break;case _e.SectionType.String:l=new Gn.WebmString(i,n);break;default:l=new Qt.WebmBase(i,n);break}l.setSource(r),this.data.push({id:s,idHex:s.toString(16),data:l})}}writeUint(t,e=!1){let n;for(n=1;(t<0||t>=1<<7*n)&&n<8;n++);if(!e){for(let s=0;s<n;s++)this.source[this.offset+s]=t>>8*(n-1-s)&255;this.source[this.offset]&=(1<<8-n)-1,this.source[this.offset]|=1<<8-n}this.offset+=n}writeSections(t=!1){this.offset=0;for(let e=0;e<this.data.length;e++){let n=this.data[e],s=n.data.source,i=s.length;this.writeUint(n.id,t),this.writeUint(n.data instanceof re&&n.data.isInfinite?-1:i,t),t||this.source.set(s,this.offset),this.offset+=i}return this.offset}updateByData(){let t=this.writeSections(!0);this.source=new Uint8Array(t),this.writeSections()}getSectionById(t){for(let e=0;e<this.data.length;e++){let n=this.data[e];if(n.id===t)return n.data}return null}};ze.WebmContainer=re});var Xt=U(He=>{"use strict";Object.defineProperty(He,"__esModule",{value:!0});He.WebmFile=void 0;var Jn=(Te(),pe(be)),Qn=xt(),le=class extends Qn.WebmContainer{constructor(t){super("File"),this.setSource(t)}getType(){return"File"}toBlob(t="video/webm"){return new Blob([this.source.buffer],{type:t})}static blobToArray(t){return new Promise((e,n)=>{try{let s=new FileReader;s.onloadend=()=>{try{e(new Uint8Array(s.result))}catch(i){n(i)}},s.readAsArrayBuffer(t)}catch(s){n(s)}})}static fromBlob(t){return Jn.__awaiter(this,void 0,void 0,function*(){let e=yield le.blobToArray(t);return new le(e)})}};He.WebmFile=le});var en=U(Zt=>{"use strict";Object.defineProperty(Zt,"__esModule",{value:!0})});var wt=U(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});var j=(Te(),pe(be));j.__exportStar(oe(),_);j.__exportStar(xt(),_);j.__exportStar(Xt(),_);j.__exportStar(bt(),_);j.__exportStar(St(),_);j.__exportStar(yt(),_);j.__exportStar($e(),_);j.__exportStar(en(),_);j.__exportStar(mt(),_)});var vt=U(je=>{"use strict";Object.defineProperty(je,"__esModule",{value:!0});je.fixParsedWebmDuration=void 0;var Xn=wt(),Zn=(c,t,e={})=>{let n=e.logger;n===void 0?n=r=>console.debug(r):n||(n=()=>{});let s=c.getSectionById(139690087);if(!s)return n("[fix-webm-duration] Segment section is missing"),!1;let i=s.getSectionById(88713574);if(!i)return n("[fix-webm-duration] Info section is missing"),!1;let a=i.getSectionById(710577);if(!a)return n("[fix-webm-duration] TimecodeScale section is missing"),!1;let o=i.getSectionById(1161);if(o)if(o.getValue()<=0)n(`[fix-webm-duration] Duration section is present, but the value is ${o.getValue()}`),o.setValue(t);else return n(`[fix-webm-duration] Duration section is present, and the value is ${o.getValue()}`),!1;else n("[fix-webm-duration] Duration section is missing"),o=new Xn.WebmFloat("Duration"),o.setValue(t),i.data.push({id:1161,data:o});return a.setValue(1e6),i.updateByData(),s.updateByData(),c.updateByData(),!0};je.fixParsedWebmDuration=Zn});var tn=U(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.fixWebmDuration=void 0;var es=(Te(),pe(be)),ts=wt(),ns=vt(),ss=(c,t,e)=>es.__awaiter(void 0,void 0,void 0,function*(){try{let n=yield ts.WebmFile.fromBlob(c);if((0,ns.fixParsedWebmDuration)(n,t,e))return n.toBlob(c.type)}catch(n){}return c});We.fixWebmDuration=ss});var sn=U(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});var nn=(Te(),pe(be));nn.__exportStar(tn(),Ke);nn.__exportStar(vt(),Ke)});var rs={};Ce(rs,{default:()=>st});module.exports=pe(rs);var m=require("obsidian");ot();var B=require("obsidian");var ae=class{static convertToBilingualSRT(t,e){let n="";for(let s=0;s<t.length;s++){let i=t[s],a=e[s],o=s+1,r=this.formatSRTTime(i.start),l=this.formatSRTTime(i.start+i.duration);n+=`${o}
`,n+=`${r} --> ${l}
`,n+=`${i.text}
`,a&&(n+=`${a.text}
`),n+=`
`}return n}static convertToSRT(t){let e="";for(let n=0;n<t.length;n++){let s=t[n],i=n+1,a=this.formatSRTTime(s.start),o=this.formatSRTTime(s.start+s.duration);e+=`${i}
`,e+=`${a} --> ${o}
`,e+=`${s.text}

`}return e}static formatSRTTime(t){let e=Math.floor(t/3600),n=Math.floor(t%3600/60),s=Math.floor(t%60),i=Math.floor(t%1*1e3);return`${this.pad(e,2)}:${this.pad(n,2)}:${this.pad(s,2)},${this.pad(i,3)}`}static pad(t,e){return t.toString().padStart(e,"0")}static createBilingualTranscript(t,e){let n="";for(let s=0;s<t.length;s++){let i=t[s],a=e[s],o=this.formatMarkdownTimestamp(i.start);n+=`| ${o} | ${i.text} | ${(a==null?void 0:a.text)||""} |
`}return n}static formatMarkdownTimestamp(t){let e=Math.floor(t/60),n=Math.floor(t%60);return`${this.pad(e,2)}:${this.pad(n,2)}`}static convertToMarkdown(t){let e="";for(let n of t){let s=this.formatMarkdownTimestamp(n.start),i=n.text.replace(/\|/g,"\\|");e+=`| ${s} | ${i} |
`}return e}};ye();var ke=class{constructor(t,e){this.app=t;this.settings=e}finalCleanup(t){return t.replace(/\[Music\]/gi,"").replace(/\[Applause\]/gi,"").replace(/\[.*?\]/g,"").replace(/\\n\\n/g,`

`).replace(/\\n/g," ").replace(/ +/g," ").replace(/ \n/g,`
`).replace(/\n /g,`
`).replace(/\n{3,}/g,`

`).trim()}async createVideoNote(t,e=!1,n=!1){var P,C;let{metadata:s,transcript:i,translatedTranscript:a}=t,o=this.sanitizeFileName(s.title),r=(0,B.normalizePath)(`${this.settings.videoFolder}/${o}.md`),l=this.app.vault.getAbstractFileByPath(r);if(e&&!l){let S=this.app.vault.getMarkdownFiles();for(let w of S)if(w.path.startsWith(this.settings.videoFolder)&&w.basename===o){l=w;break}}l instanceof B.TFile?console.log("[OB English Learner] \u{1F504} Update mode: Targeting existing note at",r):console.log("[OB English Learner] \u{1F4E5} Creating new note..."),await this.ensureFolderExists(this.settings.videoFolder),await this.ensureFolderExists(this.settings.subtitlesFolder),await this.ensureFolderExists(this.settings.thumbnailsFolder);let d="";if(console.log("[OB English Learner] \u{1F50D} autoDownloadThumbnails:",this.settings.autoDownloadThumbnails),this.settings.autoDownloadThumbnails){let S=`${o}.jpg`,w=(0,B.normalizePath)(`${this.settings.thumbnailsFolder}/${S}`);console.log("[OB English Learner] \u{1F50D} Checking for existing cover at:",w),this.app.vault.getAbstractFileByPath(w)?(console.log("[OB English Learner] \u2705 Cover already exists, reusing:",w),d=w):(console.log("[OB English Learner] \u{1F4E5} Cover not found, downloading..."),console.log("[OB English Learner] \u{1F4E5} Thumbnail URL:",s.thumbnailUrl),d=await this.downloadThumbnail(s.thumbnailUrl,o),console.log("[OB English Learner] \u{1F4E5} Download result:",d))}else console.log("[OB English Learner] \u26A0\uFE0F Auto-download thumbnails is disabled");let u={};if(n)console.log("[OB English Learner] \u23E9 Fast mode: Skipping SRT generation (will be done in background)");else{console.log("[OB English Learner] \u{1F4DD} Generating SRT files with original YouTube timestamps");let S=t.transcript,w=t.translatedTranscript;u=await this.ensureSRTFiles(S,w,o)}let g=this.settings.enableAIFormatting&&t.refinedTranscript,y=g?t.refinedTranscript:t.transcript,T=g?t.refinedTranslatedTranscript:t.translatedTranscript,f=(P=y[0])!=null&&P.lang&&y[0].lang.startsWith("en")?y:T&&((C=T[0])!=null&&C.lang)&&T[0].lang.startsWith("en")?T:y,h=t.formattedTranscriptText||null;if(!h&&this.settings.enableAIFormatting&&this.settings.aiApiKey)try{console.log("[OB English Learner] AI formatting enabled, processing transcript...");let S={provider:this.settings.aiProvider,apiKey:this.settings.aiApiKey,model:this.settings.aiModel,baseUrl:this.settings.aiBaseUrl,performanceMode:this.settings.aiPerformanceMode};h=await new ge(S).formatTranscript(f,this.settings.aiFormattingPrompt),console.log("[OB English Learner] \u2705 AI formatting completed successfully")}catch(S){console.error("[OB English Learner] \u274C AI formatting failed, using default format:",S),new B.Notice(`AI Formatting failed: ${S.message}. Check your AI API settings.`)}else h?console.log("[OB English Learner] \u2705 Using pre-formatted transcript from main import"):this.settings.enableAIFormatting&&!this.settings.aiApiKey&&(console.warn("[OB English Learner] \u26A0\uFE0F AI formatting is enabled but AI API Key is not configured!"),new B.Notice("AI Formatting is enabled but AI API Key is missing. Please configure it in settings."));let b=this.buildNoteContent(s,f,T,u,o,d,h),x;return l instanceof B.TFile?(await this.app.vault.modify(l,b),x=l,console.log("[OB English Learner] \u2705 Note updated:",x.basename)):(x=await this.app.vault.create(r,b),console.log("[OB English Learner] \u2705 Note created:",x.basename)),x}buildNoteContent(t,e,n,s,i,a,o=null){let r=this.settings.noteTemplate||this.getDefaultTemplate(),l=[];s.english&&l.push(`- English: [[${this.settings.subtitlesFolder}/${s.english}]]`),s.chinese&&l.push(`- \u4E2D\u6587: [[${this.settings.subtitlesFolder}/${s.chinese}]]`),s.bilingual&&l.push(`- EN-ZH: [[${this.settings.subtitlesFolder}/${s.bilingual}]]`);let d=l.join(`
`),u=e.reduce((C,S)=>C+S.text.split(/\s+/).length,0),g=e.length,y;if(o)console.log("[OB English Learner] Using AI-formatted transcript with punctuation"),y=this.finalCleanup(o);else{console.log("[OB English Learner] Using default bilingual paragraph formatting"),console.log(`[OB English Learner] English lines: ${e.length}, Translation lines: ${n?n.length:0}`),n&&e.length!==n.length&&console.warn(`[OB English Learner] \u26A0\uFE0F Alignment issue: English ${e.length} lines, Translation ${n.length} lines`);let C=[],S=[],w=[];e.forEach((D,k)=>{if(D.text&&D.text.trim().length>0){if(S.push(D.text),n&&k<n.length){let v=n[k];v&&v.text&&v.text.trim().length>0&&(v.text.startsWith("[Translation failed]")?console.warn(`[OB English Learner] Translation failed for line ${k+1}: "${D.text.substring(0,50)}..."`):w.push(v.text))}else n&&console.warn(`[OB English Learner] No translation for line ${k+1} (index ${k} >= ${n.length})`);if(((k+1)%3===0||k===e.length-1)&&S.length>0){let v=S.join(" "),$=w.length>0?w.join(" "):"";$?C.push(`${v}

${$}`):(C.push(v),n&&n.length>0&&console.warn(`[OB English Learner] \u26A0\uFE0F Paragraph ${Math.floor((k+1)/3)} has no translation`)),S=[],w=[]}}}),y=this.finalCleanup(C.join(`

`))}let T=new Date().toISOString().split("T")[0];console.log("[OB English Learner] \u{1F50D} DEBUG - coverPath:",a);let f=a||"",h=this.escapeYAMLString(t.title),b=this.escapeYAMLString(t.channel),x=s.bilingual?`${this.settings.subtitlesFolder}/${s.bilingual}`:s.chinese?`${this.settings.subtitlesFolder}/${s.chinese}`:s.english?`${this.settings.subtitlesFolder}/${s.english}`:"";return r.replace(/{{title}}/g,h).replace(/{{videoId}}/g,t.videoId).replace(/{{url}}/g,t.url||`https://youtu.be/${t.videoId}`).replace(/{{channel}}/g,b).replace(/{{duration}}/g,this.formatDuration(t.duration)).replace(/{{uploadDate}}/g,t.uploadDate||"").replace(/{{date}}/g,T).replace(/{{thumbnail}}/g,t.thumbnailUrl||"").replace(/{{cover}}/g,f).replace(/{{subtitlePath}}/g,x).replace(/{{srtLinks}}/g,d).replace(/{{transcript}}/g,y).replace(/{{totalWords}}/g,u.toString()).replace(/{{totalLines}}/g,g.toString())}getDefaultTemplate(){return`---
type: video
status: inbox
level:  # A1-C2
title: "{{title}}"
channel: "{{channel}}"
url: "{{url}}"
cover: "{{cover}}"
date: {{date}}
tags:
  - english/video
# Language Learner \u517C\u5BB9
langr: "{{title}}"
langr-audio: "{{url}}"
langr-origin: "{{channel}} - YouTube"
---

^^^article

{{transcript}}

^^^words

^^^notes

---

## \u89C6\u9891\u4FE1\u606F

**\u9891\u9053**: {{channel}}  
**\u65F6\u957F**: {{duration}}  
**\u65E5\u671F**: {{uploadDate}}

## \u5B57\u5E55\u6587\u4EF6

{{srtLinks}}`}getFileName(t){return this.sanitizeFileName(t)}async ensureSRTFiles(t,e,n){var y,T;let s=this.settings.subtitlesFolder,i={},a=((y=t[0])==null?void 0:y.lang)||"en",o=(T=e==null?void 0:e[0])==null?void 0:T.lang;console.log(`[OB English Learner] Primary language: ${a}, Translated: ${o||"none"}`);let r=a.startsWith("en"),d=`${n} - ${r?"EN":"ZH"}.srt`,u=(0,B.normalizePath)(`${s}/${d}`);if(this.app.vault.getAbstractFileByPath(u))console.log(`[OB English Learner] SRT already exists, keeping: ${d}`);else{console.log(`[OB English Learner] Creating missing SRT: ${d}`);let f=ae.convertToSRT(t);await this.app.vault.create(u,f)}if(r?i.english=d:i.chinese=d,e&&e.length>0){let h=o&&o.startsWith("en")?"EN":"ZH",b=`${n} - ${h}.srt`,x=(0,B.normalizePath)(`${s}/${b}`);if(this.app.vault.getAbstractFileByPath(x))console.log(`[OB English Learner] SRT already exists, keeping: ${b}`);else{console.log(`[OB English Learner] Creating missing SRT: ${b}`);let C=ae.convertToSRT(e);await this.app.vault.create(x,C)}if(o==="zh"||o&&o.startsWith("zh")?i.chinese=b:i.english=b,a!==o){let C=`${n} - EN-ZH.srt`,S=(0,B.normalizePath)(`${s}/${C}`);if(this.app.vault.getAbstractFileByPath(S))console.log(`[OB English Learner] SRT already exists, keeping: ${C}`);else{console.log(`[OB English Learner] Creating missing SRT: ${C}`);let D=r?t:e,k=r?e:t,v=ae.convertToBilingualSRT(D,k);await this.app.vault.create(S,v)}i.bilingual=C}}else console.log("[OB English Learner] \u2139\uFE0F No translated transcript available");return i}async downloadThumbnail(t,e){let n=`${e}.jpg`,s=(0,B.normalizePath)(`${this.settings.thumbnailsFolder}/${n}`);if(this.app.vault.getAbstractFileByPath(s))return console.log("[OB English Learner] \u2705 Thumbnail already exists:",s),s;let a=[t,t.replace("maxresdefault","sddefault"),t.replace("maxresdefault","hqdefault"),t.replace("maxresdefault","mqdefault"),t.replace("maxresdefault","default")];console.log("[OB English Learner] \u{1F4E5} Attempting to download thumbnail...");for(let o=0;o<a.length;o++){let r=a[o];try{console.log(`[OB English Learner] \u{1F4E5} Trying quality ${o+1}/${a.length}: ${r}`);let l=await(0,B.requestUrl)({url:r});return await this.app.vault.createBinary(s,l.arrayBuffer),console.log("[OB English Learner] \u2705 Thumbnail saved successfully:",s),s}catch(l){console.log(`[OB English Learner] \u26A0\uFE0F Quality ${o+1} failed (${l.message}), trying next...`)}}return console.error("[OB English Learner] \u274C Failed to download thumbnail at any quality"),console.error("[OB English Learner] \u274C Original URL was:",t),""}async ensureFolderExists(t){if(!t||t==="/"||t===".")return;if(!this.app.vault.getAbstractFileByPath(t))try{await this.app.vault.createFolder(t),console.log("[OB English Learner] Created folder:",t)}catch(n){if(n.message&&n.message.includes("Folder already exists")){console.log("[OB English Learner] Folder already exists (race condition handled):",t);return}throw n}}escapeYAMLString(t){return t?/[:\[\]{}&*#?|>=!%@`]/.test(t)||t.startsWith("- ")||t.startsWith(" ")||t.endsWith(" ")||t.includes('"')||t.includes("'")?`"${t.replace(/"/g,'\\"')}"`:t:'""'}sanitizeFileName(t){console.log("[OB English Learner] \u{1F50D} DEBUG - sanitizeFileName input:",t);let e=t.replace(/^["'""「]|["'""」]$/g,"").replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").trim().substring(0,100);return console.log("[OB English Learner] \u{1F50D} DEBUG - sanitizeFileName output:",e),e}formatDuration(t){let e=Math.floor(t/60),n=t%60;return`${e}m ${n}s`}};var Le=require("obsidian"),Pe=class{constructor(t){this.app=t}async initializeKnowledgeBase(t){let e=[`${t}`,`${t}/Videos`,`${t}/Vocab`,`${t}/Assets`];for(let n of e){let s=(0,Le.normalizePath)(n);if(!await this.app.vault.adapter.exists(s))try{await this.app.vault.createFolder(s)}catch(i){if(!i.message||!i.message.includes("Folder already exists"))throw i}}await this.createDashboard(t)}async createDashboard(t){let e=(0,Le.normalizePath)(`${t}/Dashboard.md`);if(await this.app.vault.adapter.exists(e)){console.log("Dashboard already exists");return}let n=`# Language Learning Dashboard

Welcome to your language learning hub! This dashboard provides an overview of your video library and vocabulary.

## \u{1F4DA} Video Library

\`\`\`dataview
TABLE 
  status as Status,
  channel as Channel,
  duration as Duration,
  created_at as "Added"
FROM "${t}/Videos"
WHERE type = "video-note"
SORT created_at DESC
\`\`\`

## \u{1F4E5} Inbox (New Videos)

\`\`\`dataview
TABLE 
  title as Title,
  channel as Channel,
  duration as Duration
FROM "${t}/Videos"
WHERE type = "video-note" AND status = "inbox"
SORT created_at DESC
\`\`\`

## \u{1F3C3} Currently Learning

\`\`\`dataview
TABLE 
  title as Title,
  channel as Channel
FROM "${t}/Videos"
WHERE type = "video-note" AND status = "learning"
\`\`\`

## \u{1F4DD} Vocabulary

\`\`\`dataview
TABLE 
  meaning as Meaning,
  file.link as "Source"
FROM "${t}/Vocab"
WHERE contains(tags, "vocab")
LIMIT 20
\`\`\`

---

*This dashboard uses Dataview queries. Install the Dataview plugin to see the tables above.*
*For a more visual experience, consider using the Obsidian Bases plugin.*
`;await this.app.vault.create(e,n)}async createBasesConfig(t){let e=(0,Le.normalizePath)(`${t}/.bases-config.json`),n={databases:[{name:"Video Library",source:`${t}/Videos`,filter:{type:"video-note"},columns:[{name:"File",type:"file"},{name:"Status",type:"select",options:["inbox","learning","archived"]},{name:"Channel",type:"text"},{name:"Duration",type:"text"},{name:"Created",type:"date",property:"created_at"}],views:[{type:"table",name:"All Videos"},{type:"board",name:"By Status",groupBy:"status"}]},{name:"Vocabulary",source:`${t}/Vocab`,filter:{tags:["vocab"]},columns:[{name:"Word",type:"text"},{name:"Meaning",type:"text"},{name:"Source",type:"link"},{name:"Next Review",type:"date"}]}]};await this.app.vault.create(e,JSON.stringify(n,null,2))}};var De=class{constructor(t){this.currentStep=0;this.currentProgress=0;this.totalSteps=t,this.startTime=Date.now(),this.createToast(),this.show(),this.startTimer()}createToast(){this.container=document.body.createDiv("linguasync-toast");let t=getComputedStyle(document.body).getPropertyValue("--background-primary")||"#ffffff",e=document.body.classList.contains("theme-dark");this.container.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            min-width: 360px;
            max-width: 480px;
            padding: 10px 18px;
            
            /* Glass-morphism with fallback */
            background: ${e?"rgba(30, 30, 40, 0.92)":"rgba(255, 255, 255, 0.92)"};
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            
            /* Border & Shadow */
            border: 1px solid ${e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.08)"};
            border-radius: 10px;
            box-shadow: ${e?"0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2)":"0 8px 32px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06)"};
            
            /* Typography */
            font-family: var(--font-ui);
            color: var(--text-normal);
            
            /* Animation */
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 9999;
            pointer-events: auto;
        `;let n=this.container.createDiv();n.style.cssText=`
            display: flex;
            align-items: center;
            gap: 12px;
        `;let s=n.createSpan();s.textContent="\u{1F3AC}",s.style.cssText=`
            font-size: 18px;
            flex-shrink: 0;
        `;let i=n.createDiv();i.style.cssText=`
            flex: 1;
            min-width: 0;
        `,this.messageEl=i.createDiv(),this.messageEl.style.cssText=`
            font-size: 13px;
            font-weight: 500;
            color: var(--text-normal);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        `;let a=i.createDiv();a.style.cssText=`
            width: 100%;
            height: 2.5px;
            background: ${e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.08)"};
            border-radius: 10px;
            overflow: hidden;
        `,this.progressBar=a.createDiv(),this.progressBar.style.cssText=`
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, 
                var(--interactive-accent) 0%, 
                var(--interactive-accent-hover) 100%);
            border-radius: 10px;
            transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 6px ${e?"rgba(120, 160, 255, 0.4)":"rgba(100, 140, 255, 0.3)"};
        `;let o=n.createDiv();o.style.cssText=`
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            flex-shrink: 0;
        `,this.timeEl=o.createDiv(),this.timeEl.style.cssText=`
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            opacity: 0.7;
        `,this.timeEl.textContent="0:00",this.percentageEl=o.createDiv(),this.percentageEl.style.cssText=`
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            min-width: 38px;
            text-align: right;
        `}show(){requestAnimationFrame(()=>{this.container.style.opacity="1",this.container.style.transform="translateX(-50%) translateY(0)"})}startTimer(){this.timerInterval=window.setInterval(()=>{let t=Math.floor((Date.now()-this.startTime)/1e3),e=Math.floor(t/60),n=t%60;this.timeEl.textContent=`${e}:${n.toString().padStart(2,"0")}`},1e3)}nextStep(t){this.currentStep++,this.currentProgress=Math.min(100,this.currentStep/this.totalSteps*100),this.updateDisplay(t)}updateMessage(t){this.updateDisplay(t)}setProgress(t,e){this.currentProgress=Math.min(100,Math.max(0,t)),e&&(this.messageEl.textContent=e),this.updateDisplay()}updateDisplay(t){t&&(this.messageEl.textContent=t);let e=Math.round(this.currentProgress);this.percentageEl.textContent=`${e}%`,this.progressBar.style.width=`${e}%`}success(t){this.currentStep=this.totalSteps,this.messageEl.textContent=`\u2713 ${t}`,this.messageEl.style.color="var(--text-success)",this.percentageEl.textContent="100%",this.progressBar.style.width="100%",this.progressBar.style.background="var(--text-success)",this.hideTimeout=window.setTimeout(()=>{this.hide()},2500)}error(t){this.messageEl.textContent=`\u2717 ${t}`,this.messageEl.style.color="var(--text-error)",this.progressBar.style.background="var(--text-error)",this.hideTimeout=window.setTimeout(()=>{this.hide()},4e3)}hide(){this.hideTimeout&&clearTimeout(this.hideTimeout),this.timerInterval&&clearInterval(this.timerInterval),this.container.style.opacity="0",this.container.style.transform="translateX(-50%) translateY(-20px)",setTimeout(()=>{this.container.remove()},400)}};var M=require("obsidian"),Me=class extends M.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ls-password-manager"),e.createEl("h2",{text:"Password Manager"});let n=e.createDiv({cls:"setting-item-description"});n.setText("Manage login credentials for accessing content from password-protected sources like cloud storage (WebDAV, Nextcloud) and private file servers. These credentials are securely stored locally and used to stream media and files."),n.style.marginBottom="20px";let s=e.createDiv({cls:"ls-toolbar"});s.style.display="flex",s.style.gap="10px",s.style.marginBottom="20px",this.createToolbarButton(s,"plus","Add Password",()=>this.openAddModal()),this.createToolbarButton(s,"download","Import",()=>new M.Notice("Import feature coming soon")),this.createToolbarButton(s,"upload","Export",()=>new M.Notice("Export feature coming soon")),this.createToolbarButton(s,"trash","Delete All",async()=>{confirm("Are you sure you want to delete all passwords?")&&(this.plugin.settings.credentials=[],await this.plugin.saveSettings(),this.onOpen())},!0);let i=e.createDiv({cls:"ls-password-list"});i.style.minHeight="300px",i.style.background="var(--background-secondary)",i.style.borderRadius="6px",i.style.padding="20px",i.style.display="flex",i.style.flexDirection="column",this.plugin.settings.credentials&&this.plugin.settings.credentials.length>0?this.renderList(i):this.renderEmptyState(i)}createToolbarButton(e,n,s,i,a=!1){let o=e.createEl("button");(0,M.setIcon)(o,n),o.setAttribute("aria-label",s),o.onclick=i,a&&o.addClass("mod-warning")}renderEmptyState(e){e.style.alignItems="center",e.style.justifyContent="center";let n=e.createDiv();(0,M.setIcon)(n,"lock"),n.style.transform="scale(3)",n.style.color="var(--text-muted)",n.style.marginBottom="20px";let s=e.createEl("h3",{text:"No passwords saved"});s.style.margin="10px 0";let i=e.createDiv({text:"Your saved passwords will appear here. Add your first password to get started."});i.style.color="var(--text-muted)",i.style.textAlign="center",i.style.maxWidth="400px";let a=e.createEl("button",{cls:"mod-cta",text:"Add Password"});a.style.marginTop="20px",(0,M.setIcon)(a,"plus"),a.onclick=()=>this.openAddModal()}renderList(e){e.style.alignItems="stretch",e.style.justifyContent="flex-start",this.plugin.settings.credentials.forEach((n,s)=>{let i=e.createDiv({cls:"ls-credential-item"});i.style.display="flex",i.style.justifyContent="space-between",i.style.alignItems="center",i.style.padding="10px",i.style.borderBottom="1px solid var(--background-modifier-border)";let a=i.createDiv(),o=a.createDiv();o.style.display="flex",o.style.alignItems="center",o.style.gap="8px";let r=o.createSpan(),l=n.type==="baiduyun"?"cloud":n.type==="nextcloud"?"cloud-rain":n.type==="webdav"?"hard-drive":"key";(0,M.setIcon)(r,l);let d=o.createSpan({text:n.name});d.style.fontWeight="bold";let u=a.createDiv({text:`${n.username} @ ${n.url}`});u.style.fontSize="0.8em",u.style.color="var(--text-muted)",u.style.marginLeft="24px";let g=i.createDiv();g.style.display="flex",g.style.gap="5px";let y=g.createEl("button",{cls:"clickable-icon"});(0,M.setIcon)(y,"pencil"),y.onclick=()=>this.openAddModal(n,s);let T=g.createEl("button",{cls:"clickable-icon mod-warning"});(0,M.setIcon)(T,"trash"),T.onclick=async()=>{confirm(`Delete credential "${n.name}"?`)&&(this.plugin.settings.credentials.splice(s,1),await this.plugin.saveSettings(),this.onOpen())}})}openAddModal(e,n){new rt(this.app,this.plugin,e,s=>{e&&n!==void 0?this.plugin.settings.credentials[n]=s:(this.plugin.settings.credentials||(this.plugin.settings.credentials=[]),this.plugin.settings.credentials.push(s)),this.plugin.saveSettings(),this.onOpen()}).open()}onClose(){let{contentEl:e}=this;e.empty()}},rt=class extends M.Modal{constructor(e,n,s,i){super(e);this.plugin=n,this.onSubmit=i,this.credential=s?{...s}:{id:Date.now().toString(),type:"webdav",name:"",url:"",username:"",password:""}}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:this.credential.name?"Edit Password":"Add Password"}),new M.Setting(e).setName("Type").setDesc("Service type").addDropdown(n=>n.addOption("webdav","WebDAV").addOption("nextcloud","Nextcloud").addOption("baiduyun","Baidu Netdisk (via Alist)").addOption("other","Other").setValue(this.credential.type||"webdav").onChange(s=>this.credential.type=s)),new M.Setting(e).setName("Name").setDesc("Friendly name for this connection").addText(n=>n.setValue(this.credential.name).onChange(s=>this.credential.name=s)),new M.Setting(e).setName("URL / Host").setDesc("Server address (e.g. https://dav.example.com)").addText(n=>n.setValue(this.credential.url).onChange(s=>this.credential.url=s)),new M.Setting(e).setName("Username").addText(n=>n.setValue(this.credential.username).onChange(s=>this.credential.username=s)),new M.Setting(e).setName("Password").addText(n=>{n.inputEl.type="password",n.setValue(this.credential.password).onChange(s=>this.credential.password=s)}),new M.Setting(e).addButton(n=>n.setButtonText("Save").setCta().onClick(()=>{if(!this.credential.name||!this.credential.username){new M.Notice("Name and Username are required");return}this.onSubmit(this.credential),this.close()}))}onClose(){this.contentEl.empty()}};var qe=require("obsidian");var Tn="0.12.9",ks=`https://unpkg.com/@ffmpeg/core@${Tn}/dist/umd/ffmpeg-core.js`,L;(function(c){c.LOAD="LOAD",c.EXEC="EXEC",c.FFPROBE="FFPROBE",c.WRITE_FILE="WRITE_FILE",c.READ_FILE="READ_FILE",c.DELETE_FILE="DELETE_FILE",c.RENAME="RENAME",c.CREATE_DIR="CREATE_DIR",c.LIST_DIR="LIST_DIR",c.DELETE_DIR="DELETE_DIR",c.ERROR="ERROR",c.DOWNLOAD="DOWNLOAD",c.PROGRESS="PROGRESS",c.LOG="LOG",c.MOUNT="MOUNT",c.UNMOUNT="UNMOUNT"})(L||(L={}));var Nt=(()=>{let c=0;return()=>c++})();var Ds=new Error("unknown message type"),Vt=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),_t=new Error("called FFmpeg.terminate()"),Ms=new Error("failed to import ffmpeg-core.js");var zt={};var N,G,H,X,Z,Be,O,Ie=class{constructor(){W(this,N,null);W(this,G,{});W(this,H,{});W(this,X,[]);W(this,Z,[]);I(this,"loaded",!1);W(this,Be,()=>{E(this,N)&&(E(this,N).onmessage=({data:{id:t,type:e,data:n}})=>{switch(e){case L.LOAD:this.loaded=!0,E(this,G)[t](n);break;case L.MOUNT:case L.UNMOUNT:case L.EXEC:case L.FFPROBE:case L.WRITE_FILE:case L.READ_FILE:case L.DELETE_FILE:case L.RENAME:case L.CREATE_DIR:case L.LIST_DIR:case L.DELETE_DIR:E(this,G)[t](n);break;case L.LOG:E(this,X).forEach(s=>s(n));break;case L.PROGRESS:E(this,Z).forEach(s=>s(n));break;case L.ERROR:E(this,H)[t](n);break}delete E(this,G)[t],delete E(this,H)[t]})});W(this,O,({type:t,data:e},n=[],s)=>E(this,N)?new Promise((i,a)=>{let o=Nt();E(this,N)&&E(this,N).postMessage({id:o,type:t,data:e},n),E(this,G)[o]=i,E(this,H)[o]=a,s==null||s.addEventListener("abort",()=>{a(new DOMException(`Message # ${o} was aborted`,"AbortError"))},{once:!0})}):Promise.reject(Vt));I(this,"load",({classWorkerURL:t,...e}={},{signal:n}={})=>(E(this,N)||(ue(this,N,t?new Worker(new URL(t,zt.url),{type:"module"}):new Worker(new URL("./worker.js",zt.url),{type:"module"})),E(this,Be).call(this)),E(this,O).call(this,{type:L.LOAD,data:e},void 0,n)));I(this,"exec",(t,e=-1,{signal:n}={})=>E(this,O).call(this,{type:L.EXEC,data:{args:t,timeout:e}},void 0,n));I(this,"ffprobe",(t,e=-1,{signal:n}={})=>E(this,O).call(this,{type:L.FFPROBE,data:{args:t,timeout:e}},void 0,n));I(this,"terminate",()=>{let t=Object.keys(E(this,H));for(let e of t)E(this,H)[e](_t),delete E(this,H)[e],delete E(this,G)[e];E(this,N)&&(E(this,N).terminate(),ue(this,N,null),this.loaded=!1)});I(this,"writeFile",(t,e,{signal:n}={})=>{let s=[];return e instanceof Uint8Array&&s.push(e.buffer),E(this,O).call(this,{type:L.WRITE_FILE,data:{path:t,data:e}},s,n)});I(this,"mount",(t,e,n)=>{let s=[];return E(this,O).call(this,{type:L.MOUNT,data:{fsType:t,options:e,mountPoint:n}},s)});I(this,"unmount",t=>{let e=[];return E(this,O).call(this,{type:L.UNMOUNT,data:{mountPoint:t}},e)});I(this,"readFile",(t,e="binary",{signal:n}={})=>E(this,O).call(this,{type:L.READ_FILE,data:{path:t,encoding:e}},void 0,n));I(this,"deleteFile",(t,{signal:e}={})=>E(this,O).call(this,{type:L.DELETE_FILE,data:{path:t}},void 0,e));I(this,"rename",(t,e,{signal:n}={})=>E(this,O).call(this,{type:L.RENAME,data:{oldPath:t,newPath:e}},void 0,n));I(this,"createDir",(t,{signal:e}={})=>E(this,O).call(this,{type:L.CREATE_DIR,data:{path:t}},void 0,e));I(this,"listDir",(t,{signal:e}={})=>E(this,O).call(this,{type:L.LIST_DIR,data:{path:t}},void 0,e));I(this,"deleteDir",(t,{signal:e}={})=>E(this,O).call(this,{type:L.DELETE_DIR,data:{path:t}},void 0,e))}on(t,e){t==="log"?E(this,X).push(e):t==="progress"&&E(this,Z).push(e)}off(t,e){t==="log"?ue(this,X,E(this,X).filter(n=>n!==e)):t==="progress"&&ue(this,Z,E(this,Z).filter(n=>n!==e))}};N=new WeakMap,G=new WeakMap,H=new WeakMap,X=new WeakMap,Z=new WeakMap,Be=new WeakMap,O=new WeakMap;var Ht;(function(c){c.MEMFS="MEMFS",c.NODEFS="NODEFS",c.NODERAWFS="NODERAWFS",c.IDBFS="IDBFS",c.WORKERFS="WORKERFS",c.PROXYFS="PROXYFS"})(Ht||(Ht={}));var jt=new Error("failed to get response body reader"),Wt=new Error("failed to complete download");var Kt="Content-Length";var Sn=c=>new Promise((t,e)=>{let n=new FileReader;n.onload=()=>{let{result:s}=n;s instanceof ArrayBuffer?t(new Uint8Array(s)):t(new Uint8Array)},n.onerror=s=>{var i,a;e(Error(`File could not be read! Code=${((a=(i=s==null?void 0:s.target)==null?void 0:i.error)==null?void 0:a.code)||-1}`))},n.readAsArrayBuffer(c)}),qt=async c=>{let t;if(typeof c=="string")/data:_data\/([a-zA-Z]*);base64,([^"]*)/.test(c)?t=atob(c.split(",")[1]).split("").map(e=>e.charCodeAt(0)):t=await(await fetch(c)).arrayBuffer();else if(c instanceof URL)t=await(await fetch(c)).arrayBuffer();else if(c instanceof File||c instanceof Blob)t=await Sn(c);else return new Uint8Array;return new Uint8Array(t)};var xn=async(c,t)=>{var s;let e=await fetch(c),n;try{let i=parseInt(e.headers.get(Kt)||"-1"),a=(s=e.body)==null?void 0:s.getReader();if(!a)throw jt;let o=[],r=0;for(;;){let{done:u,value:g}=await a.read(),y=g?g.length:0;if(u){if(i!=-1&&i!==r)throw Wt;t&&t({url:c,total:i,received:r,delta:y,done:u});break}o.push(g),r+=y,t&&t({url:c,total:i,received:r,delta:y,done:u})}let l=new Uint8Array(r),d=0;for(let u of o)l.set(u,d),d+=u.length;n=l.buffer}catch(i){console.log("failed to send download progress event: ",i),n=await e.arrayBuffer(),t&&t({url:c,total:n.byteLength,received:n.byteLength,delta:0,done:!0})}return n},lt=async(c,t,e=!1,n)=>{let s=e?await xn(c,n):await(await fetch(c)).arrayBuffer(),i=new Blob([s],{type:t});return URL.createObjectURL(i)};var an=Ee(sn()),Ye=class{constructor(){this.audioContext=null;this.mediaStreamSource=null;this.processor=null;this.leftChannelData=[];this.recordingLength=0;this.isRecording=!1;this.isPaused=!1;this.stream=null;this.sampleRate=16e3;this.mediaRecorder=null;this.recordedChunks=[];this.format="wav";this.startTime=null}async startRecording(t="wav"){this.format=t;try{if(this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.startTime=Date.now(),this.format==="wav")this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:this.sampleRate}),this.mediaStreamSource=this.audioContext.createMediaStreamSource(this.stream),this.processor=this.audioContext.createScriptProcessor(4096,1,1),this.mediaStreamSource.connect(this.processor),this.processor.connect(this.audioContext.destination),this.processor.onaudioprocess=e=>{if(!this.isRecording||this.isPaused)return;let n=e.inputBuffer.getChannelData(0),s=new Float32Array(n);this.leftChannelData.push(s),this.recordingLength+=s.length},this.leftChannelData=[],this.recordingLength=0;else{let e="audio/webm";MediaRecorder.isTypeSupported("audio/webm;codecs=opus")&&(e="audio/webm;codecs=opus"),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:e}),this.recordedChunks=[],this.mediaRecorder.ondataavailable=n=>{n.data.size>0&&this.recordedChunks.push(n.data)},this.mediaRecorder.start(100)}this.isRecording=!0}catch(e){throw console.error(e),new Error("\u65E0\u6CD5\u8BBF\u95EE\u9EA6\u514B\u98CE: "+e.message)}}pauseRecording(){this.isPaused=!0,this.format==="wav"?this.audioContext&&this.audioContext.state==="running"&&this.audioContext.suspend():this.mediaRecorder&&this.mediaRecorder.state==="recording"&&this.mediaRecorder.pause()}resumeRecording(){this.isPaused=!1,this.format==="wav"?this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume():this.mediaRecorder&&this.mediaRecorder.state==="paused"&&this.mediaRecorder.resume()}async convertWebmToMp3(t){try{let e=new Ie,n="https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd";new qe.Notice("Loading FFmpeg for conversion..."),await e.load({coreURL:await lt(`${n}/ffmpeg-core.js`,"text/javascript"),wasmURL:await lt(`${n}/ffmpeg-core.wasm`,"application/wasm")}),new qe.Notice("Converting to MP3..."),await e.writeFile("input.webm",await qt(t)),await e.exec(["-i","input.webm","-c:a","libmp3lame","-q:a","2","output.mp3"]);let s=await e.readFile("output.mp3");return new Blob([s],{type:"audio/mp3"})}catch(e){throw console.error("Error converting WebM to MP3:",e),new Error(`Failed to convert WebM to MP3: ${e.message}`)}}async stopRecording(){var e;this.isRecording=!1,this.isPaused=!1;let t;if(this.format==="wav"){this.processor&&(this.processor.disconnect(),this.processor.onaudioprocess=null),this.mediaStreamSource&&this.mediaStreamSource.disconnect();let n=this.flattenAudioBuffers(this.leftChannelData,this.recordingLength);t=this.encodeWAV(n,this.sampleRate)}else{this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&await new Promise(o=>{if(!this.mediaRecorder)return o();this.mediaRecorder.onstop=()=>o(),this.mediaRecorder.stop()});let n=((e=this.mediaRecorder)==null?void 0:e.mimeType)||"audio/webm",s=new Blob(this.recordedChunks,{type:n}),i=this.startTime&&Date.now()-this.startTime||0;try{let a=await(0,an.fixWebmDuration)(s,i,{});t=new Blob([a],{type:n})}catch(a){console.warn("Failed to fix WebM duration:",a),t=s}if(this.format==="mp3")try{t=await this.convertWebmToMp3(t)}catch(a){console.error("MP3 conversion failed, fallback to WebM",a),new qe.Notice("MP3 conversion failed, saved as WebM"),t.type!==n&&(t=new Blob([t],{type:n}))}}return this.cleanup(),t}flattenAudioBuffers(t,e){let n=new Float32Array(e),s=0;for(let i of t)n.set(i,s),s+=i.length;return n}encodeWAV(t,e){let n=new ArrayBuffer(44+t.length*2),s=new DataView(n),i=(o,r,l)=>{for(let d=0;d<l.length;d++)o.setUint8(r+d,l.charCodeAt(d))};i(s,0,"RIFF"),s.setUint32(4,36+t.length*2,!0),i(s,8,"WAVE"),i(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,e,!0),s.setUint32(28,e*2,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),i(s,36,"data"),s.setUint32(40,t.length*2,!0);let a=44;for(let o=0;o<t.length;o++){let r=Math.max(-1,Math.min(1,t[o]));r=r<0?r*32768:r*32767,s.setInt16(a,r,!0),a+=2}return new Blob([s],{type:"audio/wav"})}getStream(){return this.stream}cleanup(){this.processor&&(this.processor.disconnect(),this.processor.onaudioprocess=null,this.processor=null),this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.audioContext&&(this.audioContext.state!=="closed"&&this.audioContext.close().catch(t=>console.error(t)),this.audioContext=null),this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.leftChannelData=[],this.recordingLength=0,this.isRecording=!1,this.isPaused=!1}};var Se=require("obsidian"),Ge=class{constructor(t){this.settings=t}updateSettings(t){this.settings=t}async transcribe(t,e){let n=this.settings.sttProvider||"openai";return n==="azure"?this.transcribeAzure(t):n==="assemblyai"?this.transcribeAssemblyAI(t):this.transcribeOpenAI(t,e)}async transcribeAssemblyAI(t){var n;if(!this.settings.sttApiKey)throw new Error("Please configure API Key for Voice to Text");let e=this.settings.sttApiKey;try{let s=await t.arrayBuffer(),i=await(0,Se.requestUrl)({url:"https://api.assemblyai.com/v2/upload",method:"POST",headers:{Authorization:e,"Content-Type":"application/octet-stream"},body:s});if(i.status!==200)throw new Error(`AssemblyAI Upload Error: ${i.status}`);let o={audio_url:i.json.upload_url};this.settings.sttLanguage?o.language_code=this.settings.sttLanguage:o.language_detection=!0;let r=await(0,Se.requestUrl)({url:"https://api.assemblyai.com/v2/transcript",method:"POST",headers:{Authorization:e,"Content-Type":"application/json"},body:JSON.stringify(o)});if(r.status!==200){let y=((n=r.json)==null?void 0:n.error)||r.status;throw new Error(`AssemblyAI Submit Error: ${y}`)}let l=r.json.id,d="queued",u=0,g=180;for(;d!=="completed"&&d!=="error";){if(u++,u>g)throw new Error("AssemblyAI Timeout (3 mins)");await new Promise(T=>setTimeout(T,1e3));let y=await(0,Se.requestUrl)({url:`https://api.assemblyai.com/v2/transcript/${l}`,method:"GET",headers:{Authorization:e}});if(y.status!==200)throw new Error(`AssemblyAI Poll Error: ${y.status}`);if(d=y.json.status,d==="error")throw new Error(`AssemblyAI Processing Error: ${y.json.error}`);if(d==="completed")return y.json.text}throw new Error("AssemblyAI Unknown Error")}catch(s){throw console.error("AssemblyAI Transcription Error",s),new Error("AssemblyAI Failed: "+s.message)}}async transcribeAzure(t){if(!this.settings.sttApiKey)throw new Error("Please configure API Key");let e="eastus";if(this.settings.sttBaseUrl&&!this.settings.sttBaseUrl.startsWith("http"))e=this.settings.sttBaseUrl;else if(!this.settings.sttBaseUrl)throw new Error('For Azure, please put your Region in the "Base URL" field (e.g., eastus)');let n=this.settings.sttLanguage||"zh-CN",s=`https://${e}.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1?language=${n}`,i=await t.arrayBuffer();try{let a=await(0,Se.requestUrl)({url:s,method:"POST",headers:{"Ocp-Apim-Subscription-Key":this.settings.sttApiKey,"Content-Type":"audio/wav; codecs=audio/pcm; samplerate=16000",Accept:"application/json"},body:i});if(a.status!==200)throw new Error(`Azure Error: ${a.status}`);let o=a.json;if(o.RecognitionStatus==="Success")return o.DisplayText;throw new Error(`Azure Failed: ${o.RecognitionStatus}`)}catch(a){throw console.error("Azure Transcription Error",a),a.message.includes("400")||a.message.includes("415")?new Error("Azure requires WAV PCM 16kHz format."):new Error("Azure Failed: "+a.message)}}async transcribeOpenAI(t,e){let n=this.settings.sttApiKey||this.settings.aiApiKey;if(!n)throw new Error("Please configure API Key in settings");console.log("[LinguaSync] Transcribing with OpenAI..."),console.log(`[LinguaSync] Audio Blob: type=${t.type}, size=${t.size}`);let s=new FormData,i=e||"wav";t.type.includes("webm")?i="webm":t.type.includes("mp3")?i="mp3":(t.type.includes("mp4")||t.type.includes("m4a"))&&(i="m4a");let a=`audio.${i}`;console.log(`[LinguaSync] Using filename: ${a}`),s.append("file",t,a),s.append("model",this.settings.sttModel||"whisper-1"),this.settings.sttLanguage&&s.append("language",this.settings.sttLanguage),s.append("response_format","json"),s.append("temperature","0");let o=this.settings.sttBaseUrl;(!o||o.trim()==="")&&(o="https://api.openai.com/v1/audio/transcriptions");try{let r=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${n}`},body:s});if(!r.ok){let d=await r.text();throw console.error("[LinguaSync] Transcription API Error:",r.status,d),new Error(`Transcription failed: ${r.status} - ${d}`)}let l=await r.json();return console.log("[LinguaSync] Transcription success:",l),l.text}catch(r){throw console.error("[LinguaSync] Transcription Exception:",r),new Error("Transcription failed: "+r.message)}}async speakOpenAI(t){let e=this.settings.sttApiKey||this.settings.aiApiKey;if(!e)throw new Error("Please configure API Key in settings");let n="https://api.openai.com/v1/audio/speech";if(this.settings.sttProvider==="custom"&&this.settings.sttBaseUrl){let a=this.settings.sttBaseUrl.trim();a.endsWith("/")&&(a=a.slice(0,-1)),a.endsWith("transcriptions")?n=a.replace("transcriptions","speech"):n=a.replace(/transcriptions$/,"speech")}console.log("[LinguaSync] TTS Request to:",n);let s={model:this.settings.ttsModel||"tts-1",input:t,voice:this.settings.ttsVoice||"alloy"},i=await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok){let a=await i.text();throw new Error(`TTS failed: ${i.status} - ${a}`)}return await i.arrayBuffer()}};var on=require("obsidian"),Ct=class{constructor(t){this.canvas=t;this.animationId=null;this.isPaused=!1;this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount)}connectStream(t){this.audioContext.createMediaStreamSource(t).connect(this.analyser),this.startVisualization()}startVisualization(){let t=()=>{if(this.isPaused){this.animationId=requestAnimationFrame(t);return}this.analyser.getByteFrequencyData(this.dataArray);let e=this.canvas.width,n=this.canvas.height,s=this.canvas.getContext("2d");if(!s)return;s.fillStyle="#1a1a1a",s.fillRect(0,0,e,n);let i=e/this.dataArray.length,a=0;s.fillStyle="#4CAF50";for(let o=0;o<this.dataArray.length;o++){let r=this.dataArray[o]/255*n,l=s.createLinearGradient(a,n,a,n-r);l.addColorStop(0,"#4CAF50"),l.addColorStop(1,"#81C784"),s.fillStyle=l,s.fillRect(a,n-r,i,r),a+=i}this.animationId=requestAnimationFrame(t)};t()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}stop(){this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close().catch(t=>console.error("Error closing AudioContext:",t))}},Je=class extends on.Modal{constructor(e,n,s,i,a){super(e);this.onRecordingClose=n;this.onPause=s;this.onResume=i;this.stream=a;this.timer=0;this.timerInterval=null;this.isPaused=!1;this.transcribingContainer=null}onOpen(){let{contentEl:e,modalEl:n}=this;e.empty(),n.addClass("recording-modal"),n.style.position="absolute",n.style.left="20px",n.style.bottom="60px",n.style.top="auto",n.style.margin="0",this.containerEl.addClass("voice2text-modeless-container");let s=this.containerEl.querySelector(".modal-bg");s&&(s.style.backgroundColor="transparent",s.style.pointerEvents="none"),this.containerEl.style.pointerEvents="none",n.style.pointerEvents="auto",this.makeDraggable(n);let i=e.createDiv("voice2text-modal-container"),a=i.createDiv("voice2text-waveform-container"),o=document.createElement("canvas");o.width=280,o.height=60,o.className="voice2text-waveform",a.appendChild(o),i.createDiv("voice2text-timer").setText("00:00");let l=i.createDiv("voice2text-controls"),d=l.createEl("button",{cls:"voice2text-button"});d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',d.setAttribute("aria-label","Cancel"),d.style.backgroundColor="#e91e63",d.addEventListener("click",()=>{this.stopRecording(!0),this.close()});let u=l.createEl("button",{cls:"voice2text-button"}),g='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',y='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';u.innerHTML=g,u.setAttribute("aria-label","Pause"),u.style.backgroundColor="#ff9800",u.addEventListener("click",()=>{this.isPaused?(this.resumeRecording(),u.innerHTML=g):(this.pauseRecording(),u.innerHTML=y)});let T=l.createEl("button",{cls:"voice2text-button"});T.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>',T.setAttribute("aria-label","Save & Transcribe"),T.style.backgroundColor="#4caf50",T.addEventListener("click",()=>{this.stopRecording(!1),this.close()});let f=i.createDiv("voice2text-transcription");f.style.display="none",this.transcribingContainer=i.createDiv("voice2text-transcribing"),this.transcribingContainer.style.display="none",this.transcribingContainer.innerHTML='<span class="voice2text-transcribing-text">AI Transcribing</span><span class="voice2text-transcribing-dots"><span>.</span><span>.</span><span>.</span></span>',this.visualizer=new Ct(o),this.visualizer.connectStream(this.stream),this.startTimer()}makeDraggable(e){let n=!1,s=0,i=0,a=0,o=0;e.addEventListener("mousedown",r=>{let l=r.target;if(l.tagName==="BUTTON"||l.closest("button"))return;n=!0,s=r.clientX,i=r.clientY;let d=window.getComputedStyle(e),u=new WebKitCSSMatrix(d.transform);a=u.m41,o=u.m42,e.style.cursor="grabbing",document.body.style.userSelect="none"}),document.addEventListener("mousemove",r=>{if(!n)return;let l=r.clientX-s,d=r.clientY-i;e.style.transform=`translate(${a+l}px, ${o+d}px)`}),document.addEventListener("mouseup",()=>{n&&(n=!1,e.style.cursor="default",document.body.style.userSelect="")})}startTimer(){this.timerInterval=window.setInterval(()=>{if(!this.isPaused){this.timer++;let e=Math.floor(this.timer/60),n=this.timer%60,s=this.contentEl.querySelector(".voice2text-timer");s&&s.setText(`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`)}},1e3)}pauseRecording(){this.isPaused=!0,this.onPause(),this.visualizer.pause()}resumeRecording(){this.isPaused=!1,this.onResume(),this.visualizer.resume()}stopRecording(e){this.timerInterval&&clearInterval(this.timerInterval),this.visualizer.stop(),this.onRecordingClose(e)}onClose(){this.timerInterval&&clearInterval(this.timerInterval),this.visualizer.stop()}};var R=require("obsidian");var Qe=class{constructor(){this.dbName="lingua-sync-tts-cache";this.storeName="audio-cache";this.dbVersion=2;this.db=null;this.initPromise=null}async init(){if(this.db){console.log("[TTSCache] Database already initialized");return}return this.initPromise?(console.log("[TTSCache] Database initialization in progress"),this.initPromise):(console.log("[TTSCache] Starting database initialization..."),this.initPromise=new Promise((t,e)=>{let n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{console.error("[TTSCache] Failed to open database:",n.error),this.initPromise=null,e(n.error)},n.onupgradeneeded=s=>{console.log("[TTSCache] Database upgrade needed");let i=s.target.result;i.objectStoreNames.contains(this.storeName)&&(console.log("[TTSCache] Deleting old object store"),i.deleteObjectStore(this.storeName)),console.log("[TTSCache] Creating object store"),i.createObjectStore(this.storeName,{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("[TTSCache] Object store created successfully")},n.onsuccess=()=>{if(this.db=n.result,console.log("[TTSCache] Database opened successfully"),!this.db.objectStoreNames.contains(this.storeName)){console.error("[TTSCache] Object store not found after initialization!"),this.db.close(),this.db=null,this.initPromise=null,e(new Error("Object store not created"));return}console.log("[TTSCache] Database initialization complete"),t()}}),this.initPromise)}async reset(){return console.log("[TTSCache] Resetting database..."),this.db&&(this.db.close(),this.db=null),this.initPromise=null,new Promise((t,e)=>{let n=indexedDB.deleteDatabase(this.dbName);n.onsuccess=()=>{console.log("[TTSCache] Database deleted successfully"),t()},n.onerror=()=>{console.error("[TTSCache] Failed to delete database:",n.error),e(n.error)},n.onblocked=()=>{console.warn("[TTSCache] Database deletion blocked")}})}generateKey(t,e,n,s,i){let a=`${e}:${i}:${n}:${s}:${t}`;return this.simpleHash(a)}simpleHash(t){let e=0;for(let n=0;n<t.length;n++){let s=t.charCodeAt(n);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(36)}async get(t){try{return this.db||await this.init(),this.db?new Promise((e,n)=>{let a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);a.onsuccess=()=>{let o=a.result;o&&o.data?e(o.data):e(null)},a.onerror=()=>n(a.error)}):null}catch(e){return console.error("[TTSCache] get failed:",e),null}}async set(t,e){try{return this.db||await this.init(),this.db?new Promise((n,s)=>{let a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),o={key:t,data:e,timestamp:Date.now()},r=a.put(o);r.onsuccess=()=>n(),r.onerror=()=>s(r.error)}):void 0}catch(n){console.error("[TTSCache] set failed:",n)}}async getSize(){try{return this.db||await this.init(),this.db?new Promise((t,e)=>{try{let i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onsuccess=()=>{let a=i.result,o=0;for(let r of a)r.data&&(o+=r.data.byteLength);t(o)},i.onerror=()=>{console.error("[TTSCache] Error getting size:",i.error),e(i.error)}}catch(n){console.error("[TTSCache] Transaction error:",n),e(n)}}):(console.warn("[TTSCache] Database not initialized, returning 0 size"),0)}catch(t){return console.error("[TTSCache] getSize failed:",t),0}}async clear(){try{return this.db||await this.init(),this.db?new Promise((t,e)=>{let i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onsuccess=()=>t(),i.onerror=()=>e(i.error)}):void 0}catch(t){console.error("[TTSCache] clear failed:",t)}}async cleanOldEntries(t){try{if(this.db||await this.init(),!this.db)return;let e=Date.now()-t*60*60*1e3;return new Promise((n,s)=>{let r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();r.onsuccess=l=>{let d=l.target.result;d?(d.value.timestamp<e&&d.delete(),d.continue()):n()},r.onerror=()=>s(r.error)})}catch(e){console.error("[TTSCache] cleanOldEntries failed:",e)}}};var Xe=class{constructor(t,e){this.currentState="idle";this.chunks=[];this.currentChunkIndex=0;this.editor=null;this.audioElement=null;this.currentAudioUrl=null;this.isPaused=!1;this.pausedAt=0;this.preloadedAudio=new Map;this.preloadQueue=[];this.stateListeners=[];this.chunkListeners=[];this.app=t,this.settings=e,this.cache=new Qe,this.cacheReady=this.cache.init().catch(n=>(console.error("[TTSManager] Cache initialization failed:",n),console.warn("[TTSManager] TTS will work without caching"),Promise.resolve())),this.setupMediaSession()}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.currentState==="paused"&&this.resume()}),navigator.mediaSession.setActionHandler("pause",()=>{this.currentState==="playing"&&this.pause()}),navigator.mediaSession.setActionHandler("stop",()=>{this.stop()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.previous()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.next()}),console.log("[TTSManager] Media Session API initialized for OS integration"))}updateMediaSessionMetadata(t){if("mediaSession"in navigator){let e=t.slice(0,100)+(t.length>100?"...":"");navigator.mediaSession.metadata=new MediaMetadata({title:"Aloud TTS",artist:"Obsidian",album:"Text to Speech",artwork:[]})}}updateMediaSessionPlaybackState(t){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=t)}getState(){return this.currentState}onStateChange(t){this.stateListeners.push(t)}onChunkChange(t){this.chunkListeners.push(t)}setState(t){this.currentState=t,this.stateListeners.forEach(e=>e(t))}notifyChunkChange(){this.chunkListeners.forEach(t=>t(this.currentChunkIndex,this.chunks.length))}chunkText(t,e,n,s){return(this.settings.ttsChunking||"sentence")==="paragraph"?this.chunkByParagraph(t,e,n,s):this.chunkBySentence(t,e,n,s)}chunkTextWithOffsets(t,e,n){return(this.settings.ttsChunking||"sentence")==="paragraph"?this.chunkByParagraphWithOffsets(t,e):this.chunkBySentenceWithOffsets(t,e)}chunkBySentence(t,e,n,s){let i=/[^.!?]+[.!?]+/g,a=t.match(i)||[t],o=[],r=e.posToOffset(n),l=0;for(let d of a){let u=d.trim();if(u.length===0){l+=d.length;continue}let g=t.indexOf(d,l),y=g+(d.length-d.trimStart().length),T=y+u.length,f=r+y,h=r+T;h>f?(o.push({text:u,start:f,end:h}),console.log("[TTSManager] Chunk:",u.substring(0,30)+"...",`(${f}-${h})`)):console.warn("[TTSManager] Skipping empty chunk:",u),l=g+d.length}return console.log("[TTSManager] Created",o.length,"chunks"),o}chunkBySentenceWithOffsets(t,e){let n=/[^.!?]+[.!?]+/g,s=t.match(n)||[t],i=[],a=0;for(let o of s){let r=o.trim();if(r.length===0){a+=o.length;continue}let l=t.indexOf(o,a),d=l+(o.length-o.trimStart().length),u=d+r.length,g=e+d,y=e+u;y>g?(i.push({text:r,start:g,end:y}),console.log("[TTSManager] Chunk:",r.substring(0,30)+"...",`(${g}-${y})`)):console.warn("[TTSManager] Skipping empty chunk:",r),a=l+o.length}return console.log("[TTSManager] Created",i.length,"chunks with baseOffset:",e),i}chunkByParagraph(t,e,n,s){let i=t.split(/\n\n+/),a=[],o=e.posToOffset(n),r=0;for(let l of i){let d=l.trim();if(d.length===0){r+=l.length+2;continue}let u=t.indexOf(l,r),g=u+(l.length-l.trimStart().length),y=g+d.length,T=o+g,f=o+y;f>T&&a.push({text:d,start:T,end:f}),r=u+l.length}return a}chunkByParagraphWithOffsets(t,e){let n=t.split(/\n\n+/),s=[],i=0;for(let a of n){let o=a.trim();if(o.length===0){i+=a.length+2;continue}let r=t.indexOf(a,i),l=r+(a.length-a.trimStart().length),d=l+o.length,u=e+l,g=e+d;g>u&&s.push({text:o,start:u,end:g}),i=r+a.length}return console.log("[TTSManager] Created",s.length,"paragraphs with baseOffset:",e),s}async playSelection(t,e,n,s){if(this.stop(),this.chunks=this.chunkText(t,e,n,s),this.chunks.length===0){new R.Notice("No text to speak");return}let i=this.chunks.length===1?"sentence":"sentences";new R.Notice(`\u{1F50A} Playing ${this.chunks.length} ${i}`),this.updateMediaSessionMetadata(t),this.currentChunkIndex=0,this.editor=e,this.setState("loading"),await this.playCurrentChunk()}async playSelectionWithOffsets(t,e,n,s){if(this.stop(),this.chunks=this.chunkTextWithOffsets(t,n,s),this.chunks.length===0){new R.Notice("No text to speak");return}let i=this.chunks.length===1?"sentence":"sentences";new R.Notice(`\u{1F50A} Playing ${this.chunks.length} ${i}`),this.updateMediaSessionMetadata(t),this.currentChunkIndex=0,this.editor=null,this.setState("loading"),await this.playCurrentChunk()}async playCurrentChunk(){if(this.currentChunkIndex<0||this.currentChunkIndex>=this.chunks.length){console.error("[TTS] Invalid chunk index:",this.currentChunkIndex),this.stop();return}let t=this.chunks[this.currentChunkIndex];console.log("[TTS] Playing chunk:",this.currentChunkIndex,"/",this.chunks.length,t.text.substring(0,50)),this.notifyChunkChange(),this.preloadNextChunks(),this.setState("loading");try{let e=this.preloadedAudio.get(this.currentChunkIndex);if(e?(console.log("[TTS] \u{1F3AF} Using preloaded audio for chunk",this.currentChunkIndex),this.preloadedAudio.delete(this.currentChunkIndex)):(console.log("[TTS] \u{1F4E1} Fetching audio for chunk",this.currentChunkIndex),e=await this.fetchAudio(t.text)),await this.playAudioBuffer(e),this.currentState!=="idle"){if(this.currentChunkIndex++,this.currentChunkIndex>=this.chunks.length){this.stop();return}this.playCurrentChunk()}}catch(e){console.error("TTS playback error:",e),new R.Notice(`TTS Error: ${e.message}`),this.stop()}}async preloadNextChunks(){for(let e=1;e<=2;e++){let n=this.currentChunkIndex+e;if(n<this.chunks.length&&!this.preloadedAudio.has(n)){let s=this.chunks[n];this.fetchAudio(s.text).then(i=>{this.preloadedAudio.set(n,i),console.log("[TTS] \u2705 Preloaded chunk",n)}).catch(i=>{console.warn("[TTS] Failed to preload chunk",n,i)})}}}async pause(){this.currentState==="playing"&&this.audioElement&&(this.pausedAt=this.audioElement.currentTime,this.audioElement.pause(),this.isPaused=!0,this.setState("paused"),this.updateMediaSessionPlaybackState("paused"),console.log("[TTS] Paused at:",this.pausedAt))}async resume(){this.currentState!=="paused"||!this.isPaused||(this.isPaused=!1,this.audioElement&&this.audioElement.play().then(()=>{console.log("[TTS] Resumed from:",this.pausedAt),this.setState("playing"),this.updateMediaSessionPlaybackState("playing")}).catch(t=>{console.error("[TTS] Failed to resume:",t),this.stop()}))}stop(){this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0),this.currentAudioUrl&&(URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=null),this.isPaused=!1,this.pausedAt=0,this.preloadedAudio.clear(),this.setState("idle"),this.updateMediaSessionPlaybackState("none"),console.log("[TTS] Stopped")}async next(){this.currentChunkIndex<this.chunks.length-1&&(this.currentChunkIndex++,this.notifyChunkChange(),this.audioElement&&this.audioElement.pause(),await this.playCurrentChunk())}async previous(){this.currentChunkIndex>0&&(this.currentChunkIndex--,this.notifyChunkChange(),this.audioElement&&this.audioElement.pause(),await this.playCurrentChunk())}setPlaybackSpeed(t){console.log("[TTSManager] setPlaybackSpeed called, speed:",t),this.settings.ttsSpeed=t,this.audioElement?(this.audioElement.playbackRate=t,console.log("[TTSManager] \u2705 Playback speed changed instantly to:",t)):console.log("[TTSManager] Not playing, speed will apply on next play")}async fetchAudio(t){let e=this.settings.ttsProvider||"openai",n=this.settings.ttsVoice||"alloy",s=1,i=this.settings.ttsModel||"tts-1";console.log("[TTS] fetchAudio - caching at speed 1.0, playback speed:",this.settings.ttsSpeed,"text:",t.substring(0,30));let a=this.settings.ttsCacheType!=="none";if(a)try{await this.cacheReady;let r=this.cache.generateKey(t,e,n,s,i);console.log("[TTS] Cache key generated with speed:",s,"key:",r);let l=await this.cache.get(r);if(l)return console.log("[TTS] \u2705 Cache HIT for speed:",s,"text:",t.substring(0,30)),l;console.log("[TTS] \u274C Cache MISS for speed:",s,"text:",t.substring(0,30))}catch(r){console.warn("[TTS] Cache read failed, fetching from API:",r)}console.log("[TTS] \u{1F504} Calling API with provider:",e,"speed:",s);let o;switch(e){case"openai":o=await this.speakOpenAI(t),console.log("[TTS] \u2705 API call completed, received audio buffer");break;case"azure":o=await this.speakAzure(t);break;case"elevenlabs":o=await this.speakElevenLabs(t);break;default:throw new Error(`Unsupported TTS provider: ${e}`)}if(console.log("[TTS] \u{1F4E6} Audio buffer size:",o.byteLength,"bytes"),a)try{await this.cacheReady;let r=this.cache.generateKey(t,e,n,s,i);await this.cache.set(r,o),console.log("[TTS] Cached audio for:",t.substring(0,50))}catch(r){console.warn("[TTS] Failed to cache audio:",r)}return o}async playAudioBuffer(t,e=0){return new Promise((n,s)=>{this.audioElement||(this.audioElement=new Audio,console.log("[TTS] Created new HTMLAudioElement")),this.audioElement.pause(),this.currentAudioUrl&&(URL.revokeObjectURL(this.currentAudioUrl),this.currentAudioUrl=null);let i=new Blob([t],{type:"audio/mpeg"}),a=URL.createObjectURL(i);this.currentAudioUrl=a;let o=()=>{console.log("[TTS] Audio ended"),this.audioElement.removeEventListener("ended",o),this.audioElement.removeEventListener("error",r),this.audioElement.removeEventListener("loadeddata",l),n()},r=d=>{console.error("[TTS] Audio error:",d),this.audioElement.removeEventListener("ended",o),this.audioElement.removeEventListener("error",r),this.audioElement.removeEventListener("loadeddata",l),s(new Error("Audio playback failed"))},l=()=>{console.log("[TTS] Audio loaded, starting playback"),this.audioElement.removeEventListener("loadeddata",l);let d=this.settings.ttsSpeed||1;this.audioElement.playbackRate=d,console.log("[TTS] Setting playbackRate to:",d),e>0&&(this.audioElement.currentTime=e),this.audioElement.play().then(()=>{console.log("[TTS] Playback started successfully"),this.setState("playing"),this.updateMediaSessionPlaybackState("playing")}).catch(u=>{console.error("[TTS] Failed to start playback:",u),s(u)})};this.audioElement.addEventListener("ended",o),this.audioElement.addEventListener("error",r),this.audioElement.addEventListener("loadeddata",l,{once:!0}),this.audioElement.src=a,this.audioElement.load()})}async speakOpenAI(t){let e=this.settings.ttsApiKey||this.settings.aiApiKey;if(!e)throw new Error("OpenAI API key not configured");let n=this.settings.ttsModel||"tts-1",s=this.settings.ttsVoice||"alloy",i=1;console.log("[TTS] speakOpenAI - calling API at normal speed (1.0), playback speed will be applied via playbackRate");try{let a=await(0,R.requestUrl)({url:"https://api.openai.com/v1/audio/speech",method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:n,input:t,voice:s,speed:i})});if(a.status===200)return a.arrayBuffer;throw new Error(`OpenAI TTS failed with status ${a.status}`)}catch(a){throw console.error("OpenAI TTS error:",a),new Error(`OpenAI TTS error: ${a.message}`)}}async speakAzure(t){let e=this.settings.ttsApiKey||this.settings.aiApiKey,n=this.settings.ttsBaseUrl||"eastus",s=this.settings.ttsVoice||"en-US-JennyNeural",i=this.settings.ttsOutputFormat||"audio-16khz-128kbitrate-mono-mp3";if(!e)throw new Error("Azure API key not configured");try{let a=`<speak version='1.0' xml:lang='en-US'>
                <voice name='${s}'>${t}</voice>
            </speak>`,o=await(0,R.requestUrl)({url:`https://${n}.tts.speech.microsoft.com/cognitiveservices/v1`,method:"POST",headers:{"Ocp-Apim-Subscription-Key":e,"Content-Type":"application/ssml+xml","X-Microsoft-OutputFormat":i,"User-Agent":"OB-English-Learner"},body:a});if(o.status===200)return o.arrayBuffer;throw new Error(`Azure TTS failed with status ${o.status}`)}catch(a){throw console.error("Azure TTS error:",a),new Error(`Azure TTS error: ${a.message}`)}}async speakElevenLabs(t){let e=this.settings.ttsApiKey||this.settings.aiApiKey,n=this.settings.ttsVoice||"21m00Tcm4TlvDq8ikWAM",s=this.settings.ttsModel||"eleven_monolingual_v1";if(!e)throw new Error("ElevenLabs API key not configured");try{let i=await(0,R.requestUrl)({url:`https://api.elevenlabs.io/v1/text-to-speech/${n}`,method:"POST",headers:{"xi-api-key":e,"Content-Type":"application/json"},body:JSON.stringify({text:t,model_id:s,voice_settings:{stability:.5,similarity_boost:.75}})});if(i.status===200)return i.arrayBuffer;throw new Error(`ElevenLabs TTS failed with status ${i.status}`)}catch(i){throw console.error("ElevenLabs TTS error:",i),new Error(`ElevenLabs TTS error: ${i.message}`)}}async getAzureVoices(){try{let t=this.settings.ttsApiKey||this.settings.aiApiKey,e=this.settings.ttsBaseUrl||"eastus";if(!t||!e)return console.error("Azure TTS: Missing API key or region"),[];let n=await(0,R.requestUrl)({url:`https://${e}.tts.speech.microsoft.com/cognitiveservices/voices/list`,method:"GET",headers:{"Ocp-Apim-Subscription-Key":t}});return n.status===200?n.json:(console.error("Failed to fetch Azure voices:",n.status),[])}catch(t){throw console.error("Error fetching Azure voices:",t),t}}async getCacheSize(){try{return await this.cacheReady,await this.cache.getSize()}catch(t){return console.error("[TTS] Failed to get cache size:",t),0}}async clearCache(){try{await this.cacheReady,await this.cache.clear(),new R.Notice("\u2705 TTS cache cleared")}catch(t){console.error("[TTS] Failed to clear cache:",t);try{console.log("[TTS] Attempting to reset database..."),await this.cache.reset(),await this.cache.init(),new R.Notice("\u2705 TTS cache reset successfully")}catch(e){console.error("[TTS] Failed to reset cache:",e),new R.Notice("\u274C Failed to clear cache")}}}async cleanOldCache(){try{await this.cacheReady;let t=this.settings.ttsCacheDuration||24;await this.cache.cleanOldEntries(t)}catch(t){console.error("[TTS] Failed to clean old cache:",t)}}async testSpeak(t){let e=await this.fetchAudio(t);await this.playAudioBuffer(e)}};var et=require("@codemirror/view"),xe=require("obsidian");var Ze=require("@codemirror/state"),J=require("@codemirror/view"),Et=Ze.StateEffect.define(),is=J.EditorView.theme({".tts-highlight-current":{backgroundColor:"rgba(128, 0, 128, 0.4) !important",color:"rgb(128, 0, 128) !important",borderRadius:"2px"},".tts-highlight-before":{backgroundColor:"rgba(128, 0, 128, 0.2) !important",borderRadius:"2px"},".tts-highlight-after":{backgroundColor:"rgba(128, 0, 128, 0.2) !important",borderRadius:"2px"}}),as=Ze.StateField.define({create(){return J.Decoration.none},update(c,t){c=c.map(t.changes);for(let e of t.effects)if(e.is(Et))if(e.value){let{from:n,to:s}=e.value;c=J.Decoration.set([J.Decoration.mark({class:"tts-highlight-current"}).range(n,s)])}else c=J.Decoration.none;return c},provide:c=>J.EditorView.decorations.from(c)});function rn(){return[as,is]}function ln(c,t,e){if(console.log("[TTS Highlight] \u{1F506} highlightRange called, from:",t,"to:",e),t>=e){console.warn("[TTS Highlight] \u274C Invalid range:",t,e);return}console.log("[TTS Highlight] \u{1F4E4} Dispatching setHighlight effect..."),c.dispatch({effects:Et.of({from:t,to:e})}),console.log("[TTS Highlight] \u2705 Highlight effect dispatched!")}function At(c){c.dispatch({effects:Et.of(null)})}var kt=class{constructor(t,e){this.toolbarEl=null;this.currentState="idle";this.currentChunk=0;this.totalChunks=0;this.view=t,this.ttsManager=e,console.log("[TTS Toolbar] Initializing Aloud-style toolbar"),this.createToolbar(),this.ttsManager.onStateChange(n=>{this.currentState=n,this.updateUI()}),this.ttsManager.onChunkChange((n,s)=>{this.currentChunk=n,this.totalChunks=s,this.updateUI(),this.highlightCurrentChunk()})}createToolbar(){let t=this.view.dom.closest(".cm-editor");if(!t){console.error("[TTS Toolbar] Could not find editor container");return}this.toolbarEl=document.createElement("div"),this.toolbarEl.addClass("tts-toolbar");let e=this.toolbarEl.createDiv("tts-toolbar-player"),n=e.createDiv("tts-toolbar-player-button-group");this.createButton(n,"play","Play selection","play").addEventListener("click",()=>this.handlePlay());let i=e.createDiv("tts-toolbar-player-button-group");this.createButton(i,"skip-back","Previous","skip-back").addEventListener("click",()=>{console.log("[TTS Toolbar] Previous clicked"),this.ttsManager.previous()}),this.createButton(i,"pause","Pause","pause").addEventListener("click",()=>{console.log("[TTS Toolbar] Pause/Resume clicked"),this.handlePauseResume()}),this.createButton(i,"skip-forward","Next","skip-forward").addEventListener("click",()=>{console.log("[TTS Toolbar] Next clicked"),this.ttsManager.next()});let l=e.createDiv("tts-toolbar-player-button-group");this.createButton(l,"eye","Toggle auto-scroll","eye").addEventListener("click",()=>this.toggleAutoscroll()),this.updateAutoscrollButton();let u=this.createButton(l,"speed","Cycle playback speed",void 0),g=this.ttsManager.settings.ttsSpeed||1;u.setText(`${g}x`),u.addEventListener("click",()=>this.cycleSpeed(u));let y=e.createDiv("tts-audio-status-container"),T=y.createDiv("tts-audio-status-loading");T.style.display="none",T.innerHTML=`
            <svg class="tts-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <circle cx="12" cy="12" r="10" stroke-dasharray="31.4 31.4" />
            </svg>
        `;let f=y.createDiv("tts-audio-visualizer");f.style.display="none";for(let S=0;S<8;S++){let w=f.createDiv("tts-audio-visualizer-bar");w.style.animationDelay=`${S*.1}s`}let h=y.createDiv("tts-progress-text");h.style.display="none",h.setText("");let b=e.createDiv("tts-toolbar-player-button-group"),x=this.createButton(b,"x","Cancel playback","x");x.addEventListener("click",()=>{console.log("[TTS Toolbar] Close clicked"),this.ttsManager.stop()}),x.style.display="none";let P=e.createDiv("tts-progress-bar-container"),C=P.createDiv("tts-progress-bar-fill");P.style.display="none",t.insertBefore(this.toolbarEl,t.firstChild),console.log("[TTS Toolbar] Aloud-style toolbar created with button groups")}createButton(t,e,n,s){let i=document.createElement("button");return i.className=`clickable-icon tts-toolbar-button ${e}`,i.setAttribute("aria-label",n),s&&(0,xe.setIcon)(i,s),t.appendChild(i),i}updateUI(){var u;if(!this.toolbarEl)return;console.log("[TTS Toolbar] updateUI called, state:",this.currentState);let t=this.toolbarEl.querySelector(".tts-toolbar-button.play"),e=this.toolbarEl.querySelector(".tts-toolbar-button.pause"),n=this.toolbarEl.querySelector(".tts-toolbar-button.skip-back"),s=this.toolbarEl.querySelector(".tts-toolbar-button.skip-forward"),i=this.toolbarEl.querySelector(".tts-audio-status-loading"),a=this.toolbarEl.querySelector(".tts-audio-visualizer"),o=this.toolbarEl.querySelector(".tts-progress-text"),r=this.toolbarEl.querySelector(".tts-progress-bar-container"),l=this.toolbarEl.querySelector(".tts-progress-bar-fill");if(this.currentState==="idle"?(t==null||t.classList.add("tts-toolbar-button-active"),e==null||e.classList.remove("tts-toolbar-button-active"),n==null||n.classList.remove("tts-toolbar-button-active"),s==null||s.classList.remove("tts-toolbar-button-active"),t&&t.setAttribute("aria-label","Play selection"),n&&(n.disabled=!0),s&&(s.disabled=!0),e&&(e.disabled=!0),t&&(t.disabled=!1)):this.currentState==="playing"?(t==null||t.classList.remove("tts-toolbar-button-active"),n==null||n.classList.add("tts-toolbar-button-active"),s==null||s.classList.add("tts-toolbar-button-active"),e&&(e.empty(),(0,xe.setIcon)(e,"pause"),e.setAttribute("aria-label","Pause"),e.disabled=!1,e.classList.add("tts-toolbar-button-active")),n&&(n.disabled=!1,console.log("[TTS Toolbar] Skip Back disabled:",n.disabled)),s&&(s.disabled=!1,console.log("[TTS Toolbar] Skip Forward disabled:",s.disabled)),e&&(e.disabled=!1,console.log("[TTS Toolbar] Pause disabled:",e.disabled)),t&&(t.disabled=!0)):this.currentState==="paused"?(t==null||t.classList.remove("tts-toolbar-button-active"),n==null||n.classList.add("tts-toolbar-button-active"),s==null||s.classList.add("tts-toolbar-button-active"),e&&(e.empty(),(0,xe.setIcon)(e,"step-forward"),e.setAttribute("aria-label","Resume"),e.disabled=!1,e.classList.add("tts-toolbar-button-active")),n&&(n.disabled=!1),s&&(s.disabled=!1),t&&(t.disabled=!0)):this.currentState==="loading"&&(t&&(t.disabled=!0),e&&(e.disabled=!0),n&&(n.disabled=!0),s&&(s.disabled=!0)),i&&(i.style.display=this.currentState==="loading"?"flex":"none"),a&&(a.style.display=this.currentState==="playing"?"flex":"none"),o&&(this.currentState==="paused"&&this.totalChunks>0?(o.setText(`${this.currentChunk+1}/${this.totalChunks}`),o.style.display="block"):o.style.display="none"),r&&l)if(this.totalChunks>0&&(this.currentState==="playing"||this.currentState==="paused")){let g=(this.currentChunk+1)/this.totalChunks*100;l.style.width=`${g}%`,r.style.display="block",console.log(`[TTS Toolbar] Progress: ${g.toFixed(1)}% (${this.currentChunk+1}/${this.totalChunks})`)}else r.style.display="none";let d=(u=this.toolbarEl)==null?void 0:u.querySelector(".tts-toolbar-button.x");d&&(d.style.display=this.currentState==="playing"||this.currentState==="paused"?"flex":"none")}handlePlay(){if(this.currentState==="paused")this.ttsManager.resume();else if(this.currentState==="idle"){let t=this.view.state,e=t.selection.main,n,s,i;e.empty?(n=t.doc.toString(),s=0,i=t.doc.length):(n=t.sliceDoc(e.from,e.to),s=e.from,i=e.to),console.log("[TTS Toolbar] Playing text:",n.substring(0,50),`offset: ${s}-${i}`),this.ttsManager.playSelectionWithOffsets(n,this.view,s,i)}}handlePauseResume(){this.currentState==="playing"?this.ttsManager.pause():this.currentState==="paused"&&this.ttsManager.resume()}updateAutoscrollButton(){var s;let t=(s=this.toolbarEl)==null?void 0:s.querySelector(".tts-toolbar-button.eye");if(!t)return;let e=this.ttsManager.settings.ttsAutoscroll;t.empty(),(0,xe.setIcon)(t,e?"eye":"eye-off"),e?(t.classList.add("tts-toolbar-button-active"),t.setAttribute("aria-label","Autoscroll enabled (click to disable)")):(t.classList.remove("tts-toolbar-button-active"),t.setAttribute("aria-label","Autoscroll disabled (click to enable)")),console.log("[TTS Toolbar] Auto-scroll button updated:",e?"eye":"eye-off")}toggleAutoscroll(){this.ttsManager.settings.ttsAutoscroll=!this.ttsManager.settings.ttsAutoscroll,this.updateAutoscrollButton(),console.log("[TTS Toolbar] Auto-scroll:",this.ttsManager.settings.ttsAutoscroll?"enabled":"disabled")}cycleSpeed(t){let e=[.75,1,1.25,1.5,2],n=this.ttsManager.settings.ttsSpeed||1,i=(e.indexOf(n)+1)%e.length,a=e[i];this.ttsManager.settings.ttsSpeed=a,t.setText(`${a}x`),this.ttsManager.setPlaybackSpeed(a),console.log("[TTS Toolbar] Speed changed to:",a)}highlightCurrentChunk(){var a,o,r,l,d;console.log("[TTS Toolbar] \u{1F3AF} highlightCurrentChunk called, currentChunk:",this.currentChunk),console.log("[TTS Toolbar] \u{1F50D} View object:",this.view?"exists":"NULL"),console.log("[TTS Toolbar] \u{1F50D} View.state:",(a=this.view)!=null&&a.state?"exists":"NULL"),console.log("[TTS Toolbar] \u{1F50D} Doc length:",(l=(r=(o=this.view)==null?void 0:o.state)==null?void 0:r.doc)==null?void 0:l.length);let t=this.ttsManager.chunks;if(!t||t.length===0||this.currentChunk<0||this.currentChunk>=t.length){console.log("[TTS Toolbar] \u274C Cannot highlight - invalid state"),At(this.view);return}let e=t[this.currentChunk];if(!e){console.warn("[TTS Toolbar] Invalid chunk:",e);return}let n=e.start,s=e.end;if(console.log("[TTS Toolbar] \u{1F4CD} Highlight offsets:",n,"-",s,"text:",e.text.substring(0,30)),console.log("[TTS Toolbar] \u{1F4CD} Chunk object:",JSON.stringify(e,null,2)),n>=s){console.warn("[TTS Toolbar] Invalid offsets:",n,s,"for chunk:",e);return}let i=this.view.state.doc.length;if(n<0||s>i){console.warn("[TTS Toolbar] Offsets out of range. Document length:",i,"offsets:",n,s);return}try{this.view.dispatch({selection:{anchor:s,head:s}}),console.log("[TTS Toolbar] \u2728 Applying highlight..."),ln(this.view,n,s),this.ttsManager.settings.ttsAutoscroll&&this.currentState==="playing"&&this.ttsManager.audioElement&&!this.ttsManager.audioElement.paused?(console.log("[TTS Toolbar] \u{1F4DC} Auto-scrolling to chunk (playing confirmed)..."),setTimeout(()=>{this.currentState==="playing"&&this.view.dispatch({effects:et.EditorView.scrollIntoView(n,{y:"center",yMargin:100})})},50)):console.log("[TTS Toolbar] \u23F8 Skipping scroll:",{autoscroll:this.ttsManager.settings.ttsAutoscroll,state:this.currentState,hasAudio:!!this.ttsManager.audioElement,paused:(d=this.ttsManager.audioElement)==null?void 0:d.paused}),console.log("[TTS Toolbar] \u2705 Successfully highlighted chunk:",this.currentChunk+1,"/",t.length,`(${n}-${s})`)}catch(u){console.error("[TTS Toolbar] \u274C Error highlighting chunk:",u)}}clearAllHighlights(){At(this.view)}createDummyEditor(){return{getCursor:()=>({line:0,ch:0}),posToOffset:t=>0,offsetToPos:t=>({line:0,ch:0}),scrollIntoView:()=>{}}}destroy(){this.toolbarEl&&(this.toolbarEl.remove(),this.toolbarEl=null)}};function cn(c){let t=et.ViewPlugin.define(n=>new kt(n,c)),e=rn();return[t,e]}var ee=require("obsidian"),tt=class{constructor(t){this.commands=[];this.app=t}fromJSON(t){this.commands=t||[]}getContextMenuCommands(){return this.commands.filter(t=>t.showInContextMenu!==!1).sort((t,e)=>t.order!==void 0&&e.order!==void 0?t.order-e.order:e.lastUsedMs-t.lastUsedMs)}executeCommand(t,e){let n=this.commands.find(i=>i.title===t);if(!n)throw new Error(`Command "${t}" not found`);n.lastUsedMs=Date.now();let s=n.content.replace(/\{\{selection\}\}/g,e);return!s.includes(e)&&!n.content.includes("{{selection}}")&&(s=`${n.content}

${e}`),s}setCustomCommands(t){this.commands=t}async loadCommandsFromFolder(t){try{console.log("[CustomCommandManager] Looking for folder:",t);let e=this.app.vault.getAbstractFileByPath(t);if(!e)return console.warn("[CustomCommandManager] Folder not found:",t),new ee.Notice(`\u26A0\uFE0F Custom commands folder not found: ${t}`),[];if(!(e instanceof ee.TFolder))return console.warn("[CustomCommandManager] Path is not a folder:",t),new ee.Notice(`\u26A0\uFE0F Path is not a folder: ${t}`),[];console.log("[CustomCommandManager] Found folder, scanning for .md files...");let n=[],s=e.children.filter(i=>i instanceof ee.TFile&&i.extension==="md");console.log("[CustomCommandManager] Found",s.length,".md files:",s.map(i=>i.name));for(let i of s)try{let a=await this.app.vault.read(i),o=this.parseCommandFile(i.basename,a);o?(n.push(o),console.log("[CustomCommandManager] Loaded command:",o.title)):console.warn("[CustomCommandManager] Failed to parse command file:",i.name)}catch(a){console.error(`[CustomCommandManager] Failed to load command from ${i.path}:`,a)}return this.commands=n,console.log("[CustomCommandManager] Total commands loaded:",n.length),n}catch(e){return console.error("[CustomCommandManager] Failed to load commands:",e),[]}}parseCommandFile(t,e){var n,s,i,a,o,r,l,d,u,g;try{let y=e.match(/^---\n([\s\S]*?)\n---/),T={},f=e;y&&(y[1].split(`
`).forEach(w=>{let D=w.match(/^([^:]+):\s*(.*)$/);if(D){let k=D[1].trim(),v=D[2].trim();v==="true"?T[k]=!0:v==="false"?T[k]=!1:!isNaN(Number(v))&&v!==""?T[k]=Number(v):T[k]=v}}),f=e.substring(y[0].length).trim());let h=(s=(n=T.showInContextMenu)!=null?n:T["copilot-command-context-menu-enabled"])!=null?s:!0,b=(a=(i=T.showInSlashMenu)!=null?i:T["copilot-command-slash-enabled"])!=null?a:!0,x=(r=(o=T.order)!=null?o:T["copilot-command-context-menu-order"])!=null?r:0,P=(d=(l=T.modelKey)!=null?l:T["copilot-command-model-key"])!=null?d:"",C=(g=(u=T.lastUsedMs)!=null?u:T["copilot-command-last-used"])!=null?g:Date.now();return{title:t,content:f,showInContextMenu:h,showInSlashMenu:b,order:x,modelKey:P,lastUsedMs:C}}catch(y){return console.error(`[CustomCommandManager] Failed to parse command file ${t}:`,y),null}}async updateCommand(t){let e=this.commands.findIndex(n=>n.title===t.title);e!==-1&&(this.commands[e]=t)}getAllCommands(){return this.commands}};var A=require("obsidian"),Lt=class extends A.Modal{constructor(e,n,s,i,a){super(e);this.command={...n},this.isNew=s,this.allCommands=i,this.onSave=a,this.originalTitle=n.title}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("custom-command-edit-modal"),this.titleEl.setText(this.isNew?"Add Custom Command":"Edit Custom Command"),new A.Setting(e).setName("Name").setDesc("Command name (will be used as filename)").addText(r=>{r.setPlaceholder("e.g., Explain Code").setValue(this.command.title).onChange(l=>{this.command.title=l}),r.inputEl.style.width="100%"});let n=new A.Setting(e).setName("Prompt").setDesc("Use {{selection}} to reference selected text").addTextArea(r=>{r.setPlaceholder(`Enter your prompt here...

Example:
Please explain the following code:
{{selection}}`).setValue(this.command.content).onChange(l=>{this.command.content=l}),r.inputEl.rows=12,r.inputEl.style.width="100%",r.inputEl.style.fontFamily="var(--font-monospace)"}),s=e.createDiv({cls:"setting-item-description"});s.style.marginTop="10px",s.style.marginBottom="20px",s.innerHTML=`
            <strong>Available variables:</strong><br>
            \u2022 <code>{{selection}}</code> - Currently selected text<br>
            If {{selection}} is not found, text will be appended at the end.
        `,new A.Setting(e).setName("Show in Context Menu").setDesc("Available when right-clicking in the editor").addToggle(r=>{r.setValue(this.command.showInContextMenu!==!1).onChange(l=>{this.command.showInContextMenu=l})}),new A.Setting(e).setName("Show in Slash Menu").setDesc("Available as a slash command in chat").addToggle(r=>{r.setValue(this.command.showInSlashMenu!==!1).onChange(l=>{this.command.showInSlashMenu=l})});let i=e.createDiv({cls:"modal-button-container"});i.style.display="flex",i.style.justifyContent="flex-end",i.style.gap="10px",i.style.marginTop="20px";let a=i.createEl("button",{text:"Cancel"});a.onclick=()=>this.close();let o=i.createEl("button",{text:"Save",cls:"mod-cta"});o.onclick=async()=>{await this.handleSave()}}async handleSave(){if(!this.command.title.trim()){new A.Notice("\u274C Command name is required");return}if(!this.command.content.trim()){new A.Notice("\u274C Prompt content is required");return}if(this.command.title!==this.originalTitle&&this.allCommands.find(s=>s.title.toLowerCase()===this.command.title.toLowerCase())){new A.Notice("\u274C A command with this name already exists");return}let e=this.command.title.replace(/[\\/:*?"<>|]/g,"-");e!==this.command.title&&(new A.Notice("\u26A0\uFE0F Invalid characters removed from filename"),this.command.title=e);try{await this.onSave(this.command),this.close()}catch(n){new A.Notice("\u274C Failed to save command: "+n.message),console.error("Save command error:",n)}}onClose(){let{contentEl:e}=this;e.empty()}},nt=class{constructor(t,e,n,s,i,a){this.containerEl=t,this.app=e,this.commands=n,this.onUpdate=a,this.customCommandManager=s,this.customCommandsFolder=i}render(){this.containerEl.empty();let t=this.containerEl.createDiv({cls:"ls-info-box"});t.style.marginBottom="20px",t.innerHTML=`
            <div style="display: flex; gap: 12px; align-items: start;">
                <div style="font-size: 24px; line-height: 1;">\u{1F4A1}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 500; margin-bottom: 6px; color: var(--text-normal);">\u5173\u4E8E\u81EA\u5B9A\u4E49\u547D\u4EE4</div>
                    <div style="font-size: 0.9em; color: var(--text-muted); line-height: 1.5;">
                        \u81EA\u5B9A\u4E49\u547D\u4EE4\u662F\u53EF\u4EE5\u4ECE\u7F16\u8F91\u5668\u53F3\u952E\u83DC\u5355\u6216\u901A\u8FC7\u804A\u5929\u4E2D\u7684 <code>/</code> \u547D\u4EE4\u89E6\u53D1\u7684\u9884\u8BBE\u63D0\u793A\u8BCD\u3002<br>
                        \u547D\u4EE4\u4F1A\u81EA\u52A8\u4ECE\u60A8\u7684\u81EA\u5B9A\u4E49\u63D0\u793A\u8BCD\u6587\u4EF6\u5939 <strong>${this.customCommandsFolder}</strong> \u4E2D\u7684 .md \u6587\u4EF6\u52A0\u8F7D\u3002<br>
                        \u4FEE\u6539\u8FD9\u4E9B\u6587\u4EF6\u4E5F\u4F1A\u81EA\u52A8\u66F4\u65B0\u547D\u4EE4\u8BBE\u7F6E\u3002
                    </div>
                </div>
            </div>
        `;let e=this.containerEl.createDiv({cls:"custom-commands-actions"});e.style.display="flex",e.style.justifyContent="space-between",e.style.marginBottom="15px",e.style.gap="10px";let n=e.createEl("button",{text:"\u751F\u6210\u9ED8\u8BA4 (Generate Default)"});n.onclick=async()=>{let i=new A.Modal(this.app);i.titleEl.setText("Generate Default Commands / \u751F\u6210\u9ED8\u8BA4\u547D\u4EE4");let a=i.contentEl.createDiv();a.style.padding="20px 0",a.innerHTML=`
                <p style="margin-bottom: 15px;">
                    This will add default commands to your custom prompts folder. Continue?<br>
                    <span style="color: var(--text-muted); font-size: 0.9em;">
                        \u8FD9\u5C06\u5411\u60A8\u7684\u81EA\u5B9A\u4E49\u547D\u4EE4\u6587\u4EF6\u5939\u6DFB\u52A0\u9ED8\u8BA4\u547D\u4EE4\u3002\u662F\u5426\u7EE7\u7EED\uFF1F
                    </span>
                </p>
                <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 10px;">
                    \u{1F4C1} Folder / \u6587\u4EF6\u5939: <strong>${this.customCommandsFolder}</strong>
                </p>
            `;let o=i.contentEl.createDiv();o.style.display="flex",o.style.justifyContent="flex-end",o.style.gap="10px",o.style.marginTop="20px";let r=o.createEl("button",{text:"Cancel / \u53D6\u6D88"});r.onclick=()=>i.close();let l=o.createEl("button",{text:"Continue / \u7EE7\u7EED",cls:"mod-cta"});l.onclick=async()=>{i.close(),await this.generateDefaultCommands()},i.open()};let s=e.createEl("button",{text:"+ \u6DFB\u52A0\u547D\u4EE4 (Add Cmd)",cls:"mod-cta"});s.onclick=()=>this.openCommandModal(),this.renderCommandsTable()}renderCommandsTable(){let t=this.containerEl.createDiv({cls:"custom-commands-table-container"});if(this.commands.length===0){let h=t.createDiv({cls:"custom-commands-empty"});h.style.textAlign="center",h.style.padding="40px",h.style.color="var(--text-muted)",h.setText('No custom commands found. Click "Add Command" to create one.');return}let e=t.createEl("table",{cls:"custom-commands-table"});e.style.width="100%",e.style.borderCollapse="collapse";let s=e.createEl("thead").createEl("tr"),i=s.createEl("th");i.style.width="30px",i.style.padding="12px 8px",i.style.borderBottom="2px solid var(--background-modifier-border)";let a=s.createEl("th");a.setText("Name"),a.style.textAlign="left",a.style.padding="12px 8px",a.style.borderBottom="2px solid var(--background-modifier-border)",a.style.fontWeight="600";let o=s.createEl("th"),r=o.createDiv();r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.gap="4px",r.createSpan({text:"In Menu"});let l=r.createSpan({text:"?",cls:"tooltip-icon"});l.style.fontSize="0.8em",l.style.color="var(--text-muted)",l.style.cursor="help",l.title="Show in right-click context menu",o.style.textAlign="center",o.style.padding="12px 8px",o.style.borderBottom="2px solid var(--background-modifier-border)",o.style.fontWeight="600";let d=s.createEl("th"),u=d.createDiv();u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.gap="4px",u.createSpan({text:"Slash Cmd"});let g=u.createSpan({text:"?",cls:"tooltip-icon"});g.style.fontSize="0.8em",g.style.color="var(--text-muted)",g.style.cursor="help",g.title="Show in slash command menu",d.style.textAlign="center",d.style.padding="12px 8px",d.style.borderBottom="2px solid var(--background-modifier-border)",d.style.fontWeight="600";let y=s.createEl("th");y.setText("Actions"),y.style.textAlign="center",y.style.padding="12px 8px",y.style.borderBottom="2px solid var(--background-modifier-border)",y.style.fontWeight="600";let T=e.createEl("tbody");[...this.commands].sort((h,b)=>h.order!==void 0&&b.order!==void 0?h.order-b.order:b.lastUsedMs-h.lastUsedMs).forEach((h,b)=>{let x=T.createEl("tr");x.style.borderBottom="1px solid var(--background-modifier-border)";let P=x.createEl("td");P.style.padding="12px 8px",P.style.textAlign="center",P.style.cursor="grab",P.style.color="var(--text-muted)",P.innerHTML="\u22EE\u22EE",P.setAttribute("aria-label","Drag to reorder");let C=x.createEl("td");C.style.padding="12px 8px",C.setText(h.title);let S=x.createEl("td");S.style.textAlign="center",S.style.padding="12px 8px";let w=S.createEl("input",{type:"checkbox"});w.checked=h.showInContextMenu!==!1,w.onclick=async V=>{V.stopPropagation(),h.showInContextMenu=w.checked,await this.saveCommand(h,h.title)};let D=x.createEl("td");D.style.textAlign="center",D.style.padding="12px 8px";let k=D.createEl("input",{type:"checkbox"});k.checked=h.showInSlashMenu!==!1,k.onclick=async V=>{V.stopPropagation(),h.showInSlashMenu=k.checked,await this.saveCommand(h,h.title)};let v=x.createEl("td");v.style.textAlign="center",v.style.padding="12px 8px",v.style.display="flex",v.style.gap="5px",v.style.justifyContent="center";let $=v.createEl("button",{text:"\u270F\uFE0F",attr:{"aria-label":"Edit"}});$.style.padding="4px 8px",$.onclick=()=>this.openCommandModal(h);let z=v.createEl("button",{text:"\u{1F4CB}",attr:{"aria-label":"Copy"}});z.style.padding="4px 8px",z.onclick=async()=>await this.copyCommand(h);let ve=v.createEl("button",{text:"\u{1F5D1}\uFE0F",attr:{"aria-label":"Delete"}});ve.style.padding="4px 8px",ve.onclick=async()=>{let V=new A.Modal(this.app);V.titleEl.setText("Delete Command / \u5220\u9664\u547D\u4EE4");let Q=V.contentEl.createDiv();Q.style.padding="20px 0",Q.innerHTML=`
                    <p style="margin-bottom: 15px;">
                        Delete command "<strong>${h.title}</strong>"? This will permanently remove the command file.<br>
                        <span style="color: var(--text-muted); font-size: 0.9em;">
                            \u786E\u5B9A\u8981\u5220\u9664\u547D\u4EE4 "<strong>${h.title}</strong>" \u5417\uFF1F\u8FD9\u5C06\u6C38\u4E45\u5220\u9664\u547D\u4EE4\u6587\u4EF6\u3002
                        </span>
                    </p>
                `;let ne=V.contentEl.createDiv();ne.style.display="flex",ne.style.justifyContent="flex-end",ne.style.gap="10px",ne.style.marginTop="20px";let pn=ne.createEl("button",{text:"Cancel / \u53D6\u6D88"});pn.onclick=()=>V.close();let un=ne.createEl("button",{text:"Delete / \u5220\u9664",cls:"mod-warning"});un.onclick=async()=>{V.close(),await this.deleteCommand(h)},V.open()}})}openCommandModal(t){let e=!t,n=t||{title:"",content:"",showInContextMenu:!0,showInSlashMenu:!0,order:this.commands.length,modelKey:"",lastUsedMs:Date.now()};new Lt(this.app,n,e,this.commands,async i=>{e?await this.createCommand(i):await this.saveCommand(i,t.title)}).open()}async createCommand(t){try{let e=this.customCommandsFolder,n=`${t.title}.md`,s=(0,A.normalizePath)(`${e}/${n}`);if(this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e),this.app.vault.getAbstractFileByPath(s)){new A.Notice("\u274C A command file with this name already exists");return}let r=`${this.buildFrontmatter(t)}
${t.content}`;await this.app.vault.create(s,r),new A.Notice(`\u2705 Command "${t.title}" created!`),await this.onUpdate();let l=this.customCommandManager.getAllCommands();this.commands=l,this.render()}catch(e){new A.Notice("\u274C Failed to create command: "+e.message),console.error("Create command error:",e)}}async saveCommand(t,e){try{let n=this.customCommandsFolder,s=(0,A.normalizePath)(`${n}/${e}.md`),i=(0,A.normalizePath)(`${n}/${t.title}.md`),a=this.app.vault.getAbstractFileByPath(s);if(!(a instanceof A.TFile)){new A.Notice("\u274C Command file not found");return}let r=`${this.buildFrontmatter(t)}
${t.content}`;await this.app.vault.modify(a,r),e!==t.title&&await this.app.vault.rename(a,i),new A.Notice(`\u2705 Command "${t.title}" updated!`),await this.onUpdate();let l=this.customCommandManager.getAllCommands();this.commands=l,this.render()}catch(n){new A.Notice("\u274C Failed to save command: "+n.message),console.error("Save command error:",n)}}async copyCommand(t){try{let e=1,n=`${t.title} (Copy)`;for(;this.commands.find(i=>i.title===n);)e++,n=`${t.title} (Copy ${e})`;let s={...t,title:n,lastUsedMs:Date.now()};await this.createCommand(s)}catch(e){new A.Notice("\u274C Failed to copy command: "+e.message),console.error("Copy command error:",e)}}async deleteCommand(t){try{let e=this.customCommandsFolder,n=(0,A.normalizePath)(`${e}/${t.title}.md`),s=this.app.vault.getAbstractFileByPath(n);if(s instanceof A.TFile){await this.app.vault.delete(s),new A.Notice(`\u2705 Command "${t.title}" deleted`),await this.onUpdate();let i=this.customCommandManager.getAllCommands();this.commands=i,this.render()}else new A.Notice("\u274C Command file not found")}catch(e){new A.Notice("\u274C Failed to delete command: "+e.message),console.error("Delete command error:",e)}}buildFrontmatter(t){let e=["---"];return t.showInContextMenu!==void 0&&e.push(`showInContextMenu: ${t.showInContextMenu}`),t.showInSlashMenu!==void 0&&e.push(`showInSlashMenu: ${t.showInSlashMenu}`),t.order!==void 0&&e.push(`order: ${t.order}`),t.modelKey&&e.push(`modelKey: ${t.modelKey}`),e.push("---"),e.join(`
`)}async generateDefaultCommands(){try{let t=this.customCommandsFolder;this.app.vault.getAbstractFileByPath(t)||await this.app.vault.createFolder(t);let n=[{title:"\u53E3\u8BED\u7EA0\u6B63\u4E13\u5BB6",content:`You are a spoken English correction expert. Please analyze the following text and:
1. Identify any grammar mistakes, unnatural expressions, or word choice issues
2. Provide corrected versions with explanations
3. Suggest more native-like alternatives
4. Point out any cultural or contextual improvements

Text to analyze:
{{selection}}

Please format your response as:
**Original Issues:**
- [list problems]

**Corrected Version:**
[corrected text]

**Suggestions:**
- [improvement suggestions]`,showInContextMenu:!0,showInSlashMenu:!0,order:0,modelKey:"",lastUsedMs:Date.now()},{title:"Explain Idioms",content:`Please explain any idioms, phrasal verbs, or colloquial expressions in the following text. For each expression, provide:
1. Literal meaning
2. Actual meaning
3. Example sentences
4. Chinese translation

Text:
{{selection}}`,showInContextMenu:!0,showInSlashMenu:!0,order:1,modelKey:"",lastUsedMs:Date.now()},{title:"Translate to Chinese",content:`Please translate the following English text to Chinese, keeping the translation natural and accurate:

{{selection}}`,showInContextMenu:!0,showInSlashMenu:!0,order:2,modelKey:"",lastUsedMs:Date.now()},{title:"Simplify",content:`Please rewrite the following text using simpler English suitable for intermediate learners:
- Use common vocabulary (B1-B2 level)
- Keep sentences clear and shorter
- Maintain the original meaning
- Add explanations for any difficult terms that must be kept

Original text:
{{selection}}`,showInContextMenu:!0,showInSlashMenu:!0,order:3,modelKey:"",lastUsedMs:Date.now()},{title:"Practice Questions",content:`Based on the following text, generate 5 comprehension questions and 5 vocabulary questions to help test understanding:

Text:
{{selection}}

Please format as:
**Comprehension Questions:**
1. [question]

**Vocabulary Questions:**
1. [question about word usage]`,showInContextMenu:!0,showInSlashMenu:!0,order:4,modelKey:"",lastUsedMs:Date.now()}],s=0;for(let i of n){let a=(0,A.normalizePath)(`${t}/${i.title}.md`);if(!this.app.vault.getAbstractFileByPath(a)){let l=`${this.buildFrontmatter(i)}
${i.content}`;await this.app.vault.create(a,l),s++}}if(s>0){new A.Notice(`\u2705 Generated ${s} default commands`),await this.onUpdate();let i=this.customCommandManager.getAllCommands();this.commands=i,this.render()}else new A.Notice("\u2139\uFE0F All default commands already exist")}catch(t){new A.Notice("\u274C Failed to generate defaults: "+t.message),console.error("Generate defaults error:",t)}}};at();var Pt=`---
title: {{title}}
date: {{date}}
cover: {{cover}}
url: {{url}}
langr-audio: 
langr-origin: {{channel}} - YouTube
langr: xxx
---

^^^article

{{transcript}}

^^^words

^^^notes`,dn=`Please format the following transcript text. You MUST follow these rules:
1. ADD PUNCTUATION: Insert periods, commas, question marks, etc. where appropriate.
2. PARAGRAPH BREAKS: Break into short paragraphs (every 2-4 sentences). Use double newlines (\\n\\n) between paragraphs.
3. CAPITALIZATION: Capitalize the first letter of each sentence.
4. NO CONTENT CHANGES: Do NOT change, add, or remove any words. Keep the original wording exactly as is.
5. NO EXPLANATIONS: Output ONLY the formatted text.

Input text:
{{text}}

Formatted text:`,os={hasCompletedSetup:!1,defaultLanguage:"en",targetLanguage:"zh",videoFolder:"01-Videos",assetsFolder:"Languages/Assets",subtitlesFolder:"02-Subtitles",thumbnailsFolder:"01-Videos",autoDownloadThumbnails:!0,generateBilingualTranscript:!0,enableAITranslation:!0,enableAIFormatting:!0,enableAISubtitles:!0,aiFormattingPrompt:dn,aiProvider:"deepseek",aiApiKey:"",aiModel:"deepseek-chat",aiBaseUrl:"https://api.deepseek.com/v1/chat/completions",aiPerformanceMode:"fast",enableVoice2Text:!0,sttProvider:"openai",sttApiKey:"",sttLanguage:"",sttModel:"whisper-1",sttBaseUrl:"https://api.openai.com/v1/audio/transcriptions",saveAudio:!0,audioFolder:"03-Recordings",audioFormat:"wav",audioFilenameTemplate:"Recording_{{date:YYYY-MM-DD}}_{{time:HH-mm-ss}}",recordOnlyMode:!1,enableTTS:!0,ttsProvider:"openai",ttsApiKey:"",ttsModel:"tts-1-hd",ttsVoice:"nova",ttsSpeed:1,ttsBaseUrl:"",ttsOutputFormat:"mp3",ttsShowPlayer:"always",ttsAutoscroll:!0,ttsCacheType:"local",ttsCacheDuration:168,ttsAudioFolder:"03-Resources/aloud",ttsChunking:"sentence",noteTemplate:Pt,credentials:[],customCommandsFolder:"03-Resources/copilot-custom-prompts",customCommandTemplating:!0,customCommandSortStrategy:"recency",customCommands:[],ribbonCommandId:"",ribbonCommandId2:"",enableVaultQA:!1,qaSearchFolders:[],qaExcludeFolders:[".obsidian"],qaMaxSources:5},st=class extends m.Plugin{constructor(){super(...arguments);this.isRecording=!1;this.recordingModal=null;this.ribbonIcon1=null;this.ribbonIcon2=null}async onload(){await this.loadSettings(),this.injectStyles(),this.recorder=new Ye,this.transcriptionService=new Ge(this.settings),this.ttsManager=new Xe(this.app,this.settings),this.registerEditorExtension(cn(this.ttsManager)),this.customCommandManager=new tt(this.app),this.app.workspace.onLayoutReady(async()=>{await this.loadCustomCommands(),console.log("[LinguaSync] Custom commands loaded on workspace ready"),await this.checkYtDlpInstallation()}),this.addRibbonIcon("video","Import YouTube Video",()=>{new we(this.app,async e=>{await this.importVideo(e)}).open()}),this.addCustomRibbonButton(),this.addRibbonIcon("microphone","Start Voice Recording",()=>{if(this.isRecording)this.recordingModal&&this.recordingModal.close();else{let e=this.app.workspace.getActiveViewOfType(m.MarkdownView);e?this.startRecording(e.editor,e):new m.Notice("Please open a Markdown note first.")}}),this.statusBarItem=this.addStatusBarItem(),this.statusBarItem.addClass("mod-clickable"),this.statusBarItem.setAttribute("aria-label","Start Voice Recording"),this.statusBarItem.setAttribute("title","Click to Start Recording"),this.statusBarItem.innerHTML="\u{1F399}",this.statusBarItem.addEventListener("click",()=>{if(this.isRecording)this.recordingModal&&this.recordingModal.close();else{let e=this.app.workspace.getActiveViewOfType(m.MarkdownView);e?this.startRecording(e.editor,e):new m.Notice("Please open a Markdown note first.")}}),this.addCommand({id:"start-voice-recording",name:"Start Voice Recording",hotkeys:[{modifiers:["Mod","Shift"],key:"r"}],editorCallback:(e,n)=>{this.startRecording(e,n)}}),this.addCommand({id:"tts-play-pause",name:"Aloud: Play/Pause",hotkeys:[{modifiers:["Mod"],key:"Space"}],editorCallback:e=>{let n=this.ttsManager.getState();n==="playing"?(this.ttsManager.pause(),new m.Notice("\u23F8 Paused")):n==="paused"?(this.ttsManager.resume(),new m.Notice("\u25B6 Resumed")):this.speakSelection(e)}}),this.addCommand({id:"tts-stop",name:"Aloud: Stop",hotkeys:[{modifiers:[],key:"Escape"}],callback:()=>{this.ttsManager.stop(),new m.Notice("\u23F9 Stopped")}}),this.addCommand({id:"tts-next-sentence",name:"Aloud: Next sentence",hotkeys:[{modifiers:["Mod"],key:"ArrowRight"}],callback:()=>{this.ttsManager.next(),new m.Notice("\u23ED Next sentence")}}),this.addCommand({id:"tts-previous-sentence",name:"Aloud: Previous sentence",hotkeys:[{modifiers:["Mod"],key:"ArrowLeft"}],callback:()=>{this.ttsManager.previous(),new m.Notice("\u23EE Previous sentence")}}),this.addCommand({id:"tts-increase-speed",name:"Aloud: Increase playback speed",hotkeys:[{modifiers:["Mod"],key:"ArrowUp"}],callback:()=>{let e=this.settings.ttsSpeed||1,n=Math.min(Math.round((e+.1)*20)/20,2.5);this.settings.ttsSpeed=n,this.ttsManager.setPlaybackSpeed(n),this.saveSettings(),new m.Notice(`\u26A1 Speed: ${n.toFixed(2)}x`)}}),this.addCommand({id:"tts-decrease-speed",name:"Aloud: Decrease playback speed",hotkeys:[{modifiers:["Mod"],key:"ArrowDown"}],callback:()=>{let e=this.settings.ttsSpeed||1,n=Math.max(Math.round((e-.1)*20)/20,.5);this.settings.ttsSpeed=n,this.ttsManager.setPlaybackSpeed(n),this.saveSettings(),new m.Notice(`\u26A1 Speed: ${n.toFixed(2)}x`)}}),this.addCommand({id:"tts-toggle-autoscroll",name:"Aloud: Toggle autoscroll",callback:()=>{this.settings.ttsAutoscroll=!this.settings.ttsAutoscroll,this.saveSettings();let e=this.settings.ttsAutoscroll?"\u{1F441}\uFE0F":"\u{1F6AB}",n=this.settings.ttsAutoscroll?"enabled":"disabled";new m.Notice(`${e} Autoscroll ${n}`)}}),this.addCommand({id:"tts-play-selection",name:"Aloud: Play selection",hotkeys:[{modifiers:["Mod","Shift"],key:"p"}],editorCallback:e=>{this.speakSelection(e)}}),this.addCommand({id:"tts-play-clipboard",name:"Aloud: Play from clipboard",callback:async()=>{try{let e=await navigator.clipboard.readText();if(e){let n={getCursor:()=>({line:0,ch:0}),posToOffset:s=>0,offsetToPos:s=>({line:0,ch:0}),scrollIntoView:()=>{}};this.ttsManager.playSelection(e,n,{line:0,ch:0},{line:0,ch:e.length})}else new m.Notice("Clipboard is empty")}catch(e){new m.Notice("Failed to read clipboard: "+e.message),console.error(e)}}}),this.addCommand({id:"tts-export-selection",name:"Aloud: Export selection to audio",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],editorCallback:async e=>{let n=e.getSelection();n?await this.exportTextToAudio(n,!1):new m.Notice("No text selected")}}),this.addCommand({id:"tts-paste-as-audio",name:"Aloud: Paste clipboard as audio",editorCallback:async e=>{try{let n=await navigator.clipboard.readText();n?await this.exportTextToAudio(n,!0,e):new m.Notice("Clipboard is empty")}catch(n){new m.Notice("Failed to read clipboard: "+n.message),console.error(n)}}}),this.registerEvent(this.app.workspace.on("editor-menu",(e,n,s)=>{if(this.settings.enableTTS&&(e.addItem(a=>{a.setTitle("Aloud: Play selection").setIcon("play").onClick(()=>{this.speakSelection(n)})}),e.addItem(a=>{a.setTitle("Aloud: Paste text to audio").setIcon("clipboard").onClick(async()=>{try{let o=await navigator.clipboard.readText();o?await this.exportTextToAudio(o,!0):new m.Notice("Clipboard is empty")}catch(o){new m.Notice("Failed to read clipboard: "+o.message),console.error(o)}})}),e.addItem(a=>{a.setTitle("Aloud: Export selection to audio").setIcon("file-audio").onClick(async()=>{let o=n.getSelection();o?await this.exportTextToAudio(o,!1):new m.Notice("No text selected")})})),!this.customCommandManager){console.error("[LinguaSync] customCommandManager not initialized");return}let i=this.customCommandManager.getContextMenuCommands();i.length>0&&e.addItem(a=>{a.setTitle("English Learner"),a.setIcon("languages"),a.setSubmenu();let o=a.submenu;if(!o){console.error("[LinguaSync] Failed to create submenu");return}i.forEach(r=>{o.addItem(l=>{l.setTitle(r.title).onClick(async()=>{await this.executeCustomCommand(r,n)})})})})})),this.addCommand({id:"import-youtube-video",name:"Import YouTube Video",hotkeys:[{modifiers:["Mod","Shift"],key:"y"}],callback:()=>{new we(this.app,async e=>{await this.importVideo(e)}).open()}}),this.addCommand({id:"initialize-knowledge-base",name:"Initialize Knowledge Base",callback:async()=>{await this.initializeKnowledgeBase()}}),this.addCommand({id:"debug-test-metadata",name:"[DEBUG] Test Metadata Extraction",callback:()=>{new we(this.app,async e=>{try{new m.Notice("Testing metadata extraction..."),console.log(`
\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550`),console.log("[DEBUG] Testing metadata extraction for:",e),console.log(`\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
`);let{YouTubeScraper:n}=await Promise.resolve().then(()=>(ot(),Ft)),s=n.extractVideoId(e);if(console.log("[DEBUG] Video ID:",s),!s){new m.Notice("Invalid YouTube URL");return}let i=`https://www.youtube.com/watch?v=${s}`,a=await(0,m.requestUrl)({url:i,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",DNT:"1",Connection:"keep-alive","Upgrade-Insecure-Requests":"1"}});console.log("[DEBUG] HTML fetched, length:",a.text.length),console.log(`
--- Calling extractMetadata() ---
`);let o=n.extractMetadata(a.text,s);console.log(`
--- Result ---`),console.log("Title:",o.title),console.log("Author:",o.author),console.log("Duration:",o.duration),console.log(`\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
`),new m.Notice(`Title: ${o.title}`)}catch(n){console.error("[DEBUG] Test failed:",n),new m.Notice(`Test failed: ${n.message}`)}}).open()}}),this.addSettingTab(new Dt(this.app,this))}async checkYtDlpInstallation(){try{if(await q.isYtDlpInstalled()){let n=await q.getVersion();return console.log(`[LinguaSync] \u2705 yt-dlp detected: v${n}`),this.settings.hasCompletedSetup||(this.settings.hasCompletedSetup=!0,await this.saveSettings()),{installed:!0,version:n}}else return console.warn("[LinguaSync] \u26A0\uFE0F yt-dlp not installed"),this.settings.hasCompletedSetup||new it(this.app,async n=>{n&&(this.settings.hasCompletedSetup=!0,await this.saveSettings())}).open(),{installed:!1}}catch(e){return console.error("[LinguaSync] Failed to check yt-dlp:",e),{installed:!1}}}async startRecording(e,n){if(!this.settings.enableVoice2Text){new m.Notice("Please enable Voice to Text in settings first.");return}try{await this.recorder.startRecording(this.settings.audioFormat);let s=this.recorder.getStream();if(!s){new m.Notice("Failed to access microphone stream.");return}this.isRecording=!0,this.statusBarItem.innerHTML="\u23F9",this.statusBarItem.setAttribute("aria-label","Stop Recording"),this.statusBarItem.setAttribute("title","Click to Stop Recording"),this.recordingModal=new Je(this.app,async i=>{var a;if(this.isRecording=!1,this.statusBarItem.innerHTML="\u{1F399}",this.statusBarItem.setAttribute("aria-label","Start Voice Recording"),this.statusBarItem.setAttribute("title","Click to Start Recording"),this.recordingModal=null,i){this.recorder.cleanup();return}new m.Notice("Processing audio...");try{let o=await this.recorder.stopRecording(),r="";if(this.settings.saveAudio)try{r=`![[${await this.saveAudioFile(o,(a=n==null?void 0:n.file)==null?void 0:a.basename)}]]
`}catch(u){console.error("Failed to save audio file:",u),new m.Notice("Failed to save audio file: "+u.message)}let l="";if(this.settings.recordOnlyMode)new m.Notice("\u2705 Audio saved! (Record-only mode, no transcription)");else{let u=new m.Notice("Transcribing audio... \u23F3",0);try{l=await this.transcriptionService.transcribe(o,this.settings.audioFormat),u.hide(),new m.Notice("\u2705 Transcription complete!")}catch(g){u.hide(),new m.Notice("\u274C Transcription failed: "+g.message),console.error(g)}}let d=`${r}${l?l+`

`:""}`;d&&e.replaceRange(d,e.getCursor())}catch(o){new m.Notice("Error processing recording: "+o.message),console.error(o)}},()=>this.recorder.pauseRecording(),()=>this.recorder.resumeRecording(),s),this.recordingModal.open()}catch(s){new m.Notice("Failed to start recording: "+s.message),console.error(s),this.isRecording=!1}}async speakSelection(e){if(!this.settings.enableTTS){new m.Notice("Please enable Text to Speech in settings first.");return}let n=e.getSelection();if(!n){new m.Notice("Please select some text to speak.");return}if(n.length>4096){new m.Notice("Text too long (max 4096 chars).");return}let s=e.getCursor("from"),i=e.getCursor("to");try{await this.ttsManager.playSelection(n,e,s,i)}catch(a){new m.Notice("TTS Failed: "+a.message),console.error(a)}}async exportTextToAudio(e,n=!1,s){var h;if(!this.settings.enableTTS){new m.Notice("Please enable Text to Speech in settings first.");return}if(!e||e.trim().length===0){new m.Notice("No text to export.");return}let i=e.replace(/\s/g,"-").replace(/[^a-zA-Z0-9_-]/g,"").slice(0,20).replace(/-+$/,"")||"audio",a=0;for(let b=0;b<e.length;b++)a=(a<<5)-a+e.charCodeAt(b),a=a&a;let o=Math.abs(a).toString(16),r="mp3";if(this.settings.ttsProvider==="azure"&&this.settings.ttsOutputFormat){let b=this.settings.ttsOutputFormat.toLowerCase();b.includes("riff")||b.includes("pcm")||b.includes("wav")?r="wav":b.includes("mp3")?r="mp3":b.includes("ogg")||b.includes("opus")?r="ogg":b.includes("webm")&&(r="webm")}let l=this.settings.ttsAudioFolder||"03-Resources/aloud",d=`${i}-${o}.${r}`,u=`${l}/${d}`,g=s||((h=this.app.workspace.getActiveViewOfType(m.MarkdownView))==null?void 0:h.editor),y=`![[${u}]]
`,T=`<loading file="${u}" />
`;g&&(n?g.replaceSelection(T):g.replaceRange(T,g.getCursor("from"),g.getCursor("from")));let f=b=>{if(g){let x=g.getValue(),P=T.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),C=x.match(new RegExp(P));if(C){let S=x.indexOf(C[0]),w=S+C[0].length;g.replaceRange(b,g.offsetToPos(S),g.offsetToPos(w))}}};try{new m.Notice(`Exporting ${d}, this may take some time`);let b=this.settings.ttsProvider||"openai",x;if(b==="openai"||b==="custom")x=await this.ttsManager.speakOpenAI(e);else if(b==="azure")x=await this.ttsManager.speakAzure(e);else if(b==="elevenlabs")x=await this.ttsManager.speakElevenLabs(e);else throw new Error(`Provider ${b} not supported for export`);await this.app.vault.adapter.mkdir(l),await this.app.vault.adapter.writeBinary(u,x),f(y),new m.Notice(`Exported ${d}`)}catch(b){new m.Notice("Export failed: "+b.message),console.error(b),f("")}}async saveAudioFile(e,n){let s=this.settings.audioFolder||"recordings",i=this.settings.audioFormat||"wav",o=this.settings.audioFilenameTemplate||"Recording_{{date:YYYY-MM-DD}}_{{time:HH-mm-ss}}";o=o.replace(/{{title}}/g,n||"Untitled"),o=o.replace(/{{timestamp}}/g,Date.now().toString());let r=window.moment();o=o.replace(/{{date:(.*?)}}/g,(g,y)=>r.format(y)),o=o.replace(/{{time:(.*?)}}/g,(g,y)=>r.format(y)),o=o.replace(/{{date}}/g,r.format("YYYY-MM-DD")),o=o.replace(/{{time}}/g,r.format("HH-mm-ss")),o=o.replace(/[\\/:"*?<>|]/g,"");let l=`${s}/${o}.${i}`;if(!this.app.vault.getAbstractFileByPath(s))try{await this.app.vault.createFolder(s)}catch(g){if(!g.message||!g.message.includes("Folder already exists"))throw g}let u=await e.arrayBuffer();return await this.app.vault.createBinary(l,u),l}async importVideo(e){var i,a;let s=new De(6);try{s.setProgress(0,"Extracting video ID...");let o=Y.extractVideoId(e);if(!o)throw new Error("Invalid YouTube URL");s.setProgress(5,"Video ID extracted");let l=await this.findExistingNote(e,o)!==null;l&&(console.log("[LinguaSync] \u{1F504} Video already imported, updating note only..."),s.updateMessage("Video already exists, updating...")),s.setProgress(10,"Fetching English subtitles..."),console.log("[LinguaSync] \u{1F4E5} Fetching English subtitles...");let d=await Y.fetchVideoData(e,void 0);if(s.setProgress(20,"Subtitles fetched"),console.log(`[LinguaSync] \u2705 Got ${d.transcript.length} transcript lines`),this.settings.enableAIFormatting&&this.settings.aiApiKey&&((a=(i=d.transcript[0])==null?void 0:i.lang)!=null&&a.startsWith("en"))){s.setProgress(25,"AI formatting transcript..."),console.log("[LinguaSync] \u{1F916} AI formatting transcript (sync - required for learning)...");try{let{AITranslator:T}=await Promise.resolve().then(()=>(ye(),Ae)),f=new T({provider:this.settings.aiProvider,apiKey:this.settings.aiApiKey,model:this.settings.aiModel,baseUrl:this.settings.aiBaseUrl,performanceMode:this.settings.aiPerformanceMode}),h=this.settings.aiFormattingPrompt||void 0;d.formattedTranscriptText=await f.formatTranscript(d.transcript,h),s.setProgress(55,"AI formatting completed"),console.log(`[LinguaSync] \u2705 AI formatting completed (${d.formattedTranscriptText.length} chars)`)}catch(T){console.error("[LinguaSync] AI formatting failed:",T),new m.Notice(`AI formatting failed: ${T.message}. Using default format.`)}}s.setProgress(60,"Creating note..."),console.log("[LinguaSync] \u{1F4DD} Creating note with formatted English content...");let u=new ke(this.app,this.settings),g=await u.createVideoNote(d,l,!0);s.setProgress(90,"Opening note..."),l?s.success(`\u2705 Updated: ${g.basename}`):s.success(`\u2705 Created: ${g.basename}`),await this.app.workspace.getLeaf(!1).openFile(g),console.log("[LinguaSync] \u2705 Note ready for learning with Language Learner!"),this.processInBackground(d,u)}catch(o){s.error(o.message),console.error("Import failed:",o)}}async processInBackground(e,n){let s=n.getFileName(e.metadata.title),i=e.metadata.title.substring(0,30);console.log("[LinguaSync] \u{1F504} Starting background processing...");try{if(!e.translatedTranscript&&this.settings.enableAITranslation&&this.settings.aiApiKey){console.log("[LinguaSync] \u{1F504} Background: Performing AI translation..."),new m.Notice(`\u{1F504} \u5F00\u59CB\u7FFB\u8BD1\u5B57\u5E55: ${i}...`,3e3);let{AITranslator:o}=await Promise.resolve().then(()=>(ye(),Ae)),r=new o({provider:this.settings.aiProvider,apiKey:this.settings.aiApiKey,model:this.settings.aiModel,baseUrl:this.settings.aiBaseUrl,performanceMode:this.settings.aiPerformanceMode}),l=Date.now();e.translatedTranscript=await r.translateTranscript(e.transcript,(u,g,y)=>{let T=(Date.now()-l)/1e3,f=T/u*g,h=Math.max(0,f-T);new m.Notice(`\u{1F504} \u7FFB\u8BD1\u4E2D: ${u}/${g} (${Math.round(y)}%) | \u5269\u4F59 ~${Math.round(h)}\u79D2`,2500)});let d=Math.round((Date.now()-l)/1e3);console.log(`[LinguaSync] \u2705 Background translation completed: ${e.translatedTranscript.length} lines in ${d}s`),new m.Notice(`\u2705 \u7FFB\u8BD1\u5B8C\u6210! \u7528\u65F6 ${d}\u79D2`,3e3)}console.log("[LinguaSync] \u{1F504} Background: Generating SRT files..."),new m.Notice("\u{1F4DD} \u6B63\u5728\u751F\u6210\u5B57\u5E55\u6587\u4EF6...",2e3),await n.ensureSRTFiles(e.transcript,e.translatedTranscript,s),new m.Notice(`\u{1F389} \u5B57\u5E55\u6587\u4EF6\u5DF2\u751F\u6210: ${i}...`,5e3),console.log("[LinguaSync] \u2705 Background processing completed!")}catch(a){console.error("[LinguaSync] \u274C Background processing failed:",a),new m.Notice(`\u26A0\uFE0F \u540E\u53F0\u5904\u7406\u5931\u8D25: ${a.message}`,8e3)}}async findExistingNote(e,n){let s=this.settings.videoFolder,i=this.app.vault.getMarkdownFiles();for(let a of i){if(!a.path.startsWith(s))continue;let r=(await this.app.vault.read(a)).match(/^url:\s*(.+)$/m);if(r){let l=r[1].trim();if(this.normalizeVideoUrl(l)===this.normalizeVideoUrl(e))return console.log(`[LinguaSync] Found existing note: ${a.basename}`),a}}return null}normalizeVideoUrl(e){return Y.extractVideoId(e)||e}async fetchVideoDataWithProgress(e,n,s){return s.setProgress(10,"Fetching video data..."),await Y.fetchVideoData(e,n)}async initializeKnowledgeBase(){let e=new m.Notice("Initializing Knowledge Base...",0);try{await new Pe(this.app).initializeKnowledgeBase("Languages"),e.hide(),new m.Notice("\u2705 Knowledge Base initialized!")}catch(n){e.hide(),new m.Notice(`\u274C Error: ${n.message}`),console.error("Initialization failed:",n)}}onunload(){let e=document.getElementById("ls-mac-styles");e&&e.remove()}async loadSettings(){this.settings=Object.assign({},os,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.transcriptionService.updateSettings(this.settings)}async loadCustomCommands(){try{console.log("[Custom Commands] Loading from folder:",this.settings.customCommandsFolder);let e=await this.customCommandManager.loadCommandsFromFolder(this.settings.customCommandsFolder);console.log("[Custom Commands] Loaded",e.length,"commands:",e.map(n=>n.title)),this.settings.customCommands=e,this.customCommandManager.setCustomCommands(e),!this.settings.ribbonCommandId&&e.length>0&&(this.settings.ribbonCommandId=`custom-${e[0].title}`,await this.saveSettings(),console.log("[Custom Commands] Set default ribbon command to:",e[0].title))}catch(e){console.error("Failed to load custom commands:",e),new m.Notice("\u26A0\uFE0F Failed to load custom commands. Check console for details.")}}async executeCustomCommand(e,n){let s=n.getSelection()||"";if(!s){new m.Notice("\u26A0\uFE0F Please select some text first");return}let i=this.customCommandManager.executeCommand(e.title,s);if(!this.settings.aiApiKey||!this.settings.aiApiKey.trim()){new m.Notice("\u274C AI API Key not configured. Please set it in Settings \u2192 AI.");return}let a=new m.Notice(`\u23F3 ${e.title}...`,0);try{let{AITranslator:o}=await Promise.resolve().then(()=>(ye(),Ae)),r=new o({provider:this.settings.aiProvider,apiKey:this.settings.aiApiKey,model:this.settings.aiModel,baseUrl:this.settings.aiBaseUrl,performanceMode:this.settings.aiPerformanceMode}),l=`${s}

`,d=n.getCursor();n.replaceSelection(l);let u=n.getDoc(),g=l.split(`
`).length-1,y={line:d.line+g,ch:0};n.setCursor(y),a.hide(),new m.Notice(`\u{1F916} ${e.title} streaming...`),await r.callAIStream(i,T=>{let f=n.getCursor();n.replaceRange(T,f);let h=T.split(`
`),b=h[h.length-1].length,x={line:f.line+h.length-1,ch:h.length===1?f.ch+b:b};n.setCursor(x)}),new m.Notice(`\u2705 ${e.title} completed`)}catch(o){console.error("AI generation error:",o),a.hide(),new m.Notice(`\u274C Error: ${o.message}`)}}getAvailableCommands(){let e=[];return this.customCommandManager&&this.settings.customCommands&&this.settings.customCommands.forEach(n=>{e.push({id:`custom-${n.title}`,name:n.title,icon:"zap"})}),e.length===0&&e.push({id:"import-youtube-video",name:"Import YouTube Video",icon:"video"},{id:"start-voice-recording",name:"Start Voice Recording",icon:"microphone"}),e}addCustomRibbonButton(){this.ribbonIcon1=this.createRibbonButton(this.settings.ribbonCommandId,"zap","Quick Action 1"),this.ribbonIcon2=this.createRibbonButton(this.settings.ribbonCommandId2,"star","Quick Action 2")}createRibbonButton(e,n,s){if(!e)return null;if(e.startsWith("custom-")){let i=e.replace("custom-",""),a=this.settings.customCommands.find(o=>o.title===i);if(a)return this.addRibbonIcon(n,`${s}: ${a.title}`,async()=>{let o=this.app.workspace.getActiveViewOfType(m.MarkdownView);o&&o.editor?await this.executeCustomCommand(a,o.editor):new m.Notice("\u26A0\uFE0F Please open a note to use this command")})}else{let a=[{id:"import-youtube-video",name:"Import YouTube Video",icon:"video"},{id:"start-voice-recording",name:"Start Voice Recording",icon:"microphone"}].find(o=>o.id===e);if(a)return this.addRibbonIcon(n,`${s}: ${a.name}`,()=>{this.app.commands.executeCommandById(a.id)})}return null}updateRibbonButton(e,n){e===1?(this.ribbonIcon1&&this.ribbonIcon1.remove(),this.settings.ribbonCommandId=n,this.ribbonIcon1=this.createRibbonButton(n,"zap","Quick Action 1")):(this.ribbonIcon2&&this.ribbonIcon2.remove(),this.settings.ribbonCommandId2=n,this.ribbonIcon2=this.createRibbonButton(n,"star","Quick Action 2"))}injectStyles(){let e=document.getElementById("ls-mac-styles");e&&e.remove();let n=document.createElement("style");n.id="ls-mac-styles",n.textContent=`
			/* === Apple Style Settings UI === */
			/* Variables */
			:root {
				--ls-color-primary: #007AFF; /* Apple Blue */
				--ls-color-success: #34C759; /* Apple Green */
				--ls-color-warning: #FF9500; /* Apple Orange */
				--ls-color-danger: #FF3B30;  /* Apple Red */
				--ls-bg-card: var(--background-primary);
				--ls-bg-page: var(--background-secondary);
				--ls-border-color: var(--background-modifier-border);
				--ls-text-primary: var(--text-normal);
				--ls-text-secondary: var(--text-muted);
				--ls-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
				--ls-radius-lg: 10px;
				--ls-radius-md: 8px;
				--ls-radius-sm: 6px;
			}

			/* Reset & Base */
			.ls-header, .ls-tab-nav, .ls-tab-content {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			}

			/* === Header === */
			.ls-header { 
				text-align: center;
				margin-bottom: 32px; 
				padding: 24px 20px 16px;
				background: transparent;
			}
			.ls-title { 
				font-size: 24px; 
				font-weight: 600; 
				margin-bottom: 0;
				color: var(--ls-text-primary);
				letter-spacing: -0.02em;
			}

			/* === Tab Navigation (Segmented Control Style) === */
			.ls-tab-nav {
				display: flex;
				justify-content: center;
				background: var(--background-modifier-form-field);
				border-radius: 8px;
				padding: 2px;
				margin: 0 auto 32px;
				width: fit-content;
				max-width: 100%;
				overflow-x: auto;
			}
			
			.ls-tab-item {
				cursor: pointer;
				padding: 6px 16px;
				border-radius: 6px;
				font-size: 13px;
				font-weight: 500;
				color: var(--ls-text-secondary);
				transition: all 0.2s ease;
				white-space: nowrap;
				user-select: none;
				border: none; /* Removed bottom border */
				margin: 0;    /* Removed margin */
			}
			
			.ls-tab-item:hover {
				color: var(--ls-text-primary);
			}
			
			.ls-tab-item.is-active {
				background: var(--background-primary);
				color: var(--ls-text-primary);
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
				font-weight: 600;
			}
			
			/* Removed bilingual labels structure */
			.ls-tab-label-en { display: none; } 
			.ls-tab-label-cn { font-size: 13px; }

			/* === Content Area === */
			.ls-tab-content {
				max-width: 720px; /* Optimal reading width */
				margin: 0 auto;
				padding: 0 16px;
			}
			
			.ls-section {
				margin-bottom: 32px;
			}
			
			/* Section Title (Group Label) */
			.ls-section-title {
				font-size: 13px;
				font-weight: 500;
				color: var(--ls-text-secondary);
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin: 0 0 8px 12px;
				padding: 0;
				border: none; /* Removed left border */
			}
			
			/* Card (Settings Group) */
			.ls-card {
				background: var(--ls-bg-card);
				border-radius: var(--ls-radius-lg);
				border: 1px solid var(--ls-border-color);
				overflow: hidden;
				margin-bottom: 24px;
			}
			
			/* Card Title - Removed (Use Section Title instead) */
			.ls-card-title {
				display: none; 
			}

			/* Setting Item */
			.ls-card .setting-item {
				border-bottom: 1px solid var(--ls-border-color);
				padding: 14px 16px;
			}
			
			.ls-card .setting-item:last-child {
				border-bottom: none;
			}

			.ls-card .setting-item-info {
				margin-right: 12px;
				min-width: 0;
				flex: 1;
			}

			.ls-card .setting-item-name {
				font-size: 15px;
				font-weight: 400;
				color: var(--ls-text-primary);
				word-wrap: break-word;
			}

			.ls-card .setting-item-description {
				font-size: 12px;
				color: var(--ls-text-secondary);
				margin-top: 4px;
				line-height: 1.4;
				word-wrap: break-word;
				white-space: normal;
			}

			/* Inputs & Controls */
			.ls-card input[type="text"], 
			.ls-card select, 
			.ls-card textarea {
				background: var(--background-modifier-form-field);
				border: 1px solid transparent;
				border-radius: 6px;
				padding: 6px 10px;
				font-size: 14px;
				transition: all 0.2s ease;
			}

			.ls-card input[type="text"] {
				min-width: 260px !important;
				max-width: 100%;
			}

			.ls-card select {
				min-width: 400px !important;
				max-width: 100%;
				width: auto !important;
				padding: 8px 30px 8px 10px !important;
				line-height: 1.6 !important;
				height: auto !important;
			}

			.ls-card textarea {
				min-width: 260px !important;
				max-width: 100%;
			}

			/* Exception for Property Manager */
			.ls-card .ls-property-row input[type="text"] {
				min-width: 50px;
			}

			.ls-card input[type="text"]:focus, 
			.ls-card select:focus, 
			.ls-card textarea:focus {
				border-color: var(--ls-color-primary);
				outline: none;
			}

			/* Buttons */
			button.mod-cta {
				background-color: var(--ls-color-primary);
				font-weight: 500;
			}
			
			button:not(.mod-cta) {
				background-color: var(--background-modifier-form-field);
			}

			/* Status Badges */
			.ls-status-badge {
				display: inline-flex;
				align-items: center;
				gap: 4px;
				padding: 2px 8px;
				border-radius: 12px; /* Pill shape */
				font-size: 11px;
				font-weight: 500;
				margin-left: 8px;
				background: var(--background-secondary);
			}
			.ls-status-dot {
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background-color: currentColor;
			}
			.ls-status-configured { color: var(--color-green); border-color: var(--color-green); }
			.ls-status-warning { color: var(--color-orange); border-color: var(--color-orange); }
			.ls-status-not-set { color: var(--color-red); border-color: var(--color-red); }

			/* === Animations === */
			/* Removed animations for minimal feel */


			/* === TTS Player Panel (Aloud Style) === */
			.tts-toolbar {
				display: flex;
				width: 100%;
				padding: 8px 12px;
				background: var(--background-secondary);
				border-bottom: 1px solid var(--background-modifier-border);
				z-index: 1000;
			}
			
			.tts-toolbar-player {
				display: flex;
				flex-direction: row;
				align-items: center;
				gap: 8px;
				width: 100%;
			}
			
			.tts-toolbar-player-button-group {
				display: flex;
				flex-direction: row;
				align-items: center;
				gap: 4px;
			}
			
			.tts-toolbar-button {
				display: flex;
				align-items: center;
				justify-content: center;
				width: 28px;
				height: 28px;
				padding: 4px;
				border-radius: 4px;
				background: transparent;
				border: none;
				cursor: pointer;
				transition: all 0.2s ease;
			}
			
			.tts-toolbar-button.tts-toolbar-button-active {
				color: var(--interactive-accent);
			}
			
			.tts-toolbar-button:not(.tts-toolbar-button-active) {
				color: var(--text-muted);
			}
			
			.tts-toolbar-button:hover {
				color: var(--interactive-accent) !important;
				background: var(--background-modifier-hover);
			}
			
			.tts-toolbar-button.is-disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			
			.tts-toolbar-button.speed {
				font-size: 11px;
				font-weight: 600;
				width: auto;
				min-width: 40px;
				padding: 4px 8px;
			}
			
			.tts-audio-status-container {
				flex: 1 1 auto;
				display: flex;
				overflow: hidden;
				align-items: center;
				justify-content: center;
				font-size: var(--font-ui-small);
				color: var(--text-muted);
				min-width: 60px;
			}
			
			.tts-progress-bar-container {
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				height: 2px;
				background: var(--background-modifier-border);
			}
			
			.tts-progress-bar-fill {
				height: 100%;
				background: var(--interactive-accent);
				transition: width 0.3s ease;
			}

			/* Loading Spinner */
			.tts-spin {
				animation: tts-spin 1s linear infinite;
			}

			@keyframes tts-spin {
				from { transform: rotate(0deg); }
				to { transform: rotate(360deg); }
			}
			
			.tts-audio-status-loading {
				display: flex;
				justify-content: center;
				align-items: center;
			}

			/* Audio Visualizer */
			.tts-audio-visualizer {
				display: flex;
				justify-content: space-between;
				align-items: center;
				width: 100%;
				max-width: 2rem;
				height: 80%;
			}
			
			.tts-audio-visualizer-bar {
				background-color: var(--icon-color);
				border-radius: 10px;
				width: 6%;
				transition: height 0.04s linear;
			}

			/* === Voice Recording Modal === */
			.voice2text-modeless-container {
				pointer-events: none;
			}
			
			.recording-modal {
				width: 300px;
				max-width: 90vw;
				border-radius: 12px;
				box-shadow: 0 8px 24px rgba(0,0,0,0.3);
			}
			
			.voice2text-modal-container {
				padding: 16px;
				background: var(--background-primary);
			}
			
			.voice2text-waveform-container {
				margin-bottom: 12px;
				background: #1a1a1a;
				border-radius: 8px;
				overflow: hidden;
			}
			
			.voice2text-waveform {
				display: block;
				width: 100%;
				height: 60px;
			}
			
			.voice2text-timer {
				text-align: center;
				font-size: 16px;
				font-weight: 600;
				margin-bottom: 12px;
				color: var(--text-normal);
			}
			
			.voice2text-controls {
				display: flex;
				justify-content: center;
				gap: 8px;
			}
			
			.voice2text-button {
				width: 48px;
				height: 48px;
				border-radius: 8px;
				border: none;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.2s ease;
				color: white;
			}
			
			.voice2text-button:hover {
				transform: scale(1.05);
				box-shadow: 0 4px 12px rgba(0,0,0,0.2);
			}
			
			.voice2text-button:active {
				transform: scale(0.95);
			}
			
			.voice2text-button svg {
				width: 24px;
				height: 24px;
			}
			
			.voice2text-transcription {
				margin-top: 12px;
				padding: 12px;
				background: var(--background-secondary);
				border-radius: 8px;
				font-size: 14px;
				line-height: 1.5;
				max-height: 200px;
				overflow-y: auto;
			}
			
			.voice2text-transcribing {
				margin-top: 12px;
				padding: 12px;
				text-align: center;
				font-size: 14px;
				color: var(--text-muted);
			}
			
			.voice2text-transcribing-text {
				margin-right: 4px;
			}
			
			.voice2text-transcribing-dots span {
				animation: voice2text-blink 1.4s infinite;
			}
			
			.voice2text-transcribing-dots span:nth-child(2) {
				animation-delay: 0.2s;
			}
			
			.voice2text-transcribing-dots span:nth-child(3) {
				animation-delay: 0.4s;
			}

			@keyframes voice2text-blink {
				0%, 60%, 100% { opacity: 0; }
				30% { opacity: 1; }
			}
		`,document.head.appendChild(n)}},we=class extends m.Modal{constructor(e,n){super(e);this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Import YouTube Video"});let s=e.createDiv().createEl("input",{type:"text",placeholder:"https://youtu.be/... or https://www.youtube.com/watch?v=..."});s.style.width="100%",s.style.padding="8px",s.style.marginBottom="12px";let i=e.createDiv();i.style.display="flex",i.style.justifyContent="flex-end",i.style.gap="8px",i.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close());let o=i.createEl("button",{text:"Import",cls:"mod-cta"});o.addEventListener("click",()=>{let r=s.value.trim();r?(this.onSubmit(r),this.close()):new m.Notice("Please enter a YouTube URL")}),s.addEventListener("keypress",r=>{r.key==="Enter"&&o.click()}),setTimeout(()=>s.focus(),100)}onClose(){let{contentEl:e}=this;e.empty()}},Dt=class extends m.PluginSettingTab{constructor(e,n){super(e,n);this.activeTab="general";this.saveAndNotify=async()=>{await this.plugin.saveSettings(),new m.Notice("Settings saved / \u8BBE\u7F6E\u5DF2\u4FDD\u5B58")};this.debouncedSave=(0,m.debounce)(async()=>{await this.plugin.saveSettings(),new m.Notice("Settings saved / \u8BBE\u7F6E\u5DF2\u4FDD\u5B58")},1e3,!0);this.plugin=n}createBilingualLabel(e,n){return n}humanFileSize(e){if(e===0)return"0 B";let n=Math.floor(Math.log(e)/Math.log(1024)),s=["B","KB","MB","GB","TB"];return(e/Math.pow(1024,n)).toFixed(2)+" "+s[n]}getAIStatus(){let{aiApiKey:e,aiProvider:n,aiModel:s}=this.plugin.settings;return e?!n||!s?{status:"warning",message:"Incomplete Setup"}:{status:"configured",message:"Ready"}:{status:"not-set",message:"API Key Required"}}getTTSStatus(){let{ttsProvider:e,ttsApiKey:n}=this.plugin.settings;return e?(e==="openai"||e==="azure"||e==="elevenlabs"||e==="custom")&&!n&&!this.plugin.settings.aiApiKey?{status:"warning",message:"API Key Missing"}:{status:"configured",message:"Ready"}:{status:"not-set",message:"Provider Not Set"}}getSTTStatus(){let{sttProvider:e,sttApiKey:n}=this.plugin.settings;return e?e==="openai"&&!n&&!this.plugin.settings.aiApiKey?{status:"warning",message:"API Key Missing"}:e!=="openai"&&!n?{status:"warning",message:"API Key Missing"}:{status:"configured",message:"Ready"}:{status:"not-set",message:"Provider Not Set"}}createStatusBadge(e,n){let s=document.createElement("span");s.className=`ls-status-badge ls-status-${e}`;let i=s.createEl("span",{cls:"ls-status-dot"});return s.createEl("span",{text:n}),s}async display(){let{containerEl:e}=this;e.empty(),e.createDiv({cls:"ls-header"}).createEl("h1",{text:"OB English Learner",cls:"ls-title"});let s=e.createDiv({cls:"ls-tab-nav"});[{id:"content",label:"Content",labelCn:"\u5185\u5BB9\u914D\u7F6E"},{id:"ai",label:"AI",labelCn:"\u667A\u80FD\u670D\u52A1"},{id:"audio",label:"Audio",labelCn:"\u97F3\u9891\u8BBE\u7F6E"},{id:"commands",label:"Commands",labelCn:"\u5FEB\u6377\u547D\u4EE4"},{id:"advanced",label:"Advanced",labelCn:"\u9AD8\u7EA7\u9009\u9879"}].forEach(o=>{let r=s.createDiv({cls:`ls-tab-item ${this.activeTab===o.id?"is-active":""}`});r.textContent=o.labelCn,r.onclick=()=>{this.activeTab=o.id,this.display()}});let a=e.createDiv({cls:"ls-tab-content"});switch(this.activeTab){case"content":this.renderContent(a);break;case"ai":this.renderAI(a);break;case"audio":this.renderAudio(a);break;case"commands":await this.renderCommands(a);break;case"advanced":this.renderAdvanced(a);break;default:this.activeTab==="general"||this.activeTab==="video"?(this.activeTab="content",this.renderContent(a)):this.activeTab==="voice"?(this.activeTab="audio",this.renderAudio(a)):(this.activeTab==="template"||this.activeTab==="account")&&(this.activeTab="advanced",this.renderAdvanced(a));break}}renderContent(e){e.createEl("div",{text:"\u901A\u7528\u8BBE\u7F6E",cls:"ls-section-title"});let n=e.createDiv({cls:"ls-card"});new m.Setting(n).setName("\u9ED8\u8BA4\u8BED\u8A00").setDesc("\u89C6\u9891\u5B57\u5E55\u7684\u9ED8\u8BA4\u8BED\u8A00").addDropdown(a=>a.addOption("en","\u82F1\u8BED (English)").addOption("zh","\u4E2D\u6587").addOption("zh-CN","\u7B80\u4F53\u4E2D\u6587").addOption("zh-TW","\u7E41\u4F53\u4E2D\u6587").addOption("ja","\u65E5\u8BED").addOption("ko","\u97E9\u8BED").addOption("es","\u897F\u73ED\u7259\u8BED").addOption("fr","\u6CD5\u8BED").addOption("de","\u5FB7\u8BED").addOption("ru","\u4FC4\u8BED").addOption("pt","\u8461\u8404\u7259\u8BED").addOption("it","\u610F\u5927\u5229\u8BED").setValue(this.plugin.settings.defaultLanguage||"en").onChange(async o=>{this.plugin.settings.defaultLanguage=o,this.debouncedSave()})),e.createEl("div",{text:"\u89C6\u9891\u4E0E\u8D44\u6E90",cls:"ls-section-title"});let s=e.createDiv({cls:"ls-card"});new m.Setting(s).setName("yt-dlp \u8BBE\u7F6E").setDesc("\u4E0B\u8F7D YouTube \u5B57\u5E55\u7684\u6838\u5FC3\u7EC4\u4EF6").addButton(a=>a.setButtonText("\u5B89\u88C5\u6307\u5357").setClass("mod-cta").onClick(()=>{new it(this.app).open()})).addButton(a=>a.setButtonText("\u91CD\u65B0\u68C0\u6D4B").onClick(async()=>{new m.Notice("\u6B63\u5728\u68C0\u6D4B yt-dlp...");let o=await this.plugin.checkYtDlpInstallation();o.installed?new m.Notice(`\u2705 \u68C0\u6D4B\u6210\u529F\uFF01yt-dlp \u5DF2\u5B89\u88C5 (\u7248\u672C: ${o.version})`,5e3):new m.Notice("\u274C \u68C0\u6D4B\u5931\u8D25\uFF1A\u672A\u627E\u5230 yt-dlp\uFF0C\u8BF7\u5148\u5B89\u88C5",5e3)})),this.renderVideoSettings(s),e.createEl("div",{text:"\u914D\u7F6E\u5907\u4EFD",cls:"ls-section-title"});let i=e.createDiv({cls:"ls-card"});new m.Setting(i).setName("\u5BFC\u51FA\u914D\u7F6E").setDesc("\u5C06\u5F53\u524D\u8BBE\u7F6E\u5BFC\u51FA\u4E3A JSON \u6587\u4EF6").addButton(a=>a.setButtonText("\u5BFC\u51FA").onClick(async()=>{let o=JSON.stringify(this.plugin.settings,null,2),r=new Blob([o],{type:"application/json"}),l=URL.createObjectURL(r),d=document.createElement("a");d.href=l,d.download=`ob-english-learner-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l),new m.Notice("\u2705 \u914D\u7F6E\u5DF2\u5BFC\u51FA")})),new m.Setting(i).setName("\u5BFC\u5165\u914D\u7F6E").setDesc("\u4ECE JSON \u6587\u4EF6\u6062\u590D\u8BBE\u7F6E").addButton(a=>a.setButtonText("\u5BFC\u5165").onClick(()=>{let o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=async r=>{var d;let l=(d=r.target.files)==null?void 0:d[0];if(l)try{let u=await l.text(),g=JSON.parse(u);if(typeof g!="object"||!g.hasOwnProperty("videoFolder"))throw new Error("\u65E0\u6548\u7684\u914D\u7F6E\u6587\u4EF6");Object.assign(this.plugin.settings,g),await this.plugin.saveSettings(),new m.Notice("\u2705 \u914D\u7F6E\u5DF2\u5BFC\u5165\uFF01\u6B63\u5728\u5237\u65B0..."),this.display()}catch(u){new m.Notice(`\u274C \u5BFC\u5165\u5931\u8D25: ${u.message} `)}},o.click()}))}renderVideoSettings(e){new m.Setting(e).setName("\u89C6\u9891\u7B14\u8BB0\u76EE\u5F55").setDesc("\u5B58\u653E\u89C6\u9891\u7B14\u8BB0 (MD) \u7684\u6587\u4EF6\u5939").addText(n=>{n.setPlaceholder("Languages/Videos").setValue(this.plugin.settings.videoFolder).onChange(async s=>{this.plugin.settings.videoFolder=s,this.debouncedSave()}),new te(this.app,n.inputEl)}),new m.Setting(e).setName("\u5B57\u5E55\u6587\u4EF6\u76EE\u5F55").setDesc("\u5B58\u653E SRT \u5B57\u5E55\u6587\u4EF6\u7684\u6587\u4EF6\u5939").addText(n=>{n.setPlaceholder("Languages/Subtitles").setValue(this.plugin.settings.subtitlesFolder).onChange(async s=>{this.plugin.settings.subtitlesFolder=s,this.debouncedSave()}),new te(this.app,n.inputEl)}),new m.Setting(e).setName("\u5C01\u9762\u56FE\u7247\u76EE\u5F55").setDesc("\u5B58\u653E\u89C6\u9891\u5C01\u9762\u56FE\u7684\u6587\u4EF6\u5939").addText(n=>{n.setPlaceholder("Languages/Thumbnails").setValue(this.plugin.settings.thumbnailsFolder).onChange(async s=>{this.plugin.settings.thumbnailsFolder=s,this.debouncedSave()}),new te(this.app,n.inputEl)}),new m.Setting(e).setName("\u81EA\u52A8\u4E0B\u8F7D\u5C01\u9762\u56FE").setDesc("\u5BFC\u5165\u89C6\u9891\u65F6\u81EA\u52A8\u4E0B\u8F7D\u5C01\u9762").addToggle(n=>n.setValue(this.plugin.settings.autoDownloadThumbnails).onChange(async s=>{this.plugin.settings.autoDownloadThumbnails=s,this.saveAndNotify()}))}renderAI(e){var l;let n=e.createDiv({cls:"ls-section"});e.createEl("div",{text:"AI \u529F\u80FD",cls:"ls-section-title"});let s=e.createDiv({cls:"ls-card"}),i={deepseek:[{id:"deepseek-chat",name:"DeepSeek Chat"},{id:"deepseek-coder",name:"DeepSeek Coder"}],openai:[{id:"gpt-4o",name:"GPT-4o"},{id:"gpt-4-turbo",name:"GPT-4 Turbo"},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo"}],gemini:[{id:"gemini-2.0-flash-exp",name:"Gemini 2.0 Flash (Experimental)"},{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro"},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash"},{id:"gemini-1.5-flash-8b",name:"Gemini 1.5 Flash-8B"}],siliconflow:[{id:"deepseek-ai/DeepSeek-V3",name:"DeepSeek V3 "},{id:"deepseek-ai/DeepSeek-R1",name:"DeepSeek R1 (\u63A8\u7406\u589E\u5F3A)"},{id:"Qwen/Qwen2.5-72B-Instruct",name:"Qwen 2.5 72B"},{id:"Qwen/Qwen2.5-Coder-32B-Instruct",name:"Qwen 2.5 Coder 32B"},{id:"Qwen/QwQ-32B-Preview",name:"QwQ 32B (\u957F\u601D\u8003\u94FE)"},{id:"moonshotai/Kimi-K2-Thinking",name:"Kimi K2 Thinking (\u6DF1\u5EA6\u63A8\u7406)"},{id:"zai-org/GLM-4.6",name:"GLM-4.6 (\u667A\u8C31)"},{id:"THUDM/glm-4-9b-chat",name:"GLM-4 9B Chat"},{id:"Pro/THUDM/glm-4-plus",name:"GLM-4 Plus (\u65D7\u8230)"},{id:"Qwen/Qwen2.5-7B-Instruct",name:"Qwen 2.5 7B (\u8F7B\u91CF)"},{id:"Qwen/Qwen2.5-14B-Instruct",name:"Qwen 2.5 14B"},{id:"meta-llama/Meta-Llama-3.1-70B-Instruct",name:"Llama 3.1 70B"},{id:"meta-llama/Meta-Llama-3.1-405B-Instruct",name:"Llama 3.1 405B (\u8D85\u5927)"}],videocaptioner:[{id:"gpt-4.1-mini",name:"GPT-4.1 Mini (\u6700\u65B0\u5C0F\u578B)"},{id:"gpt-4.1",name:"GPT-4.1 (\u6700\u65B0\u65D7\u8230)"},{id:"gpt-4o",name:"GPT-4o"},{id:"claude-3.5-sonnet-20241022",name:"Claude 3.5 Sonnet"},{id:"gemini-2.0-flash",name:"Gemini 2.0 Flash"}],custom:[{id:"custom-model",name:"Custom Model"}]};if(new m.Setting(s).setName("\u542F\u7528 AI \u7FFB\u8BD1").setDesc("\u4F7F\u7528 AI \u5C06\u82F1\u6587\u5B57\u5E55\u7FFB\u8BD1\u6210\u4E2D\u6587").addToggle(d=>d.setValue(this.plugin.settings.enableAITranslation).onChange(async u=>{this.plugin.settings.enableAITranslation=u,this.saveAndNotify()})),new m.Setting(s).setName("\u667A\u80FD\u7B14\u8BB0\u683C\u5F0F\u5316").setDesc("\u81EA\u52A8\u6DFB\u52A0\u6807\u70B9\u7B26\u53F7\u5E76\u5206\u6BB5\uFF0C\u4F18\u5316\u7B14\u8BB0\u5185\u5BB9").addToggle(d=>d.setValue(this.plugin.settings.enableAIFormatting).onChange(async u=>{this.plugin.settings.enableAIFormatting=u,await this.saveAndNotify(),this.display()})),new m.Setting(s).setName("\u667A\u80FD\u5B57\u5E55\u751F\u6210").setDesc("\u4E3A\u751F\u6210\u7684 SRT \u5B57\u5E55\u6587\u4EF6\u6DFB\u52A0 AI \u6807\u70B9\u548C\u5206\u6BB5").addToggle(d=>d.setValue(this.plugin.settings.enableAISubtitles).onChange(async u=>{this.plugin.settings.enableAISubtitles=u,await this.saveAndNotify()})),this.plugin.settings.enableAIFormatting){(l=new m.Setting(s).setName("\u683C\u5F0F\u5316\u63D0\u793A\u8BCD").setDesc("\u81EA\u5B9A\u4E49 AI \u683C\u5F0F\u5316\u7684\u6307\u4EE4").addTextArea(g=>g.setPlaceholder("\u8BF7\u683C\u5F0F\u5316...").setValue(this.plugin.settings.aiFormattingPrompt).onChange(async y=>{this.plugin.settings.aiFormattingPrompt=y,this.debouncedSave()}).inputEl.rows=6).addExtraButton(g=>g.setIcon("reset").setTooltip("\u6062\u590D\u9ED8\u8BA4").onClick(async()=>{this.plugin.settings.aiFormattingPrompt=dn,await this.saveAndNotify(),this.display()})).settingEl.querySelector(".setting-item-control .setting-item-description"))==null||l.remove();let d=s.querySelectorAll("textarea"),u=d[d.length-1];u&&(u.style.width="100%",u.style.marginTop="10px")}e.createEl("div",{text:"\u670D\u52A1\u914D\u7F6E",cls:"ls-section-title"});let a=e.createDiv({cls:"ls-card"});new m.Setting(a).setName("AI \u670D\u52A1\u63D0\u4F9B\u5546").setDesc("\u9009\u62E9 AI \u670D\u52A1\u63D0\u4F9B\u5546").addDropdown(d=>d.addOption("deepseek","DeepSeek \u2B50 (\u63A8\u8350 - \u6027\u4EF7\u6BD4\u9AD8)").addOption("siliconflow","SiliconFlow (\u56FD\u5185\u5FEB\u901F)").addOption("videocaptioner","VideoCaptioner (\u89C6\u9891\u4E13\u7528)").addOption("openai","OpenAI (\u5F3A\u5927\u4F46\u8F83\u8D35)").addOption("gemini","Gemini (\u514D\u8D39\u989D\u5EA6\u9AD8)").addOption("custom","Custom (\u81EA\u5B9A\u4E49)").setValue(this.plugin.settings.aiProvider).onChange(async u=>{this.plugin.settings.aiProvider=u,u==="custom"||(u==="videocaptioner"?this.plugin.settings.aiBaseUrl="https://api.videocaptioner.cn/v1/chat/completions":this.plugin.settings.aiBaseUrl="");let g=i[u]||[];g.length>0&&(this.plugin.settings.aiModel=g[0].id),await this.saveAndNotify(),this.display()})),new m.Setting(a).setName("API \u5BC6\u94A5").setDesc("\u60A8\u7684 AI API \u5BC6\u94A5").addText(d=>d.setPlaceholder("sk-...").setValue(this.plugin.settings.aiApiKey).onChange(async u=>{this.plugin.settings.aiApiKey=u,this.debouncedSave(),this.display()})),this.plugin.settings.aiProvider==="custom"&&new m.Setting(a).setName("API \u5730\u5740").setDesc("\u81EA\u5B9A\u4E49 API \u5730\u5740\uFF08\u4F8B\u5982 https://api.example.com/v1/chat/completions\uFF09").addText(d=>d.setPlaceholder("https://api.openai.com/v1/chat/completions").setValue(this.plugin.settings.aiBaseUrl).onChange(async u=>{this.plugin.settings.aiBaseUrl=u,this.debouncedSave()})),this.plugin.settings.aiProvider==="custom"?new m.Setting(a).setName("\u6A21\u578B\u540D\u79F0").setDesc("\u624B\u52A8\u8F93\u5165\u6A21\u578B ID").addText(d=>d.setPlaceholder("e.g. gpt-4o-mini").setValue(this.plugin.settings.aiModel).onChange(async u=>{this.plugin.settings.aiModel=u,this.debouncedSave()})):new m.Setting(a).setName("\u6A21\u578B\u9009\u62E9").setDesc("\u9009\u62E9\u8981\u4F7F\u7528\u7684 AI \u6A21\u578B").addDropdown(d=>{let u=this.plugin.settings.aiProvider,g=i[u]||[];g.forEach(y=>d.addOption(y.id,y.name)),g.find(y=>y.id===this.plugin.settings.aiModel)||g.length>0&&(this.plugin.settings.aiModel=g[0].id,this.plugin.saveSettings()),d.setValue(this.plugin.settings.aiModel).onChange(async y=>{this.plugin.settings.aiModel=y,this.saveAndNotify()})}),e.createEl("div",{text:"\u26A1 \u6027\u80FD\u4F18\u5316",cls:"ls-section-title"});let o=e.createDiv({cls:"ls-card"});new m.Setting(o).setName("\u6027\u80FD\u6A21\u5F0F").setDesc("\u8C03\u6574 AI \u5904\u7406\u901F\u5EA6\u4E0E API \u9650\u6D41\u7684\u5E73\u8861\u7B56\u7565").addDropdown(d=>d.addOption("balanced","\u{1F422} \u5E73\u8861\u6A21\u5F0F - \u4FDD\u5B88\u7B56\u7565\uFF0C\u907F\u514D\u9650\u6D41\uFF08\u63A8\u8350\u514D\u8D39 API\uFF09").addOption("fast","\u26A1 \u5FEB\u901F\u6A21\u5F0F - \u4F18\u5316\u5E73\u8861\uFF0C\u63A8\u8350\u4F7F\u7528\uFF08\u9ED8\u8BA4\uFF09").addOption("turbo","\u{1F680} \u6781\u901F\u6A21\u5F0F - \u6700\u5FEB\u901F\u5EA6\uFF0C\u9700\u8981\u5145\u8DB3 API \u989D\u5EA6").setValue(this.plugin.settings.aiPerformanceMode||"fast").onChange(async u=>{this.plugin.settings.aiPerformanceMode=u,this.saveAndNotify();let g={balanced:"\u5E73\u8861\u6A21\u5F0F\uFF1A\u5C0F\u6279\u6B21\u5904\u7406\uFF0C\u957F\u5EF6\u8FDF\uFF0C\u5C11\u5E76\u53D1\u3002\u9002\u5408\u514D\u8D39 API \u6216\u9650\u6D41\u4E25\u683C\u7684\u670D\u52A1\u3002",fast:"\u5FEB\u901F\u6A21\u5F0F\uFF1A\u4F18\u5316\u540E\u7684\u914D\u7F6E\uFF0C\u5728\u901F\u5EA6\u548C\u7A33\u5B9A\u6027\u4E4B\u95F4\u53D6\u5F97\u5E73\u8861\u3002\u63A8\u8350\u5927\u591A\u6570\u7528\u6237\u4F7F\u7528\u3002",turbo:"\u6781\u901F\u6A21\u5F0F\uFF1A\u5927\u6279\u6B21\uFF0C\u77ED\u5EF6\u8FDF\uFF0C\u591A\u5E76\u53D1\u3002\u9700\u8981\u5145\u8DB3\u7684 API \u989D\u5EA6\uFF0C\u53EF\u80FD\u89E6\u53D1\u9650\u6D41\uFF08\u5DF2\u5185\u7F6E\u91CD\u8BD5\uFF09\u3002"};new m.Notice(g[u],5e3)})),o.createDiv({cls:"setting-item-description",text:`
\u5F53\u524D\u914D\u7F6E\u5F71\u54CD\uFF1A
\u2022 \u5E73\u8861\u6A21\u5F0F\uFF1A\u6700\u5B89\u5168\uFF0C\u5904\u7406\u65F6\u95F4\u7EA6\u4E3A\u5FEB\u901F\u6A21\u5F0F\u7684 1.5 \u500D
\u2022 \u5FEB\u901F\u6A21\u5F0F\uFF1A\u63A8\u8350\u914D\u7F6E\uFF0C\u5DF2\u4F18\u5316\u6027\u80FD\uFF0C\u6BD4\u539F\u7248\u5FEB 60%+
\u2022 \u6781\u901F\u6A21\u5F0F\uFF1A\u6700\u5FEB\u901F\u5EA6\uFF0C\u6BD4\u5FEB\u901F\u6A21\u5F0F\u518D\u5FEB 30-40%\uFF0C\u4F46\u53EF\u80FD\u89E6\u53D1\u9650\u6D41
		`.trim()}),e.createEl("div",{text:"\u6D4B\u8BD5\u8FDE\u63A5",cls:"ls-section-title"});let r=e.createDiv({cls:"ls-card"});new m.Setting(r).setName("\u6D4B\u8BD5 AI \u8FDE\u63A5").setDesc("\u6D4B\u8BD5 API \u914D\u7F6E\u662F\u5426\u6B63\u5E38\u5DE5\u4F5C").addButton(d=>d.setButtonText("\u6D4B\u8BD5").setClass("ls-button").onClick(async()=>{await this.testAIConnection()}))}renderAudio(e){let n=e.createDiv({cls:"ls-section"});n.createEl("div",{text:"Audio / \u97F3\u9891",cls:"ls-section-title"});let s=n.createDiv({cls:"ls-card"}),i=s.createDiv({cls:"ls-card-title"});if(i.createEl("span",{text:"\u{1F399}\uFE0F Voice to Text (STT)",cls:"ls-card-icon"}),this.plugin.settings.enableVoice2Text){let r=this.getSTTStatus();i.appendChild(this.createStatusBadge(r.status,r.message))}if(new m.Setting(s).setName("\u542F\u7528\u8BED\u97F3\u8F6C\u6587\u5B57").setDesc("\u542F\u7528\u8BED\u97F3\u5F55\u5236\u548C\u8F6C\u5199\u529F\u80FD").addToggle(r=>r.setValue(this.plugin.settings.enableVoice2Text).onChange(async l=>{this.plugin.settings.enableVoice2Text=l,this.saveAndNotify(),this.display()})),this.plugin.settings.enableVoice2Text){new m.Setting(s).setName("\u8BED\u97F3\u8BC6\u522B\u670D\u52A1\u5546").setDesc("\u9009\u62E9\u8BED\u97F3\u8F6C\u6587\u5B57\u7684\u670D\u52A1\u63D0\u4F9B\u5546").addDropdown(f=>f.addOption("openai","OpenAI (Whisper \u2B50 \u63A8\u8350)").addOption("custom","Custom (\u81EA\u5B9A\u4E49)").addOption("assemblyai","AssemblyAI (\u4E13\u4E1A\u8F6C\u5F55)").addOption("azure","Azure (\u4F01\u4E1A\u7EA7)").setValue(this.plugin.settings.sttProvider).onChange(async h=>{this.plugin.settings.sttProvider=h,h==="openai"&&(this.plugin.settings.sttBaseUrl="https://api.openai.com/v1/audio/transcriptions"),await this.saveAndNotify(),this.display()}));let r=this.plugin.settings.sttProvider,l="\u8BED\u97F3\u8BC6\u522B API \u5BC6\u94A5";if(r==="openai"&&(l="\u7559\u7A7A\u5219\u4F7F\u7528\u4E3B AI \u5BC6\u94A5"),new m.Setting(s).setName("\u8BED\u97F3\u8BC6\u522B API \u5BC6\u94A5").setDesc(l).addText(f=>f.setPlaceholder(r==="openai"?"\u7559\u7A7A\u4F7F\u7528\u4E3B AI \u5BC6\u94A5":"sk-...").setValue(this.plugin.settings.sttApiKey).onChange(async h=>{this.plugin.settings.sttApiKey=h,this.debouncedSave(),this.display()})),r==="custom"&&new m.Setting(s).setName("\u63A5\u53E3\u5730\u5740").setDesc("\u81EA\u5B9A\u4E49 API \u63A5\u53E3\u5730\u5740").addText(f=>f.setPlaceholder("https://api.openai.com/v1/audio/transcriptions").setValue(this.plugin.settings.sttBaseUrl).onChange(async h=>{this.plugin.settings.sttBaseUrl=h,this.debouncedSave()})),r==="azure"){let f=["eastus","eastus2","westus","westus2","westus3","centralus","northcentralus","southcentralus","westcentralus","canadacentral","brazilsouth","northeurope","westeurope","uksouth","francecentral","germanywestcentral","norwayeast","switzerlandnorth","switzerlandwest","swedencentral","eastasia","southeastasia","japaneast","japanwest","koreacentral","australiaeast","centralindia","jioindiawest","uaenorth"];new m.Setting(s).setName("\u533A\u57DF").setDesc("Azure \u670D\u52A1\u533A\u57DF").addDropdown(h=>{f.forEach(b=>{let x=b.charAt(0).toUpperCase()+b.slice(1);h.addOption(b,x)}),h.setValue(this.plugin.settings.sttBaseUrl||"eastus"),h.onChange(async b=>{this.plugin.settings.sttBaseUrl=b,await this.debouncedSave()})})}new m.Setting(s).setName("\u8BED\u8A00").setDesc("\u8BED\u97F3\u8BC6\u522B\u8BED\u8A00").addDropdown(f=>f.addOption("","\u81EA\u52A8\u68C0\u6D4B").addOption("en","\u82F1\u8BED").addOption("en-US","\u82F1\u8BED\uFF08\u7F8E\u56FD\uFF09").addOption("en-GB","\u82F1\u8BED\uFF08\u82F1\u56FD\uFF09").addOption("zh","\u4E2D\u6587").addOption("zh-CN","\u7B80\u4F53\u4E2D\u6587").addOption("zh-TW","\u7E41\u4F53\u4E2D\u6587").addOption("ja","\u65E5\u8BED").addOption("ja-JP","\u65E5\u8BED\uFF08\u65E5\u672C\uFF09").addOption("ko","\u97E9\u8BED").addOption("ko-KR","\u97E9\u8BED\uFF08\u97E9\u56FD\uFF09").addOption("es","\u897F\u73ED\u7259\u8BED").addOption("es-ES","\u897F\u73ED\u7259\u8BED\uFF08\u897F\u73ED\u7259\uFF09").addOption("fr","\u6CD5\u8BED").addOption("fr-FR","\u6CD5\u8BED\uFF08\u6CD5\u56FD\uFF09").addOption("de","\u5FB7\u8BED").addOption("de-DE","\u5FB7\u8BED\uFF08\u5FB7\u56FD\uFF09").addOption("ru","\u4FC4\u8BED").addOption("pt","\u8461\u8404\u7259\u8BED").addOption("it","\u610F\u5927\u5229\u8BED").addOption("ar","\u963F\u62C9\u4F2F\u8BED").addOption("hi","\u5370\u5730\u8BED").setValue(this.plugin.settings.sttLanguage||"").onChange(async h=>{this.plugin.settings.sttLanguage=h,this.debouncedSave()})),(r==="openai"||r==="custom")&&new m.Setting(s).setName("\u6A21\u578B").setDesc("Whisper \u6A21\u578B\u540D\u79F0").addText(f=>f.setPlaceholder("whisper-1").setValue(this.plugin.settings.sttModel).onChange(async h=>{this.plugin.settings.sttModel=h,this.debouncedSave()})),new m.Setting(s).setName("\u97F3\u9891\u6587\u4EF6\u683C\u5F0F").setDesc("\u9009\u62E9\u5F55\u97F3\u6587\u4EF6\u683C\u5F0F").addDropdown(f=>f.addOption("wav","WAV (\u65E0\u635F\uFF0C\u6587\u4EF6\u5927)").addOption("webm","WebM (\u517C\u5BB9\u6027\u597D)").addOption("mp3","MP3 (\u538B\u7F29\uFF0C\u6587\u4EF6\u5C0F)").setValue(this.plugin.settings.audioFormat||"wav").onChange(async h=>{this.plugin.settings.audioFormat=h,this.saveAndNotify()})),new m.Setting(s).setName("\u4FDD\u5B58\u97F3\u9891\u6587\u4EF6").setDesc("\u5C06\u5F55\u5236\u7684\u97F3\u9891\u4FDD\u5B58\u5230\u4ED3\u5E93").addToggle(f=>f.setValue(this.plugin.settings.saveAudio).onChange(async h=>{this.plugin.settings.saveAudio=h,this.saveAndNotify()})),new m.Setting(s).setName("\u53EA\u5F55\u97F3\u6A21\u5F0F").setDesc("\u4EC5\u5F55\u97F3\u4E0D\u8F6C\u5199\uFF0C\u53EA\u4FDD\u5B58\u97F3\u9891\u6587\u4EF6").addToggle(f=>f.setValue(this.plugin.settings.recordOnlyMode).onChange(async h=>{this.plugin.settings.recordOnlyMode=h,h&&!this.plugin.settings.saveAudio&&(this.plugin.settings.saveAudio=!0),this.saveAndNotify(),this.display()})),new m.Setting(s).setName("\u5F55\u97F3\u6587\u4EF6\u540D\u6A21\u677F").setDesc("\u53EF\u7528\u53D8\u91CF: {{date}}, {{time}}, {{title}}, {{timestamp}}").addText(f=>{f.setPlaceholder("Recording_{{date:YYYY-MM-DD}}_{{time:HH-mm-ss}}").setValue(this.plugin.settings.audioFilenameTemplate).onChange(async h=>{this.plugin.settings.audioFilenameTemplate=h,this.debouncedSave(),T(h)}),f.inputEl.style.width="100%"});let u=s.createDiv({cls:"ls-template-preview"});u.style.marginTop="12px",u.style.padding="10px 14px",u.style.backgroundColor="var(--background-secondary)",u.style.borderRadius="8px",u.style.border="1px solid var(--background-modifier-border)";let g=u.createDiv();g.style.fontSize="11px",g.style.fontWeight="500",g.style.color="var(--text-muted)",g.style.marginBottom="6px",g.style.textTransform="uppercase",g.style.letterSpacing="0.05em",g.setText("Preview / \u9884\u89C8");let y=u.createDiv();y.style.fontSize="13px",y.style.fontFamily="var(--font-monospace)",y.style.color="var(--text-normal)",y.style.wordBreak="break-all",y.style.lineHeight="1.4";let T=f=>{let h=new Date,b=f.replace(/\{\{date:YYYY-MM-DD\}\}/g,h.toISOString().split("T")[0]).replace(/\{\{date\}\}/g,h.toISOString().split("T")[0]).replace(/\{\{time:HH-mm-ss\}\}/g,h.toTimeString().split(" ")[0].replace(/:/g,"-")).replace(/\{\{time\}\}/g,h.toTimeString().split(" ")[0].replace(/:/g,"-")).replace(/\{\{timestamp\}\}/g,String(h.getTime())).replace(/\{\{title\}\}/g,"UntitledNote");y.setText(`${b}.${this.plugin.settings.audioFormat||"wav"}`)};T(this.plugin.settings.audioFilenameTemplate),new m.Setting(s).setName("\u97F3\u9891\u4FDD\u5B58\u8DEF\u5F84").setDesc("\u5B58\u653E\u5F55\u5236\u97F3\u9891\u7684\u6587\u4EF6\u5939").addText(f=>{f.setPlaceholder("recordings").setValue(this.plugin.settings.audioFolder).onChange(async h=>{this.plugin.settings.audioFolder=h,this.debouncedSave()}),new te(this.app,f.inputEl)}),new m.Setting(s).setName("\u6D4B\u8BD5\u8BED\u97F3\u670D\u52A1\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u8BED\u97F3\u8F6C\u6587\u5B57\u914D\u7F6E\u662F\u5426\u6B63\u5E38").addButton(f=>f.setButtonText("\u6D4B\u8BD5").setClass("ls-button").onClick(async()=>{await this.testSTTConnection()}))}let a=n.createDiv({cls:"ls-card"}),o=a.createDiv({cls:"ls-card-title"});if(o.createEl("span",{text:"\u{1F50A} Text to Speech (TTS)",cls:"ls-card-icon"}),this.plugin.settings.enableTTS){let r=this.getTTSStatus();o.appendChild(this.createStatusBadge(r.status,r.message))}if(new m.Setting(a).setName("\u542F\u7528\u6587\u672C\u8F6C\u8BED\u97F3").setDesc("\u542F\u7528\u201C\u6717\u8BFB\u9009\u4E2D\u6587\u672C\u201D\u547D\u4EE4\u548C\u83DC\u5355").addToggle(r=>r.setValue(this.plugin.settings.enableTTS).onChange(async l=>{this.plugin.settings.enableTTS=l,this.saveAndNotify(),this.display()})),this.plugin.settings.enableTTS){new m.Setting(a).setName("TTS \u670D\u52A1\u5546").setDesc("\u9009\u62E9\u6587\u672C\u8F6C\u8BED\u97F3\u670D\u52A1\u63D0\u4F9B\u5546").addDropdown(h=>h.addOption("openai","OpenAI \u2B50 (\u63A8\u8350 - \u8D28\u91CF\u597D)").addOption("azure","Azure (\u591A\u8BED\u8A00\u652F\u6301)").addOption("elevenlabs","ElevenLabs (\u6700\u81EA\u7136)").addOption("custom","Custom (\u81EA\u5B9A\u4E49)").setValue(this.plugin.settings.ttsProvider||"openai").onChange(async b=>{this.plugin.settings.ttsProvider=b,this.saveAndNotify(),this.display()}));let r=this.plugin.settings.ttsProvider||"openai";if(new m.Setting(a).setName("TTS API \u5BC6\u94A5").setDesc("\u7559\u7A7A\u5219\u4F7F\u7528\u5168\u5C40 API \u5BC6\u94A5").addText(h=>h.setPlaceholder("sk-...").setValue(this.plugin.settings.ttsApiKey).onChange(async b=>{this.plugin.settings.ttsApiKey=b,this.debouncedSave()})),(r==="openai"||r==="custom")&&(new m.Setting(a).setName("TTS \u6A21\u578B").addDropdown(h=>h.addOption("tts-1","TTS-1").addOption("tts-1-hd","TTS-1-HD").setValue(this.plugin.settings.ttsModel||"tts-1").onChange(async b=>{this.plugin.settings.ttsModel=b,this.debouncedSave()})),new m.Setting(a).setName("TTS \u97F3\u8272").addDropdown(h=>h.addOption("alloy","Alloy").addOption("echo","Echo").addOption("fable","Fable").addOption("onyx","Onyx").addOption("nova","Nova").addOption("shimmer","Shimmer").setValue(this.plugin.settings.ttsVoice||"alloy").onChange(async b=>{this.plugin.settings.ttsVoice=b,this.debouncedSave()})),r==="custom"&&new m.Setting(a).setName("TTS \u63A5\u53E3\u5730\u5740").setDesc("\u4F8B\u5982: https://api.openai.com/v1/audio/speech").addText(h=>h.setPlaceholder("https://api.openai.com/v1/audio/speech").setValue(this.plugin.settings.ttsBaseUrl).onChange(async b=>{this.plugin.settings.ttsBaseUrl=b,this.debouncedSave()}))),r==="azure"){let h=["eastus","eastus2","westus","westus2","westus3","centralus","northcentralus","southcentralus","westcentralus","canadacentral","brazilsouth","northeurope","westeurope","uksouth","francecentral","germanywestcentral","norwayeast","switzerlandnorth","switzerlandwest","swedencentral","eastasia","southeastasia","japaneast","japanwest","koreacentral","australiaeast","centralindia","jioindiawest","uaenorth"];new m.Setting(a).setName("\u533A\u57DF").setDesc("\u9009\u62E9 Speech Services \u8D44\u6E90\u6240\u5728\u7684 Azure \u533A\u57DF").addDropdown(C=>{h.forEach(S=>{let w=S.charAt(0).toUpperCase()+S.slice(1);C.addOption(S,w)}),C.setValue(this.plugin.settings.ttsBaseUrl||"eastus"),C.onChange(async S=>{this.plugin.settings.ttsBaseUrl=S,await this.saveAndNotify(),this.display()})});let b=this.plugin.settings.ttsApiKey||this.plugin.settings.aiApiKey,x=this.plugin.settings.ttsBaseUrl||"eastus";b&&x?new m.Setting(a).setName("\u8BED\u97F3").setDesc("\u9009\u62E9\u7528\u4E8E\u8BED\u97F3\u5408\u6210\u7684 Azure \u58F0\u97F3").addDropdown(S=>{S.addOption("","\u52A0\u8F7D\u4E2D..."),S.setDisabled(!0),this.plugin.ttsManager.getAzureVoices().then(w=>{if(!w||w.length===0){S.selectEl.innerHTML="",S.addOption("","\u274C \u672A\u627E\u5230\u8BED\u97F3"),S.setDisabled(!0);return}w.sort((v,$)=>v.Locale.localeCompare($.Locale)||v.DisplayName.localeCompare($.DisplayName));let D=S.selectEl;D.innerHTML="",w.forEach(v=>{let $=`${v.DisplayName} (${v.Gender}) - ${v.Locale} `,z=document.createElement("option");z.value=v.ShortName,z.text=$,D.appendChild(z)});let k=this.plugin.settings.ttsVoice;w.find(v=>v.ShortName===k)?S.setValue(k):w.length>0&&(S.setValue(w[0].ShortName),this.plugin.settings.ttsVoice=w[0].ShortName,this.saveAndNotify()),S.setDisabled(!1),S.onChange(async v=>{this.plugin.settings.ttsVoice=v,this.debouncedSave()})}).catch(w=>{S.selectEl.innerHTML="";let D=w.message||w.toString(),k="\u274C \u52A0\u8F7D\u5931\u8D25";D.includes("401")||D.includes("403")?k="\u274C API \u5BC6\u94A5\u65E0\u6548":D.includes("404")&&(k="\u274C \u533A\u57DF\u65E0\u6548"),S.addOption("",k),S.setDisabled(!0),console.error("[Azure TTS] Failed to load voices:",w),console.error("[Azure TTS] API Key (first 8 chars):",b.substring(0,8)+"..."),console.error("[Azure TTS] Region:",x),new m.Notice(`${k} 
\u8BE6\u89C1\u63A7\u5236\u53F0`,5e3)})}):new m.Setting(a).setName("\u8BED\u97F3").setDesc("\u26A0\uFE0F \u8BF7\u5148\u5728\u4E0A\u65B9\u8F93\u5165 Azure API \u5BC6\u94A5\u4EE5\u52A0\u8F7D\u53EF\u7528\u8BED\u97F3");let P=[{label:"MP3 16kHz 128kbps",value:"audio-16khz-128kbitrate-mono-mp3"},{label:"MP3 24kHz 96kbps",value:"audio-24khz-96kbitrate-mono-mp3"},{label:"MP3 48kHz 192kbps",value:"audio-48khz-192kbitrate-mono-mp3"},{label:"WAV 16kHz 16bit",value:"riff-16khz-16bit-mono-pcm"},{label:"WAV 24kHz 16bit",value:"riff-24khz-16bit-mono-pcm"},{label:"WAV 48kHz 16bit",value:"riff-48khz-16bit-mono-pcm"}];new m.Setting(a).setName("\u8F93\u51FA\u683C\u5F0F").setDesc("\u751F\u6210\u8BED\u97F3\u7684\u97F3\u9891\u683C\u5F0F").addDropdown(C=>{P.forEach(S=>{C.addOption(S.value,S.label)}),C.setValue(this.plugin.settings.ttsOutputFormat||"audio-16khz-128kbitrate-mono-mp3"),C.onChange(async S=>{this.plugin.settings.ttsOutputFormat=S,this.debouncedSave()})})}r==="elevenlabs"&&(new m.Setting(a).setName(this.createBilingualLabel("Voice ID","Voice ID")).setDesc("ElevenLabs Voice ID").addText(h=>h.setPlaceholder("21m00Tcm4TlvDq8ikWAM").setValue(this.plugin.settings.ttsVoice).onChange(async b=>{this.plugin.settings.ttsVoice=b,this.debouncedSave()})),new m.Setting(a).setName("\u6A21\u578B ID").setDesc("\u4F8B\u5982: eleven_monolingual_v1").addText(h=>h.setPlaceholder("eleven_monolingual_v1").setValue(this.plugin.settings.ttsModel).onChange(async b=>{this.plugin.settings.ttsModel=b,this.debouncedSave()}))),new m.Setting(a).setName("\u64AD\u653E\u901F\u5EA6").setDesc("0.25x - 4.0x").addSlider(h=>h.setLimits(.25,4,.25).setValue(this.plugin.settings.ttsSpeed||1).setDynamicTooltip().onChange(async b=>{this.plugin.settings.ttsSpeed=b,this.debouncedSave()})),new m.Setting(a).setName("\u6D4B\u8BD5\u8BED\u97F3").setDesc("\u6D4B\u8BD5\u5F53\u524D TTS \u914D\u7F6E").addButton(h=>h.setButtonText("\u6D4B\u8BD5").onClick(async()=>{h.setDisabled(!0),h.setButtonText("\u6D4B\u8BD5\u4E2D...");try{let b="\u4F60\u597D\uFF0C\u8FD9\u662F\u4E00\u4E2A\u8BED\u97F3\u5408\u6210\u6D4B\u8BD5\u3002";await this.plugin.ttsManager.testSpeak(b),new m.Notice("\u2705 \u6D4B\u8BD5\u6210\u529F\uFF01")}catch(b){new m.Notice("\u274C \u6D4B\u8BD5\u5931\u8D25: "+b.message),console.error(b)}finally{h.setDisabled(!1),h.setButtonText("\u6D4B\u8BD5")}})),e.createEl("div",{text:"\u7528\u6237\u754C\u9762",cls:"ls-section-title"});let l=e.createDiv({cls:"ls-card"});new m.Setting(l).setName("\u663E\u793A\u64AD\u653E\u5668\u5DE5\u5177\u680F").setDesc("\u8BBE\u7F6E\u64AD\u653E\u5668\u5DE5\u5177\u680F\u7684\u663E\u793A\u6761\u4EF6").addDropdown(h=>h.addOption("always","\u59CB\u7EC8\u663E\u793A").addOption("auto","\u64AD\u653E\u65F6\u663E\u793A").addOption("never","\u4ECE\u4E0D\u663E\u793A").setValue(this.plugin.settings.ttsShowPlayer||"always").onChange(async b=>{this.plugin.settings.ttsShowPlayer=b,this.saveAndNotify()})),new m.Setting(l).setName("\u81EA\u52A8\u6EDA\u52A8\u64AD\u653E\u5668").setDesc("\u81EA\u52A8\u6EDA\u52A8\u4EE5\u4FDD\u6301\u5F53\u524D\u64AD\u653E\u7684\u6587\u672C\u53EF\u89C1").addToggle(h=>h.setValue(this.plugin.settings.ttsAutoscroll).onChange(async b=>{this.plugin.settings.ttsAutoscroll=b,this.saveAndNotify()})),e.createEl("div",{text:"\u5B58\u50A8\u8BBE\u7F6E",cls:"ls-section-title"});let d=e.createDiv({cls:"ls-card"});new m.Setting(d).setName("\u7F13\u5B58\u7C7B\u578B").setDesc(`\u672C\u5730\uFF1A\u8BBE\u5907\u7F13\u5B58\uFF08\u63A8\u8350\uFF09
\u4ED3\u5E93\uFF1A\u8DE8\u8BBE\u5907\u5171\u4EAB`).addDropdown(h=>h.addOption("local","\u672C\u5730\u7F13\u5B58").addOption("vault","\u4ED3\u5E93\u7F13\u5B58").setValue(this.plugin.settings.ttsCacheType==="none"?"local":this.plugin.settings.ttsCacheType).onChange(async b=>{this.plugin.settings.ttsCacheType=b,this.saveAndNotify()}));let u=new m.Setting(d).setName("\u7F13\u5B58\u65F6\u957F").setDesc("\u97F3\u9891\u7F13\u5B58\u4FDD\u7559\u65F6\u957F\uFF08\u5C0F\u65F6\uFF09");u.addText(h=>{h.setPlaceholder("24").setValue(String(this.plugin.settings.ttsCacheDuration||24)).onChange(async b=>{let x=parseInt(b);isNaN(x)||(this.plugin.settings.ttsCacheDuration=x,this.debouncedSave())}),h.inputEl.style.width="100px"});let g=u.controlEl.createSpan();g.setText("\u5C0F\u65F6"),g.style.marginLeft="8px",g.style.color="var(--text-muted)";let y=new m.Setting(d).setName("\u7F13\u5B58\u78C1\u76D8\u5360\u7528").setDesc("\u8BA1\u7B97\u4E2D..."),T=async()=>{try{let h=await this.plugin.ttsManager.getCacheSize(),b=this.humanFileSize(h);y.setDesc(b)}catch(h){y.setDesc("\u8BA1\u7B97\u5931\u8D25"),console.error(h)}};y.addButton(h=>h.setIcon("rotate-cw").setTooltip("\u5237\u65B0").onClick(async()=>{h.setDisabled(!0),await T(),h.setDisabled(!1)})).addButton(h=>h.setIcon("trash").setTooltip("\u6E05\u9664\u7F13\u5B58").onClick(async()=>{if(confirm("\u786E\u8BA4\u6E05\u9664 TTS \u7F13\u5B58\uFF1F\u8FD9\u5C06\u5220\u9664\u6240\u6709\u7F13\u5B58\u7684\u97F3\u9891\u6587\u4EF6\u3002")){h.setDisabled(!0);try{await this.plugin.ttsManager.clearCache(),await T()}catch(b){new m.Notice("\u6E05\u9664\u7F13\u5B58\u5931\u8D25: "+b.message)}finally{h.setDisabled(!1)}}})),T(),new m.Setting(d).setName("\u97F3\u9891\u6587\u4EF6\u5939").setDesc("\u5BFC\u51FA\u97F3\u9891\u6587\u4EF6\u7684\u4FDD\u5B58\u4F4D\u7F6E").addText(h=>{h.setPlaceholder("03-Resources/aloud").setValue(this.plugin.settings.ttsAudioFolder).onChange(async b=>{this.plugin.settings.ttsAudioFolder=b,this.debouncedSave()}),new te(this.app,h.inputEl)}),e.createEl("div",{text:"\u6587\u672C\u5206\u6BB5",cls:"ls-section-title"});let f=e.createDiv({cls:"ls-card"});new m.Setting(f).setName("\u5206\u6BB5\u65B9\u5F0F").setDesc("\u64AD\u653E\u65F6\u6309\u53E5\u5B50\u6216\u6BB5\u843D\u5206\u5272\u6587\u672C").addDropdown(h=>h.addOption("sentence","\u6309\u53E5\u5B50").addOption("paragraph","\u6309\u6BB5\u843D").setValue(this.plugin.settings.ttsChunking||"sentence").onChange(async b=>{this.plugin.settings.ttsChunking=b,this.saveAndNotify()}))}}async renderCommands(e){await this.plugin.loadCustomCommands();let n=e.createDiv({cls:"ls-card"});e.createEl("div",{text:"\u81EA\u5B9A\u4E49\u547D\u4EE4",cls:"ls-section-title"}),new m.Setting(n).setName("\u81EA\u5B9A\u4E49\u547D\u4EE4\u6587\u4EF6\u5939").setDesc("\u5B58\u50A8\u81EA\u5B9A\u4E49\u547D\u4EE4\u6587\u4EF6\u7684\u6587\u4EF6\u5939 (.md)").addText(r=>{r.setPlaceholder("03-Resources/copilot-custom-prompts").setValue(this.plugin.settings.customCommandsFolder).onChange(async l=>{this.plugin.settings.customCommandsFolder=l,this.debouncedSave(),await this.plugin.loadCustomCommands(),this.display()}),r.inputEl.style.width="100%",r.inputEl.style.minWidth="400px"}),new m.Setting(n).setName("\u63D0\u793A\u8BCD\u6A21\u677F\u5316").setDesc("\u5728\u63D0\u793A\u8BCD\u4E2D\u5904\u7406 {{selection}} \u53D8\u91CF").addToggle(r=>r.setValue(this.plugin.settings.customCommandTemplating).onChange(async l=>{this.plugin.settings.customCommandTemplating=l,this.saveAndNotify()})),new m.Setting(n).setName("\u6392\u5E8F\u7B56\u7565").setDesc("\u547D\u4EE4\u5217\u8868\u7684\u6392\u5E8F\u65B9\u5F0F").addDropdown(r=>r.addOption("recency","\u6700\u8FD1\u4F7F\u7528").addOption("alphabetical","\u5B57\u6BCD\u987A\u5E8F").addOption("order","\u624B\u52A8\u6392\u5E8F").setValue(this.plugin.settings.customCommandSortStrategy).onChange(async l=>{this.plugin.settings.customCommandSortStrategy=l,this.saveAndNotify()})),e.createEl("div",{text:"\u5FEB\u6377\u64CD\u4F5C\u6309\u94AE",cls:"ls-section-title"});let s=e.createDiv({cls:"ls-card"});new m.Setting(s).setName("\u6309\u94AE 1 (\u26A1)").setDesc("\u5DE6\u4FA7\u5DE5\u5177\u680F\u7B2C\u4E00\u4E2A\u5FEB\u6377\u6309\u94AE").addDropdown(r=>{r.addOption("","-- \u65E0 --"),this.plugin.getAvailableCommands().forEach(d=>{r.addOption(d.id,d.name)}),r.setValue(this.plugin.settings.ribbonCommandId).onChange(async d=>{this.plugin.updateRibbonButton(1,d),await this.plugin.saveSettings(),new m.Notice("\u2705 \u6309\u94AE 1 \u5DF2\u66F4\u65B0")})}),new m.Setting(s).setName("\u6309\u94AE 2 (\u2B50)").setDesc("\u5DE6\u4FA7\u5DE5\u5177\u680F\u7B2C\u4E8C\u4E2A\u5FEB\u6377\u6309\u94AE").addDropdown(r=>{r.addOption("","-- \u65E0 --"),this.plugin.getAvailableCommands().forEach(d=>{r.addOption(d.id,d.name)}),r.setValue(this.plugin.settings.ribbonCommandId2).onChange(async d=>{this.plugin.updateRibbonButton(2,d),await this.plugin.saveSettings(),new m.Notice("\u2705 \u6309\u94AE 2 \u5DF2\u66F4\u65B0")})});let i=s.createDiv({cls:"ls-info-box"});i.style.marginTop="15px",i.innerHTML=`
			<div style="display: flex; gap: 10px; align-items: start;">
				<span style="font-size: 20px;">\u2728</span>
				<div style="font-size: 0.9em; color: var(--text-muted);">
					<strong>\u63D0\u793A\uFF1A</strong>\u6309\u94AE\u4F1A\u5373\u65F6\u66F4\u65B0 - \u65E0\u9700\u91CD\u65B0\u52A0\u8F7D\uFF01
				</div>
			</div>
		`;let a=n.createDiv({cls:"custom-commands-ui-container"});a.style.marginTop="20px",new nt(a,this.app,this.plugin.settings.customCommands||[],this.plugin.customCommandManager,this.plugin.settings.customCommandsFolder,async()=>{await this.plugin.loadCustomCommands()}).render()}renderAdvanced(e){e.createEl("div",{text:"\u7B14\u8BB0\u6A21\u677F",cls:"ls-section-title"});let n=e.createDiv({cls:"ls-card"});this.renderTemplateSettings(n),e.createEl("div",{text:"\u8D26\u6237\u7BA1\u7406",cls:"ls-section-title"});let s=e.createDiv({cls:"ls-card"});this.renderAccountSettings(s)}renderTemplateSettings(e){let n=e,s=new m.Setting(n).setName("\u9876\u90E8\u5C5E\u6027").setDesc("\u7BA1\u7406\u7B14\u8BB0\u9876\u90E8\u7684 YAML \u5C5E\u6027");s.settingEl.addClass("ls-sub-section-header"),s.settingEl.style.borderBottom="none",s.settingEl.style.paddingBottom="0";let i=n.createDiv({cls:"ls-properties-card"}),a,o=()=>{i.empty();let l=this.parseFrontmatter(this.plugin.settings.noteTemplate);if(l.length===0){let g=i.createDiv({text:"\u672A\u627E\u5230\u5C5E\u6027"});g.style.color="var(--text-muted)",g.style.padding="10px"}l.forEach((g,y)=>{let T=new m.Setting(i).addText(h=>h.setPlaceholder("Key").setValue(g.key).onChange(b=>{l[y].key=b,this.updateTemplate(l,a),this.debouncedSave()})).addText(h=>h.setPlaceholder("Value").setValue(g.value).onChange(b=>{l[y].value=b,this.updateTemplate(l,a),this.debouncedSave()})).addToggle(h=>h.setValue(g.enabled).setTooltip("Show/Hide").onChange(b=>{l[y].enabled=b,this.updateTemplate(l,a),this.saveAndNotify()})).addButton(h=>h.setIcon("trash").onClick(()=>{l.splice(y,1),this.updateTemplate(l,a),o(),this.saveAndNotify()}));T.setClass("ls-property-row"),T.controlEl.style.justifyContent="flex-start",T.controlEl.style.gap="10px";let f=T.controlEl.querySelectorAll('input[type="text"]');f.length>=2&&(f[0].style.width="120px",f[1].style.width="180px")});let d=i.createDiv();d.style.marginTop="10px",d.style.display="flex",d.style.justifyContent="flex-end";let u=d.createEl("button",{text:"+ \u6DFB\u52A0\u5C5E\u6027"});u.onclick=()=>{l.push({key:"new_property",value:"",enabled:!0}),this.updateTemplate(l,a),o(),this.saveAndNotify()}},r=n.createDiv({cls:"ls-variables"});r.style.marginTop="20px",r.style.fontSize="0.9em",r.style.color="var(--text-muted)",r.innerHTML=`<p style="margin: 0 0 8px 16px;"><strong>\u53EF\u7528\u53D8\u91CF: </strong></p>
	<div style="margin: 0 16px 16px; line-height: 1.6;">
		<code style="color:var(--ls-color-primary)">{{title}}</code>, <code style="color:var(--ls-color-primary)">{{url}}</code>, 
		<code style="color:var(--ls-color-primary)">{{channel}}</code>, <code style="color:var(--ls-color-primary)">{{cover}}</code>, 
		<code style="color:var(--ls-color-primary)">{{transcript}}</code> ...
	</div>`,new m.Setting(n).setName("\u6A21\u677F\u6E90\u7801").setDesc("\u7F16\u8F91\u539F\u59CB Markdown \u6A21\u677F").addTextArea(l=>{a=l,l.setPlaceholder(Pt).setValue(this.plugin.settings.noteTemplate).onChange(async d=>{this.plugin.settings.noteTemplate=d,this.debouncedSave(),o()}),l.inputEl.rows=10,l.inputEl.style.width="100%",l.inputEl.style.fontFamily="monospace"}),setTimeout(()=>o(),0),new m.Setting(n).setName("\u91CD\u7F6E\u6A21\u677F").setDesc("\u6062\u590D\u9ED8\u8BA4\u6A21\u677F\u8BBE\u7F6E").addButton(l=>l.setButtonText("\u91CD\u7F6E").setClass("ls-button").onClick(async()=>{confirm("\u786E\u8BA4\u91CD\u7F6E\u6A21\u677F\uFF1F")&&(this.plugin.settings.noteTemplate=Pt,await this.saveAndNotify(),this.display())}))}renderAccountSettings(e){new m.Setting(e).setName("\u5BC6\u7801\u7BA1\u7406\u5668").setDesc("\u7BA1\u7406\u53D7\u4FDD\u62A4\u5A92\u4F53\u6E90\u7684\u51ED\u8BC1").addButton(n=>n.setButtonText("\u6253\u5F00\u7BA1\u7406").setClass("ls-button").onClick(()=>new Me(this.app,this.plugin).open()))}parseFrontmatter(e){let n=e.match(/^---\n([\s\S]*?)\n---/);if(!n)return[];let i=n[1].split(`
`),a=[],o=null;for(let r of i){let l=r.trim();if(!l)continue;if(l.startsWith("-")){o&&(o.value+=`
`+r);continue}let d=l.startsWith("#"),u=d?l.substring(1).trim():l,g=u.indexOf(":");if(g!==-1){let y=u.substring(0,g).trim(),T=u.substring(g+1).trim();y&&(o={key:y,value:T,enabled:!d},a.push(o))}}return a}updateTemplate(e,n){let s=["---"];e.forEach(o=>{let r=o.enabled?"":"# ";s.push(`${r}${o.key}: ${o.value} `)}),s.push("---");let i=s.join(`
`),a=this.plugin.settings.noteTemplate;a.match(/^---\n([\s\S]*?)\n---/)?this.plugin.settings.noteTemplate=a.replace(/^---\n([\s\S]*?)\n---/,i):this.plugin.settings.noteTemplate=i+`
`+a,n&&n.setValue(this.plugin.settings.noteTemplate)}async testAIConnection(){let{aiProvider:e,aiApiKey:n,aiModel:s,aiBaseUrl:i}=this.plugin.settings;if(!n||!n.trim()){new m.Notice("\u274C Please enter your API key first / \u8BF7\u5148\u8F93\u5165 API \u5BC6\u94A5",5e3);return}let a=new m.Notice("\u{1F504} Testing connection... / \u6B63\u5728\u6D4B\u8BD5\u8FDE\u63A5...",0);try{let o="https://api.openai.com/v1/chat/completions";if(e==="custom")o=i||o;else if(e==="deepseek")o="https://api.deepseek.com/v1/chat/completions";else if(e==="siliconflow")o="https://api.siliconflow.cn/v1/chat/completions";else if(e==="videocaptioner")o="https://api.videocaptioner.cn/v1/chat/completions";else if(e==="gemini"){o=`https://generativelanguage.googleapis.com/v1beta/models/${s||"gemini-1.5-flash"}:generateContent?key=${n.trim()}`;let u=await(0,m.requestUrl)({url:o,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:"Hi"}]}]})});u.status===200?(a.hide(),new m.Notice("\u2705 Connection Successful! / \u8FDE\u63A5\u6210\u529F\uFF01")):(a.hide(),new m.Notice(`\u274C Connection Failed / \u8FDE\u63A5\u5931\u8D25
Status: ${u.status}`,5e3));return}let r={messages:[{role:"user",content:"Hi"}],model:s,stream:!1},l=await(0,m.requestUrl)({url:o,method:"POST",headers:{Authorization:`Bearer ${n.trim()}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(l.status===200)a.hide(),new m.Notice("\u2705 Connection Successful! / \u8FDE\u63A5\u6210\u529F\uFF01");else{a.hide();let d=l.text,u=`Status: ${l.status}`;l.status===401&&(u="Unauthorized (401). Check your API key."),l.status===429&&(u="Rate Limit Exceeded (429). Check your quota."),new m.Notice(`\u274C Connection Failed / \u8FDE\u63A5\u5931\u8D25
${u}
${d.substring(0,100)}`,5e3)}}catch(o){a.hide();let r=o.message;r.includes("401")?r="Unauthorized (401). Check your API key.":r.includes("429")?r="Rate Limit Exceeded (429). Check your quota.":r.includes("403")?r="Access Forbidden (403). Region or permission issue.":r.includes("404")&&(r="Model Not Found (404). Check model name."),new m.Notice(`\u274C Connection Error: ${r}`,5e3),console.error("Connection test failed:",o)}}async testSTTConnection(){let{sttProvider:e,sttApiKey:n,sttBaseUrl:s}=this.plugin.settings,i=new m.Notice("\u{1F504} Testing STT connection... / \u6B63\u5728\u6D4B\u8BD5\u8BED\u97F3\u670D\u52A1...",0);try{if(e==="openai"||e==="custom"){let a=n||this.plugin.settings.aiApiKey;if(!a)throw new Error("API Key is missing");let o=await(0,m.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${a}`}});if(o.status===200)i.hide(),new m.Notice("\u2705 OpenAI STT Connection Successful!");else throw new Error(`Status ${o.status}`)}else if(e==="assemblyai"){if(!n)throw new Error("API Key is missing");let a=await(0,m.requestUrl)({url:"https://api.assemblyai.com/v2/transcript?limit=1",method:"GET",headers:{Authorization:n}});if(a.status===200)i.hide(),new m.Notice("\u2705 AssemblyAI Connection Successful!");else throw new Error(`Status ${a.status}`)}else if(e==="azure"){if(!n||!s)throw new Error("API Key or Region missing");let o=await(0,m.requestUrl)({url:`https://${s}.api.cognitive.microsoft.com/sts/v1.0/issueToken`,method:"POST",headers:{"Ocp-Apim-Subscription-Key":n}});if(o.status===200)i.hide(),new m.Notice("\u2705 Azure Connection Successful!");else throw new Error(`Status ${o.status}`)}}catch(a){i.hide(),new m.Notice(`\u274C Connection Failed: ${a.message}`,5e3),console.error("STT Test failed:",a)}}},te=class extends m.AbstractInputSuggest{constructor(e,n){super(e,n);this.inputEl=n,this.inputEl.addEventListener("focus",()=>{this.inputEl.select()})}getSuggestions(e){let n=this.app.vault.getAllLoadedFiles(),s=[],i=e.toLowerCase();return n.forEach(a=>{a instanceof m.TFolder&&a.path.toLowerCase().contains(i)&&s.push(a)}),s.sort((a,o)=>{let r=a.path.split("/").length,l=o.path.split("/").length;return r!==l?r-l:a.path.localeCompare(o.path)}),s.slice(0,100)}renderSuggestion(e,n){n.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.trigger("input"),this.close()}},it=class extends m.Modal{constructor(e,n){super(e);this.onDismiss=n||(()=>{})}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("ytdlp-modal"),e.createEl("h2",{text:"\u{1F4FA} YouTube \u5B57\u5E55\u529F\u80FD\u8BBE\u7F6E"}),e.createEl("p",{text:"\u672C\u63D2\u4EF6\u4F7F\u7528 yt-dlp \u5DE5\u5177\u6765\u83B7\u53D6 YouTube \u5B57\u5E55\u3002\u8BF7\u6309\u7167\u4EE5\u4E0B\u6B65\u9AA4\u5B8C\u6210\u5B89\u88C5\uFF1A",cls:"setting-item-description"});let n=navigator.platform.toLowerCase().includes("win"),s=navigator.platform.toLowerCase().includes("mac"),i=e.createDiv({cls:"install-step"});if(i.createEl("h3",{text:"\u6B65\u9AA4 1\uFF1A\u6253\u5F00\u7EC8\u7AEF"}),n){let T=i.createDiv({cls:"terminal-guide"});T.createEl("p",{text:"\u{1FA9F} Windows \u7528\u6237\u8BF7\u9009\u62E9\u4EE5\u4E0B\u4EFB\u4E00\u65B9\u5F0F\u6253\u5F00\u7EC8\u7AEF\uFF1A"});let f=T.createEl("ul");f.createEl("li",{text:"\u6309 Win + X\uFF0C\u9009\u62E9\u300CWindows PowerShell\u300D\u6216\u300C\u7EC8\u7AEF\u300D"}),f.createEl("li",{text:"\u6309 Win + R\uFF0C\u8F93\u5165 cmd \u540E\u56DE\u8F66"}),f.createEl("li",{text:"\u5728\u5F00\u59CB\u83DC\u5355\u641C\u7D22\u300C\u547D\u4EE4\u63D0\u793A\u7B26\u300D\u6216\u300CPowerShell\u300D"})}else if(s){let T=i.createDiv({cls:"terminal-guide"});T.createEl("p",{text:"\u{1F34E} macOS \u7528\u6237\u8BF7\uFF1A"});let f=T.createEl("ul");f.createEl("li",{text:"\u6309 Cmd + \u7A7A\u683C\uFF0C\u641C\u7D22\u300CTerminal\u300D\u6216\u300C\u7EC8\u7AEF\u300D"}),f.createEl("li",{text:"\u6216\u5728\u300C\u5E94\u7528\u7A0B\u5E8F \u2192 \u5B9E\u7528\u5DE5\u5177 \u2192 \u7EC8\u7AEF\u300D\u4E2D\u6253\u5F00"})}else{let T=i.createDiv({cls:"terminal-guide"});T.createEl("p",{text:"\u{1F427} Linux \u7528\u6237\u8BF7\uFF1A"});let f=T.createEl("ul");f.createEl("li",{text:"\u6309 Ctrl + Alt + T \u6253\u5F00\u7EC8\u7AEF"}),f.createEl("li",{text:"\u6216\u5728\u5E94\u7528\u7A0B\u5E8F\u83DC\u5355\u4E2D\u641C\u7D22\u300CTerminal\u300D"})}let a=e.createDiv({cls:"install-step"});a.createEl("h3",{text:"\u6B65\u9AA4 2\uFF1A\u590D\u5236\u5E76\u7C98\u8D34\u547D\u4EE4"}),a.createEl("p",{text:"\u5728\u6253\u5F00\u7684\u7EC8\u7AEF\u7A97\u53E3\u4E2D\uFF0C\u7C98\u8D34\u4EE5\u4E0B\u547D\u4EE4\u5E76\u6309\u56DE\u8F66\u6267\u884C\uFF1A",cls:"setting-item-description"}),n?this.createCommandBlock(a,"winget install yt-dlp","\u63A8\u8350\u65B9\u5F0F - \u4F7F\u7528 Windows \u5305\u7BA1\u7406\u5668"):s?this.createCommandBlock(a,"brew install yt-dlp","\u63A8\u8350\u65B9\u5F0F - \u4F7F\u7528 Homebrew"):this.createCommandBlock(a,"pip install yt-dlp","\u63A8\u8350\u65B9\u5F0F - \u4F7F\u7528 Python pip");let o=a.createDiv({cls:"alt-method"});o.createEl("span",{text:"\u6216\u8005\u4F7F\u7528\uFF1A",cls:"alt-label"}),this.createCommandBlock(o,"pip install yt-dlp","\u901A\u7528\u65B9\u5F0F - \u9700\u8981\u5DF2\u5B89\u88C5 Python");let r=e.createDiv({cls:"install-step"});r.createEl("h3",{text:"\u6B65\u9AA4 3\uFF1A\u9A8C\u8BC1\u5B89\u88C5"}),r.createEl("p",{text:"\u5B89\u88C5\u5B8C\u6210\u540E\uFF0C\u5728\u7EC8\u7AEF\u4E2D\u8F93\u5165\u4EE5\u4E0B\u547D\u4EE4\u9A8C\u8BC1\u662F\u5426\u6210\u529F\uFF1A",cls:"setting-item-description"}),this.createCommandBlock(r,"yt-dlp --version","\u5E94\u663E\u793A\u7248\u672C\u53F7\uFF0C\u5982 2024.12.13");let l=e.createDiv({cls:"install-step"});l.createEl("h3",{text:"\u6B65\u9AA4 4\uFF1A\u91CD\u542F Obsidian"}),l.createEl("p",{text:"\u9A8C\u8BC1\u6210\u529F\u540E\uFF0C\u6309 Ctrl+R\uFF08Mac: Cmd+R\uFF09\u91CD\u65B0\u52A0\u8F7D Obsidian\uFF0C\u63D2\u4EF6\u5C06\u81EA\u52A8\u68C0\u6D4B yt-dlp\u3002",cls:"setting-item-description"});let d=e.createDiv({cls:"ytdlp-buttons"});d.createEl("button",{text:"\u{1F4D6} \u67E5\u770B\u5B98\u65B9\u6587\u6863",cls:"mod-cta"}).addEventListener("click",()=>{window.open("https://github.com/yt-dlp/yt-dlp#installation","_blank")}),d.createEl("button",{text:"\u23ED\uFE0F \u8DF3\u8FC7\uFF0C\u4E0D\u518D\u63D0\u793A"}).addEventListener("click",()=>{this.onDismiss(!0),this.close()}),d.createEl("button",{text:"\u6211\u7A0D\u540E\u5B89\u88C5"}).addEventListener("click",()=>{this.onDismiss(!1),this.close()}),this.addStyles()}createCommandBlock(e,n,s){let i=e.createDiv({cls:"command-block"}),a=i.createDiv({cls:"code-wrapper"});a.createEl("code",{text:n});let o=a.createEl("button",{text:"\u{1F4CB}",cls:"copy-btn"});o.setAttribute("title","\u590D\u5236\u547D\u4EE4"),o.addEventListener("click",async()=>{await navigator.clipboard.writeText(n),o.textContent="\u2705",setTimeout(()=>{o.textContent="\u{1F4CB}"},1500)}),i.createEl("span",{text:s,cls:"command-desc"})}addStyles(){if(document.getElementById("ytdlp-modal-styles"))return;let e=document.createElement("style");e.id="ytdlp-modal-styles",e.textContent=`
			.ytdlp-modal {
				max-width: 600px;
			}
			.install-step {
				margin: 16px 0;
				padding: 12px;
				background: var(--background-secondary);
				border-radius: 8px;
			}
			.install-step h3 {
				margin: 0 0 8px 0;
				color: var(--text-accent);
			}
			.terminal-guide ul {
				margin: 8px 0 0 20px;
				padding: 0;
			}
			.terminal-guide li {
				margin: 4px 0;
			}
			.command-block {
				display: flex;
				align-items: center;
				gap: 8px;
				margin: 8px 0;
				flex-wrap: wrap;
			}
			.code-wrapper {
				display: flex;
				align-items: center;
				background: var(--background-primary);
				border-radius: 4px;
				padding: 6px 10px;
				border: 1px solid var(--background-modifier-border);
			}
			.code-wrapper code {
				font-family: var(--font-monospace);
				font-size: 14px;
				color: var(--text-accent);
			}
			.copy-btn {
				margin-left: 8px;
				padding: 2px 6px;
				border: none;
				background: transparent;
				cursor: pointer;
				font-size: 14px;
			}
			.copy-btn:hover {
				background: var(--background-modifier-hover);
				border-radius: 4px;
			}
			.command-desc {
				color: var(--text-muted);
				font-size: 12px;
			}
			.alt-method {
				margin-top: 8px;
				padding-top: 8px;
				border-top: 1px dashed var(--background-modifier-border);
			}
			.alt-label {
				color: var(--text-muted);
				font-size: 12px;
				margin-right: 8px;
			}
			.ytdlp-buttons {
				display: flex;
				gap: 12px;
				margin-top: 20px;
				justify-content: flex-end;
			}
		`,document.head.appendChild(e)}onClose(){let{contentEl:e}=this;e.empty()}};
